---
title: 如何識別 MessageBox Database1 中的瓶頸 |Microsoft Docs
ms.custom: ''
ms.date: 06/08/2017
ms.prod: biztalk-server
ms.reviewer: ''
ms.suite: ''
ms.tgt_pltfrm: ''
ms.topic: article
ms.assetid: 1a039164-5ca6-4cbc-b307-c5d4ae800689
caps.latest.revision: 7
author: MandiOhlinger
ms.author: mandia
manager: anneta
ms.openlocfilehash: 55d766405716a63249eae8fd47fd1f82077e05d5
ms.sourcegitcommit: 266308ec5c6a9d8d80ff298ee6051b4843c5d626
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 06/27/2018
ms.locfileid: "37001111"
---
# <a name="how-to-identify-bottlenecks-in-the-messagebox-database"></a><span data-ttu-id="4b864-102">如何識別 MessageBox 資料庫中的瓶頸</span><span class="sxs-lookup"><span data-stu-id="4b864-102">How to Identify Bottlenecks in the MessageBox Database</span></span>
<span data-ttu-id="4b864-103">若要識別 MessageBox 資料庫中的瓶頸，請先確認 SQL Server Agent 服務已啟動。</span><span class="sxs-lookup"><span data-stu-id="4b864-103">To identify bottlenecks in the MessageBox database, first ensure that the SQL-Server-Agent Service is started.</span></span> <span data-ttu-id="4b864-104">變更服務的啟動狀態從 「 手動為 Auto 讓服務重新啟動伺服器時，會自動重新啟動。</span><span class="sxs-lookup"><span data-stu-id="4b864-104">Change the Service startup state from Manual to Auto so that if the server is restarted, the service will automatically restart.</span></span>  
  
 <span data-ttu-id="4b864-105">根據預設，BizTalk 服務將會節流處理，如果 Spool、 TrackingData 或 ApplicationQ 資料表成長。</span><span class="sxs-lookup"><span data-stu-id="4b864-105">By default, the BizTalk service will throttle if the Spool, TrackingData, or ApplicationQ tables grow.</span></span> <span data-ttu-id="4b864-106">這些資料表會剪除 SQL Agent 作業，其中，如果未執行，則會導致 Spool 成長，促使節流開始，並保護額外的壓力的資料庫。</span><span class="sxs-lookup"><span data-stu-id="4b864-106">These tables are pruned by SQL-Agent jobs, which, if not running will cause the Spool to grow causing throttling to start and protect the database from additional pressure.</span></span> <span data-ttu-id="4b864-107">請檢查下列效能計數器的狀態：</span><span class="sxs-lookup"><span data-stu-id="4b864-107">Check the status of the following performance counters:</span></span>  
  
- <span data-ttu-id="4b864-108">BizTalk: 訊息代理程式 (主控件名稱) 訊息傳遞節流狀態</span><span class="sxs-lookup"><span data-stu-id="4b864-108">BizTalk:Message Agent (Host Name) Message Delivery Throttling State</span></span>  
  
- <span data-ttu-id="4b864-109">BizTalk: 訊息代理程式 (主控件名稱) 訊息發佈節流狀態</span><span class="sxs-lookup"><span data-stu-id="4b864-109">BizTalk:Message Agent (Host Name) Message Publishing Throttling State</span></span>  
  
  <span data-ttu-id="4b864-110">值為"0"表示沒有發生節流。</span><span class="sxs-lookup"><span data-stu-id="4b864-110">A value of “0” indicates no throttling is occurring.</span></span> <span data-ttu-id="4b864-111">值為"6"表示系統由於資料庫成長而進行節流。</span><span class="sxs-lookup"><span data-stu-id="4b864-111">A value of “6” indicates the system is throttling due to database growth.</span></span> <span data-ttu-id="4b864-112">如需如何解譯這些計數器的值的詳細資訊，請參閱[何謂主控件節流？](http://go.microsoft.com/fwlink/?LinkID=154694)</span><span class="sxs-lookup"><span data-stu-id="4b864-112">For information about how to interpret the values of these counters, see [What is Host Throttling?](http://go.microsoft.com/fwlink/?LinkID=154694)</span></span> <span data-ttu-id="4b864-113">(http://go.microsoft.com/fwlink/?LinkID=154694)並[主控件節流效能計數器](http://go.microsoft.com/fwlink/?LinkID=155285)(http://go.microsoft.com/fwlink/?LinkID=155285) BizTalk Server 2010 文件中。</span><span class="sxs-lookup"><span data-stu-id="4b864-113">(http://go.microsoft.com/fwlink/?LinkID=154694) and [Host Throttling Performance Counters](http://go.microsoft.com/fwlink/?LinkID=155285) (http://go.microsoft.com/fwlink/?LinkID=155285) in the BizTalk Server 2010 documentation.</span></span>  
  
## <a name="spool-table-growth"></a><span data-ttu-id="4b864-114">多工緩衝處理資料表成長</span><span class="sxs-lookup"><span data-stu-id="4b864-114">Spool table growth</span></span>  
 <span data-ttu-id="4b864-115">Spool 會開始成長，可能有多種原因。</span><span class="sxs-lookup"><span data-stu-id="4b864-115">The Spool can start growing for multiple reasons.</span></span> <span data-ttu-id="4b864-116">多工緩衝處理成長的其中一個原因是應用程式佇列逐漸在成長。</span><span class="sxs-lookup"><span data-stu-id="4b864-116">One reason for Spool growth is if the Application Queues are growing.</span></span> <span data-ttu-id="4b864-117">它們可能會因為下游瓶頸及/或資源爭用等原因而成長。</span><span class="sxs-lookup"><span data-stu-id="4b864-117">They could grow due to reasons such as downstream bottlenecks and/or resource contention.</span></span>  
  
 <span data-ttu-id="4b864-118">如果應用程式佇列都很小，而 Spool 仍然很大，請確認清除工作會配合。</span><span class="sxs-lookup"><span data-stu-id="4b864-118">If the Application Queues are small and the Spool is still large, verify that the purge jobs are keeping up.</span></span> <span data-ttu-id="4b864-119">確定 SQL Agent 服務正在執行，再檢查下列工作是否順利完成：</span><span class="sxs-lookup"><span data-stu-id="4b864-119">Ensure that the SQL-Agent Service is running and then verify that the following jobs are successfully completing:</span></span>  
  
- <span data-ttu-id="4b864-120">MessageBox_Message_Cleanup_BizTalkMessageBoxDb</span><span class="sxs-lookup"><span data-stu-id="4b864-120">MessageBox_Message_Cleanup_BizTalkMessageBoxDb</span></span>  
  
- <span data-ttu-id="4b864-121">MessageBox_Parts_Cleanup_BizTalkMessageBoxDb</span><span class="sxs-lookup"><span data-stu-id="4b864-121">MessageBox_Parts_Cleanup_BizTalkMessageBoxDb</span></span>  
  
  <span data-ttu-id="4b864-122">如果 MessageZeroSum 資料表很大，則表示已處理的訊息。</span><span class="sxs-lookup"><span data-stu-id="4b864-122">If the MessageZeroSum table is large, it indicates that the messages have been processed.</span></span> <span data-ttu-id="4b864-123">這表示 DeQueue 已成功完成，並從應用程式佇列資料表中刪除資料和資料列已標示為待刪除。</span><span class="sxs-lookup"><span data-stu-id="4b864-123">This means that DeQueue has successfully completed and deleted data from the Application Queue tables and the rows have been flagged for deletion.</span></span> <span data-ttu-id="4b864-124">然而，清除工作無法趕上刪除資料的速度。</span><span class="sxs-lookup"><span data-stu-id="4b864-124">However, the purge jobs are unable to keep up with deleting the data.</span></span> <span data-ttu-id="4b864-125">如果執行 SQL Server 的電腦發生嚴重的 CPU 爭用情況，會影響的清除工作能夠跟上因 CPU 資源用盡，會發生這項目。</span><span class="sxs-lookup"><span data-stu-id="4b864-125">This can happen if the computer running SQL Server is experiencing severe CPU contention, affecting the ability of the purge jobs to keep up due to CPU starvation.</span></span>  
  
## <a name="application-queue-table-growth"></a><span data-ttu-id="4b864-126">應用程式佇列資料表成長</span><span class="sxs-lookup"><span data-stu-id="4b864-126">Application queue table growth</span></span>  
 <span data-ttu-id="4b864-127">應用程式佇列皆裝載途轉換資料，這些資料一經處理，會由 dequeue 加以清除。</span><span class="sxs-lookup"><span data-stu-id="4b864-127">Application Queues host in-flight transition data that, once processed, are cleaned up by DeQueue.</span></span>  
  
 <span data-ttu-id="4b864-128">處理這些訊息之後，就可以清除 Spool 資料表 （其中保存著這些資料列的參考）。</span><span class="sxs-lookup"><span data-stu-id="4b864-128">After these messages are processed, the Spool table (holding references to these rows) can be cleaned.</span></span>  
  
 <span data-ttu-id="4b864-129">例如，RxHostQ 將資料發行至協調流程 PxHostQ。</span><span class="sxs-lookup"><span data-stu-id="4b864-129">For example, the RxHostQ publishes data to the orchestration PxHostQ.</span></span> <span data-ttu-id="4b864-130">此佇列將資料發佈到傳送 txhostq，它們各自參考 Spool 資料表中的資料列。</span><span class="sxs-lookup"><span data-stu-id="4b864-130">This queue publishes data to the sending TxHostQ each referencing a row in the Spool table.</span></span> <span data-ttu-id="4b864-131">透過系統成功處理特定 HostQ 的訊息之後，DeQueue 會刪除這些資料列。</span><span class="sxs-lookup"><span data-stu-id="4b864-131">After the messages for a particular HostQ have successfully processed through the system, these rows are deleted by DeQueue.</span></span> <span data-ttu-id="4b864-132">在刪除這些資料列之後，清除工作便可以清除 Spool (不再由這些資料列參考)。</span><span class="sxs-lookup"><span data-stu-id="4b864-132">After these rows are deleted, the Spool (which is no longer referenced by these rows) can then be cleaned by the purge jobs.</span></span>  
  
 <span data-ttu-id="4b864-133">應用程式佇列成長，代表負責清空應用程式佇列的主控件執行個體都無法跟上內送的速率。</span><span class="sxs-lookup"><span data-stu-id="4b864-133">Application Queue growth indicates that the host instances responsible for draining the Application Queue are unable to keep up with the incoming rate.</span></span>  
  
 <span data-ttu-id="4b864-134">例如，因為負責處理協調流程的伺服器受限於 CPU 能力，無法處理得更快，所以協調流程應用程式佇列 (PxHostQ) 可能會成長。</span><span class="sxs-lookup"><span data-stu-id="4b864-134">For example, the orchestration application queue (PxHostQ) may grow because the server responsible for processing orchestrations is CPU bound and unable to process any faster.</span></span> <span data-ttu-id="4b864-135">不過，如果接收伺服器的速度快它可能會發行速度快過協調流程伺服器可以處理導致應用程式佇列成長。</span><span class="sxs-lookup"><span data-stu-id="4b864-135">However, if the receiving server is fast it may publish faster than what the orchestration server can process leading to the Application Queue growth.</span></span>  
  
 <span data-ttu-id="4b864-136">協調流程佇列成長的另一個原因可能是因為記憶體競爭的情況。</span><span class="sxs-lookup"><span data-stu-id="4b864-136">Another reason for orchestration queue growth could be due to memory contention.</span></span> <span data-ttu-id="4b864-137">當許多長時間執行的協調流程執行個體在記憶體中時，會同時具現化時，記憶體膨脹會間接導致節流縮小執行緒集區，直到記憶體壓力舒緩為止。</span><span class="sxs-lookup"><span data-stu-id="4b864-137">When many long running orchestration instances are concurrently instantiated in memory, memory bloat indirectly causes throttling to shrink the thread pool until memory pressure is relieved.</span></span>  
  
 <span data-ttu-id="4b864-138">為什麼要傳送的應用程式佇列可能會成長的原因是下游系統是否無法接收訊息 （從 BizTalk Server 連出） 的速度不夠快。</span><span class="sxs-lookup"><span data-stu-id="4b864-138">A reason why the send application queue may grow is if the downstream system is unable to receive messages (outgoing from BizTalk Server) fast enough.</span></span> <span data-ttu-id="4b864-139">因此訊息將會繼續位於 BizTalk 系統而造成應用程式佇列成長。</span><span class="sxs-lookup"><span data-stu-id="4b864-139">Thus the messages will continue to reside within the BizTalk system causing Application Queue growth.</span></span> <span data-ttu-id="4b864-140">這會促使節流開始運作並降低接收速率，從而影響系統的整體輸送量。</span><span class="sxs-lookup"><span data-stu-id="4b864-140">This can cause throttling to start and reduce the receiving rate impacting the overall throughput of the system.</span></span>  
  
## <a name="trackingdata-table-growth"></a><span data-ttu-id="4b864-141">TrackingData 資料表成長</span><span class="sxs-lookup"><span data-stu-id="4b864-141">TrackingData table growth</span></span>  
 <span data-ttu-id="4b864-142">MessageBox 資料庫中的 TrackingData 資料表是在其中攔截器撰寫健全狀況和活動 」 (HAT) 與商務活動監控 (BAM) 追蹤的追蹤資料的轉換資料表。</span><span class="sxs-lookup"><span data-stu-id="4b864-142">The TrackingData table in the MessageBox database is a transition table into which interceptors write tracking data for both Health and Activity (HAT) and Business Activity Monitoring (BAM) tracking.</span></span> <span data-ttu-id="4b864-143">如果停用了追蹤，這個資料表應該是空的。</span><span class="sxs-lookup"><span data-stu-id="4b864-143">If tracking is disabled, this table should be empty.</span></span> <span data-ttu-id="4b864-144">根據預設，HAT 追蹤已啟用管線和協調流程輸入/輸出事件。</span><span class="sxs-lookup"><span data-stu-id="4b864-144">By default, HAT-tracking is enabled for the pipelines and orchestrations In/Out events.</span></span>  
  
 <span data-ttu-id="4b864-145">如果已啟用訊息內文追蹤，請確定 MessageBox 資料庫伺服器 （也就是使用 「 允許主控件追蹤 」 的主機） 正在執行。</span><span class="sxs-lookup"><span data-stu-id="4b864-145">If Message Body Tracking is enabled, ensure that the MessageBox database server (that is, the host with "allow host tracking") is running.</span></span> <span data-ttu-id="4b864-146">確保 「 允許主控件追蹤 」 的主機正在執行，將會減少瓶頸發生，因為主應用程式將資料從 MessageBox 資料庫中的 TrackingData 資料表移到 BizTalk 追蹤資料庫資料表中的機會。</span><span class="sxs-lookup"><span data-stu-id="4b864-146">Ensuring that the host with "allow host tracking" is running will reduce the chance of a bottleneck occurring as the host moves data from TrackingData table in the MessageBox database to the BizTalk Tracking database tables.</span></span>  
  
 <span data-ttu-id="4b864-147">它可以追蹤自訂事件，例如啟用自訂 HAT 追蹤，在升級的屬性和訊息內文追蹤。</span><span class="sxs-lookup"><span data-stu-id="4b864-147">It is possible to track custom events by enabling custom HAT-tracking, for example, on promoted properties and message body tracking.</span></span> <span data-ttu-id="4b864-148">除了 HAT 追蹤資料、 BAM 資料也會寫入 TrackingData 資料表。</span><span class="sxs-lookup"><span data-stu-id="4b864-148">In addition to HAT-tracking data, BAM data is also written to the TrackingData table.</span></span> <span data-ttu-id="4b864-149">追蹤資料解碼服務 (TDDS、 啟用追蹤的主控件執行個體上執行) 會負責將這項資料從 MessageBox 資料庫移至 「 BizTalk 追蹤 」 及 「 BAM 主要匯入資料庫。</span><span class="sxs-lookup"><span data-stu-id="4b864-149">The Tracking Data Decode Service (TDDS, which runs on the host instance on which tracking is enabled) is responsible for moving this data from the MessageBox database to the BizTalk Tracking and BAM Primary Import databases.</span></span> <span data-ttu-id="4b864-150">然後資料成功移動之後，TDDS 將會刪除此資料。</span><span class="sxs-lookup"><span data-stu-id="4b864-150">Then after the data is successfully moved, TDDS deletes this data.</span></span> <span data-ttu-id="4b864-151">訊息內文追蹤資料是另外由 SQL 代理程式工作 TrackedMessages_Copy_BizTalkMsgBoxDb 來進行移動。</span><span class="sxs-lookup"><span data-stu-id="4b864-151">Message body tracking data is moved separately by a SQL-Agent job TrackedMessages_Copy_BizTalkMsgBoxDb.</span></span>  
  
 <span data-ttu-id="4b864-152">如果 TDDS 無法跟上的攔截器將資料寫入 TrackingData 資料表的速率，此資料表將會成長，促使節流開始。</span><span class="sxs-lookup"><span data-stu-id="4b864-152">If TDDS is unable to keep up with the rate at which the interceptors are writing data to the TrackingData table, this table will grow, causing throttling to start.</span></span> <span data-ttu-id="4b864-153">這會影響持續性輸送量。</span><span class="sxs-lookup"><span data-stu-id="4b864-153">This impacts sustainable throughput.</span></span> <span data-ttu-id="4b864-154">若要減少此問題，請確定至少一個主控件正在執行啟用追蹤。</span><span class="sxs-lookup"><span data-stu-id="4b864-154">To lessen this problem, ensure at least one host is running with tracking enabled.</span></span>  
  
 <span data-ttu-id="4b864-155">如果資料仍然會建立，請確定 BizTalk 追蹤資料庫未成長規模失控。</span><span class="sxs-lookup"><span data-stu-id="4b864-155">If the data still builds up, ensure the BizTalk Tracking database is not growing out of control.</span></span> <span data-ttu-id="4b864-156">此外，請確定封存和清除作業正在執行，而且能夠跟上資料到達的速率。</span><span class="sxs-lookup"><span data-stu-id="4b864-156">Also, ensure the archiving and purging job is running and is able to keep up with the rate at which data is arriving.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="4b864-157">根據預設，清除工作會無法從 BizTalk 追蹤資料庫資料表中刪除資料，直到這項資料已封存。</span><span class="sxs-lookup"><span data-stu-id="4b864-157">By default, the purge job is unable to delete data from the BizTalk Tracking database tables until this data has been archived.</span></span> <span data-ttu-id="4b864-158">如果您不需要封存的追蹤資料，您可以修改作業以清除 BizTalk 追蹤資料庫，而不進行封存所遵循的步驟[如何從 BizTalk 追蹤資料庫清除資料](http://go.microsoft.com/fwlink/?LinkID=153817)(http://go.microsoft.com/fwlink/?LinkID=153817)。</span><span class="sxs-lookup"><span data-stu-id="4b864-158">If you do not need to archive the tracking data, you can modify the job to purge the BizTalk Tracking database without archiving by following the steps at [How to Purge Data from the BizTalk Tracking Database](http://go.microsoft.com/fwlink/?LinkID=153817) (http://go.microsoft.com/fwlink/?LinkID=153817).</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="4b864-159">另請參閱</span><span class="sxs-lookup"><span data-stu-id="4b864-159">See Also</span></span>  
 [<span data-ttu-id="4b864-160">資料庫層中的瓶頸</span><span class="sxs-lookup"><span data-stu-id="4b864-160">Bottlenecks in the Database Tier</span></span>](../technical-guides/bottlenecks-in-the-database-tier.md)