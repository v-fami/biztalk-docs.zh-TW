---
title: "OrderBroker 協調流程中處理 |Microsoft 文件"
ms.custom: 
ms.date: 06/08/2017
ms.prod: biztalk-server
ms.reviewer: 
ms.suite: 
ms.tgt_pltfrm: 
ms.topic: article
helpviewer_keywords:
- orchestrations, examples
- orchestrations, nested scopes
- nested scopes, performance
- processing, examples
- nested scopes, orchestrations
- orchestrations, performance
- performance, orchestrations
- performance, nested scopes
- examples, orchestration processing [process management solution]
- scopes, nesting
ms.assetid: c296e00c-b3ad-4161-baf7-258899185c34
caps.latest.revision: "23"
author: MandiOhlinger
ms.author: mandia
manager: anneta
ms.openlocfilehash: 7c6a6571ece3190b6195b207b4c45969ce25ddec
ms.sourcegitcommit: cb908c540d8f1a692d01dc8f313e16cb4b4e696d
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 09/20/2017
---
# <a name="processing-in-the-orderbroker-orchestration"></a><span data-ttu-id="a8614-102">OrderBroker 協調流程中處理</span><span class="sxs-lookup"><span data-stu-id="a8614-102">Processing in the OrderBroker Orchestration</span></span>
<span data-ttu-id="a8614-103">本章節描述如何**OrderBroker**訂單的協調流程，並準備程序管理員。</span><span class="sxs-lookup"><span data-stu-id="a8614-103">This section describes how the **OrderBroker** orchestration takes orders and prepares them for a process manager.</span></span> <span data-ttu-id="a8614-104">這節的開始會討論協調流程的一般工作。</span><span class="sxs-lookup"><span data-stu-id="a8614-104">The section begins by discussing the general workings of the orchestration.</span></span> <span data-ttu-id="a8614-105">下一部分則會討論協調流程處理訊息的方法。</span><span class="sxs-lookup"><span data-stu-id="a8614-105">The next part discusses how the orchestration processes a message.</span></span> <span data-ttu-id="a8614-106">然後會著重在協調流程如何使用不可部分完成交易來改進效能。</span><span class="sxs-lookup"><span data-stu-id="a8614-106">It then highlights how the orchestration uses an atomic transaction to improve performance.</span></span>  
  
> [!NOTE]
>  <span data-ttu-id="a8614-107">由於長度的長度**OrderBroker**程式碼中，您可以閱讀此節與 Microsoft® Visual Studio 中開啟協調流程。</span><span class="sxs-lookup"><span data-stu-id="a8614-107">Because of the length of the length of the **OrderBroker** code, you may want to read this section with the orchestration open in Microsoft® Visual Studio.</span></span>  
  
## <a name="why-an-order-broker"></a><span data-ttu-id="a8614-108">為什麼要使用 Order Broker？</span><span class="sxs-lookup"><span data-stu-id="a8614-108">Why an Order Broker?</span></span>  
 <span data-ttu-id="a8614-109">目的**OrderBroker**協調流程是前置處理訂單，並將其路由至正確的處理序管理員。</span><span class="sxs-lookup"><span data-stu-id="a8614-109">The purpose of the **OrderBroker** orchestration is to preprocess an order and route it to the correct process manager.</span></span> <span data-ttu-id="a8614-110">這裡的預先處理包含為歷程資料庫及服務系統產生資訊訊息，並確認訂單的接收。</span><span class="sxs-lookup"><span data-stu-id="a8614-110">Pre-processing here consists of producing informational messages for the history database, for the servicing system, and to acknowledge receipt of the order.</span></span> <span data-ttu-id="a8614-111">**OrderBroker**也會從客戶服務要求的建立一般的訂單訊息。</span><span class="sxs-lookup"><span data-stu-id="a8614-111">The **OrderBroker** also creates a generic order message from the customer service request.</span></span> <span data-ttu-id="a8614-112">這樣的訂單標準化可讓商務程序元件，以一般的方式來使用訂單。</span><span class="sxs-lookup"><span data-stu-id="a8614-112">This normalization of the order allows for generic consumption of the order by elements of the business process.</span></span>  
  
 <span data-ttu-id="a8614-113">訂單訊息是一種多部分訊息，其中的路由資訊是與訂單資訊分開的。</span><span class="sxs-lookup"><span data-stu-id="a8614-113">The order message is a multipart message with routing information separated from the order information.</span></span> <span data-ttu-id="a8614-114">路由資訊也是一般性的資訊，設計來讓訂單管理員使用。</span><span class="sxs-lookup"><span data-stu-id="a8614-114">The routing information is also generic and designed to be consumed by any order manager.</span></span> <span data-ttu-id="a8614-115">這樣，便可輕易的擴充解決方案。</span><span class="sxs-lookup"><span data-stu-id="a8614-115">This, in turn, makes it easier to expand the solution.</span></span> <span data-ttu-id="a8614-116">多部分訊息的相關資訊，請參閱[如何使用多部分訊息類型](../core/how-to-use-multi-part-message-types.md)。</span><span class="sxs-lookup"><span data-stu-id="a8614-116">For information about multi-part messages, see [How to Use Multi-part Message Types](../core/how-to-use-multi-part-message-types.md).</span></span>  
  
 <span data-ttu-id="a8614-117">獨立出仲介的功能也可讓您將仲介功能移到其他 BizTalk 群組中。</span><span class="sxs-lookup"><span data-stu-id="a8614-117">Isolating the brokering function also allows you to move it to another BizTalk group.</span></span> <span data-ttu-id="a8614-118">因為**OrderBroker**發佈到 MessageBox 資料庫，也就是說，它是直接繫結，也可讓您更輕鬆將 broker 放在其他群組可以移動 broker 而不需要變更協調流程。</span><span class="sxs-lookup"><span data-stu-id="a8614-118">Because the **OrderBroker** publishes to the MessageBox database—that is, it is direct-bound—also makes it easier to put the broker in another group --you can move the broker without changing the orchestration.</span></span> <span data-ttu-id="a8614-119">如需有關放置**OrderBroker**在另一個群組中，請參閱[OrderBroker 與 OrderManager 之間的通訊](../core/communication-between-orderbroker-and-ordermanager.md)。</span><span class="sxs-lookup"><span data-stu-id="a8614-119">For more information about putting the **OrderBroker** in another group, see [Communication between OrderBroker and OrderManager](../core/communication-between-orderbroker-and-ordermanager.md).</span></span>  
  
> [!NOTE]
>  <span data-ttu-id="a8614-120">**OrderBroker**協調流程，因為只有一個**OrderManager**與通訊，只要將常數字串至**OrderMgrType**欄位的順序管理員訊息。</span><span class="sxs-lookup"><span data-stu-id="a8614-120">The **OrderBroker** orchestration, because it has only one **OrderManager** to communicate with, simply assigns a constant string to the **OrderMgrType** field in the order manager message.</span></span> <span data-ttu-id="a8614-121">一般來說，在具有多個訂單管理員的應用程式中，應用程式會使用商務規則引擎來判斷這個欄位及其他訂單路由的值。</span><span class="sxs-lookup"><span data-stu-id="a8614-121">Typically, in an application where there were multiple order managers, the application would use the Business Rule Engine to determine the proper value for this field and the order routing.</span></span> <span data-ttu-id="a8614-122">如需 「 商務規則引擎的詳細資訊，請參閱[建立和使用商務規則](../core/creating-and-using-business-rules.md)。</span><span class="sxs-lookup"><span data-stu-id="a8614-122">For more information about the Business Rule Engine, see [Creating and Using Business Rules](../core/creating-and-using-business-rules.md).</span></span>  
  
## <a name="order-processing"></a><span data-ttu-id="a8614-123">訂單處理</span><span class="sxs-lookup"><span data-stu-id="a8614-123">Order Processing</span></span>  
 <span data-ttu-id="a8614-124">**OrderBroker**具有兩個協調流程會開始**接收**圖形內**接聽**圖形。</span><span class="sxs-lookup"><span data-stu-id="a8614-124">The **OrderBroker** orchestration begins with two **Receive** shapes within a **Listen** shape.</span></span> <span data-ttu-id="a8614-125">一個**接收**圖形接受來自客戶支援; 系統訊息從廠商系統的其他訊息。</span><span class="sxs-lookup"><span data-stu-id="a8614-125">One **Receive** shape takes messages from the customer support system; the other, messages from the vendor system.</span></span> <span data-ttu-id="a8614-126">來自任一來源的訊息都有相同的結構描述。</span><span class="sxs-lookup"><span data-stu-id="a8614-126">Messages from either source have the same schema.</span></span>  
  
 <span data-ttu-id="a8614-127">協調流程會從訊息中擷取回覆地址，並使用它來設定動態連接埠，位址**CSRPort**。</span><span class="sxs-lookup"><span data-stu-id="a8614-127">The orchestration extracts the return address from the message and uses it to set the address for the dynamic port, **CSRPort**.</span></span> <span data-ttu-id="a8614-128">協調流程會使用這個連接埠來傳送確認及錯誤訊息。</span><span class="sxs-lookup"><span data-stu-id="a8614-128">The orchestration uses this port to send acknowledgement and error messages.</span></span>  
  
 <span data-ttu-id="a8614-129">接下來的步驟**OrderBroker**協調流程建立歷程訊息、 服務訊息、 確認訊息，以及訂單訊息傳送給**OrderManager**協調流程。</span><span class="sxs-lookup"><span data-stu-id="a8614-129">The next steps in the **OrderBroker** orchestration create the history message, the service message, the confirmation message, and the order message to send to the **OrderManager** orchestration.</span></span> <span data-ttu-id="a8614-130">協調流程使用**InsertOrderBody**公用程式函式，將訂單訊息新增至歷程記錄訊息。</span><span class="sxs-lookup"><span data-stu-id="a8614-130">The orchestration uses the **InsertOrderBody** utility function to add the order message to the history message.</span></span>  
  
> [!NOTE]
>  <span data-ttu-id="a8614-131">在某些狀況下，解決方案可能會產生傳送但沒有用的訊息。</span><span class="sxs-lookup"><span data-stu-id="a8614-131">In some situations the solution may produce messages that are delivered but not consumed.</span></span> <span data-ttu-id="a8614-132">Order Broker 協調流程會使用傳送埠將資訊插入歷程資料庫。</span><span class="sxs-lookup"><span data-stu-id="a8614-132">The order broker orchestration uses a send port to insert information in the history database.</span></span> <span data-ttu-id="a8614-133">這個傳送埠會使用傳遞通知。</span><span class="sxs-lookup"><span data-stu-id="a8614-133">This send port uses delivery notification.</span></span> <span data-ttu-id="a8614-134">組態會將傳送埠對應到包含兩個連接埠的傳送埠群組，有一個測試組態的連接埠 (**HISTORYINSERT-SP-測試**)，另一個用於一般組態 (**HISTORYINSERT-SP**)。</span><span class="sxs-lookup"><span data-stu-id="a8614-134">Configuration maps the send port to a send port group containing two ports—one port for the test configuration (**HistoryInsert-Test-SP**), one for the regular configuration (**HistoryInsert-SP**).</span></span> <span data-ttu-id="a8614-135">若您讓群組中兩個連接埠同時執行，解決方案會在兩個連接埠上都傳送訊息。</span><span class="sxs-lookup"><span data-stu-id="a8614-135">If you leave both ports in the group running, the solution sends messages on both ports.</span></span> <span data-ttu-id="a8614-136">因此它會要求兩個傳遞通知，但只會處理其中一個。</span><span class="sxs-lookup"><span data-stu-id="a8614-136">It thus requests two delivery notifications but processes only one.</span></span>  
>   
>  <span data-ttu-id="a8614-137">若要避免這種情況下，取消登錄測試連接埠 (**測試-HISTORYINSERT-SP**)，或停止應用程式測試版本**BTSScn.BPM.OrderBrokerApp.Test**。</span><span class="sxs-lookup"><span data-stu-id="a8614-137">To avoid this situation, unenlist the test port (**HistoryInsert-Test-SP**), or stop the test version of the application, **BTSScn.BPM.OrderBrokerApp.Test**.</span></span> <span data-ttu-id="a8614-138">如需傳遞通知的詳細資訊，請參閱[使用通知](../core/using-acknowledgments.md)。</span><span class="sxs-lookup"><span data-stu-id="a8614-138">For more information about delivery notifications, see [Using Acknowledgments](../core/using-acknowledgments.md).</span></span>  
  
 <span data-ttu-id="a8614-139">建構要傳送到訊息時**OrderManager**協調流程， **OrderBroker**協調流程會使用兩個部分建立多部分訊息。</span><span class="sxs-lookup"><span data-stu-id="a8614-139">When constructing the message to send to the **OrderManager** orchestration, the **OrderBroker** orchestration creates a multi-part message with two parts.</span></span> <span data-ttu-id="a8614-140">一個部分包含路由資訊；另一個部分包含訂單本身。</span><span class="sxs-lookup"><span data-stu-id="a8614-140">One part contains the routing information; the other, the order itself.</span></span> <span data-ttu-id="a8614-141">訊息的路由部分**OrderMgrMsg.Routing**，使用 C# 類別中所定義的結構描述**SchemaClasses**組件。</span><span class="sxs-lookup"><span data-stu-id="a8614-141">The routing part of the message, **OrderMgrMsg.Routing**, uses a schema defined by a C# class in the **SchemaClasses** assembly.</span></span> <span data-ttu-id="a8614-142">Broker 會將訂單部分當成是一般的訊息或類型不可知的 XML 文件 (**System.Xml.XmlDocument**) 並將其指派給**OrderMgrMsg.Order**。</span><span class="sxs-lookup"><span data-stu-id="a8614-142">The broker treats the order part of the message as a generic, or type-agnostic, XML document (**System.Xml.XmlDocument**) and assigns it to **OrderMgrMsg.Order**.</span></span>  
  
 <span data-ttu-id="a8614-143">有兩個路由資訊中的欄位對訂單管理員來說特別重要**OrderMgrMsg.Routing.OrderMgrType**和**OrderMgrMsg.Routing.Status**。</span><span class="sxs-lookup"><span data-stu-id="a8614-143">There are two fields in the routing information that are especially important to the order manager, **OrderMgrMsg.Routing.OrderMgrType** and **OrderMgrMsg.Routing.Status**.</span></span> <span data-ttu-id="a8614-144">Broker 集**OrderMgrType**是以處理訂單的訂單管理員類型。</span><span class="sxs-lookup"><span data-stu-id="a8614-144">The broker sets the **OrderMgrType** to the type of the order manager that is to handle the order.</span></span> <span data-ttu-id="a8614-145">在解決方案中，只有一個訂單管理員，而欄位則設定為 CABLEORDER。</span><span class="sxs-lookup"><span data-stu-id="a8614-145">In the solution, there is only one order manager and the field is set to CABLEORDER.</span></span> <span data-ttu-id="a8614-146">Broker 也會設定**狀態**欄位設為 接受。</span><span class="sxs-lookup"><span data-stu-id="a8614-146">The broker also sets the **Status** field to ACCEPTED.</span></span> <span data-ttu-id="a8614-147">這個值會告訴訂單管理員，該訊息為新的訂單。</span><span class="sxs-lookup"><span data-stu-id="a8614-147">This is the value that tells the order manager the message is a new order.</span></span> <span data-ttu-id="a8614-148">在方案中，訂單管理員**OrderManager**協調流程，會使用**接收**篩選出訂單類型等於 CABLEORDER 而狀態等於 ACCEPTED 的圖形。</span><span class="sxs-lookup"><span data-stu-id="a8614-148">The order manager in the solution, **OrderManager** orchestration, uses a **Receive** shape that filters for the order type equal to CABLEORDER and status equal to ACCEPTED.</span></span>  
  
 <span data-ttu-id="a8614-149">中的其餘步驟**OrderBroker**協調流程會將不同的訊息傳送至適當的連接埠。</span><span class="sxs-lookup"><span data-stu-id="a8614-149">The remaining steps in the **OrderBroker** orchestration send the different messages to the appropriate ports.</span></span>  
  
## <a name="improving-performance-with-nested-scopes"></a><span data-ttu-id="a8614-150">使用巢狀範圍改善效能</span><span class="sxs-lookup"><span data-stu-id="a8614-150">Improving Performance with Nested Scopes</span></span>  
 <span data-ttu-id="a8614-151">其中一個值得注意的重點有關**OrderBroker**協調流程是它使用巢狀範圍。</span><span class="sxs-lookup"><span data-stu-id="a8614-151">One of the noticeable things about the **OrderBroker** orchestration is its use of nested scopes.</span></span> <span data-ttu-id="a8614-152">這裡的巢狀範圍可限制持續點，因此可改善效能。</span><span class="sxs-lookup"><span data-stu-id="a8614-152">The nested scopes are there, in part, to improve performance by limiting the persistence points.</span></span>  
  
 <span data-ttu-id="a8614-153">協調流程引擎會在稱為持續點的執行點間，定期地儲存整個協調流程的狀態。</span><span class="sxs-lookup"><span data-stu-id="a8614-153">The orchestration engine periodically saves the state of the entire orchestration at execution points called persistence points.</span></span> <span data-ttu-id="a8614-154">協調流程引擎會自動將數個協調流程圖形，包括**傳送**圖形，視為持續點。</span><span class="sxs-lookup"><span data-stu-id="a8614-154">The orchestration engine automatically treats several orchestration shapes, including **Send** shapes, as persistence points.</span></span> <span data-ttu-id="a8614-155">如需持續點的詳細資訊，請參閱[持續性和協調流程引擎](../core/persistence-and-the-orchestration-engine.md)。</span><span class="sxs-lookup"><span data-stu-id="a8614-155">For a list of persistence points and more information about them, see [Persistence and the Orchestration Engine](../core/persistence-and-the-orchestration-engine.md).</span></span>  
  
 <span data-ttu-id="a8614-156">具有五個**傳送**圖形， **OrderBroker**協調流程應該有五個持續點。</span><span class="sxs-lookup"><span data-stu-id="a8614-156">With five **Send** shapes, the **OrderBroker** orchestration should have five persistence points.</span></span> <span data-ttu-id="a8614-157">不過，當您分組**傳送**不可部分完成交易範圍內的圖形，引擎會認為它只需要一個持續點的範圍。</span><span class="sxs-lookup"><span data-stu-id="a8614-157">However, when you group **Send** shapes inside an atomic transaction scope, the engine recognizes it only needs one persistence point for the scope.</span></span> <span data-ttu-id="a8614-158">因為四個**傳送**圖形中**OrderBroker**協調流程並不屬於例外狀況處理常式和傳送之後，才能執行，不需要所以他們可以進入不可部分完成交易範圍。</span><span class="sxs-lookup"><span data-stu-id="a8614-158">Because four of the **Send** shapes in **OrderBroker** orchestration are not part of exception handlers and nothing needs to be done after the send, they can go in an atomic transaction scope.</span></span> <span data-ttu-id="a8614-159">這樣可減少持續點的數目。</span><span class="sxs-lookup"><span data-stu-id="a8614-159">This reduces the number of persistence points.</span></span> <span data-ttu-id="a8614-160">如需不可部分完成交易的詳細資訊，請參閱[不可部分完成交易](../core/atomic-transactions.md)。</span><span class="sxs-lookup"><span data-stu-id="a8614-160">For more information about atomic transactions, see [Atomic Transactions](../core/atomic-transactions.md).</span></span>  
  
 <span data-ttu-id="a8614-161">此外，若交易會在同時結束，協調流程引擎會使用單一個持續點來進行巢狀交易。</span><span class="sxs-lookup"><span data-stu-id="a8614-161">In addition, the orchestration engine will use a single persistence point for nested transactions if the transactions all end at the same time.</span></span> <span data-ttu-id="a8614-162">因此，方式**OrderBroker**協調流程巢狀放置於交易進一步減少持續點： 協調流程有單一個持續點，因為使用**範圍**圖形。</span><span class="sxs-lookup"><span data-stu-id="a8614-162">Thus, the way **OrderBroker** orchestration nests transactions further reduces the persistence points: the orchestration has a single persistence point due to the use of **Scope** shapes.</span></span>  
  
> [!TIP]
>  <span data-ttu-id="a8614-163">您可將協調流程中持續點的數目降到最低，來改進效能。</span><span class="sxs-lookup"><span data-stu-id="a8614-163">You can improve performance by minimizing the number of persistence points in an orchestration.</span></span> <span data-ttu-id="a8614-164">您可以將群組**傳送**圖形的不可部分完成的交易，以產生單一個持續點的所有**傳送**圖形。</span><span class="sxs-lookup"><span data-stu-id="a8614-164">You can group **Send** shapes in an atomic transaction to produce a single persistence point for all of the **Send** shapes.</span></span> <span data-ttu-id="a8614-165">在同時結束巢狀交易會產生交易的單一個持續點。</span><span class="sxs-lookup"><span data-stu-id="a8614-165">Ending nested transaction scopes at the same time produces a single persistence point for the transactions.</span></span>  
  
 <span data-ttu-id="a8614-166">不可部分完成交易範圍無法擁有例外狀況處理常式。</span><span class="sxs-lookup"><span data-stu-id="a8614-166">An atomic transaction scope cannot have an exception handler.</span></span> <span data-ttu-id="a8614-167">因此，協調流程會將不可部分完成範圍巢狀嵌入長時間執行的交易內。</span><span class="sxs-lookup"><span data-stu-id="a8614-167">Because of this, the orchestration nests the atomic scope inside a long running transaction.</span></span> <span data-ttu-id="a8614-168">這個外部的交易可能例外狀況處理常式，而且它是這個處理常式來處理從例外狀況**傳送**圖形。</span><span class="sxs-lookup"><span data-stu-id="a8614-168">This outer transaction can have an exception handler and it is this handler that processes an exception from the **Send** shapes.</span></span>  
  
> [!TIP]
>  <span data-ttu-id="a8614-169">將不可部分完成交易巢狀嵌入長時間執行的交易中，是一種允許例外狀況處理的常見模式。</span><span class="sxs-lookup"><span data-stu-id="a8614-169">Nesting an atomic transaction inside a long running transaction is a common pattern to allow for exception handling.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="a8614-170">另請參閱</span><span class="sxs-lookup"><span data-stu-id="a8614-170">See Also</span></span>  
 <span data-ttu-id="a8614-171">[商務程序管理解決方案中的處理](../core/processing-in-the-business-process-management-solution.md) </span><span class="sxs-lookup"><span data-stu-id="a8614-171">[Processing in the Business Process Management Solution](../core/processing-in-the-business-process-management-solution.md) </span></span>  
 <span data-ttu-id="a8614-172">[程序管理員邏輯](../core/process-manager-logic.md) </span><span class="sxs-lookup"><span data-stu-id="a8614-172">[Process Manager Logic](../core/process-manager-logic.md) </span></span>  
 <span data-ttu-id="a8614-173">[中斷商務程序管理解決方案中的處理](../core/interrupt-handling-in-the-business-process-management-solution.md) </span><span class="sxs-lookup"><span data-stu-id="a8614-173">[Interrupt Handling in the Business Process Management Solution](../core/interrupt-handling-in-the-business-process-management-solution.md) </span></span>  
 [<span data-ttu-id="a8614-174">ExceptionHandler 協調流程</span><span class="sxs-lookup"><span data-stu-id="a8614-174">The ExceptionHandler Orchestration</span></span>](../core/the-exceptionhandler-orchestration.md)