---
title: BizTalk Server 如何處理大型訊息 |Microsoft Docs
ms.custom: ''
ms.date: 06/08/2017
ms.prod: biztalk-server
ms.reviewer: ''
ms.suite: ''
ms.tgt_pltfrm: ''
ms.topic: article
ms.assetid: 62c070be-dff5-4349-9e36-dd3a7caf1752
caps.latest.revision: 33
author: MandiOhlinger
ms.author: mandia
manager: anneta
ms.openlocfilehash: f17509983e7eab7b8743c8036c429c886b0b9265
ms.sourcegitcommit: 266308ec5c6a9d8d80ff298ee6051b4843c5d626
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 06/27/2018
ms.locfileid: "37016525"
---
# <a name="how-biztalk-server-processes-large-messages"></a><span data-ttu-id="b9954-102">BizTalk Server 如何處理大型訊息</span><span class="sxs-lookup"><span data-stu-id="b9954-102">How BizTalk Server Processes Large Messages</span></span>
## <a name="what-is-a-large-message"></a><span data-ttu-id="b9954-103">何謂大型訊息？</span><span class="sxs-lookup"><span data-stu-id="b9954-103">What is a large message?</span></span>  
 <span data-ttu-id="b9954-104">可惜這個問題的答案並不直接受限於特定訊息大小，反而取決於 Microsoft [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)] 系統中的特定瓶頸而定。</span><span class="sxs-lookup"><span data-stu-id="b9954-104">Unfortunately, the answer to this question isn't tied directly to a specific message size, but rather, depends on specific bottlenecks in your Microsoft [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)] system.</span></span> <span data-ttu-id="b9954-105">與大型訊息相關的問題可分為下列類別：</span><span class="sxs-lookup"><span data-stu-id="b9954-105">The problems associated with large messages can be divided into the following categories:</span></span>  
  
-   <span data-ttu-id="b9954-106">**記憶體不足錯誤**特定類型的訊息處理，例如對應、 驗證和屬性升級-會將整個訊息載入記憶體。</span><span class="sxs-lookup"><span data-stu-id="b9954-106">**Out of memory errors** Certain types of message processing - such as mapping, validation, and property promotion - load the entire message into memory.</span></span> <span data-ttu-id="b9954-107">若記憶體中的訊息大小超過可用資源，則會發生記憶體不足錯誤。</span><span class="sxs-lookup"><span data-stu-id="b9954-107">If the size of the message in memory exceeds available resources, then an out of memory error occurs.</span></span> <span data-ttu-id="b9954-108">屬於此類型的訊息之大小閾值遠低於未載入記憶體的訊息之大小閾值。</span><span class="sxs-lookup"><span data-stu-id="b9954-108">The size threshold for messages that fall into this category is much lower than the size threshold for messages that are not loaded into memory.</span></span> <span data-ttu-id="b9954-109">例如，一個 10 MB 的一般檔案剖析為 XML 並對應後，可能會成長 10 倍或更多，而耗用超過 100 MB 的記憶體，但是一個未剖析或對應的 100 MB 的 XML 文件事實上可能僅耗用 1 MB 的記憶體，因為它會串流至 MessageBox 資料庫。</span><span class="sxs-lookup"><span data-stu-id="b9954-109">For example, a 10 MB flat file that is parsed into XML and then mapped may grow by a factor of 10 or more to consume over 100 MB of memory, whereas a 100 MB XML document that is not parsed or mapped may actually only consume 1 MB of memory as it is streamed to the MessageBox database.</span></span>  
  
-   <span data-ttu-id="b9954-110">**未載入記憶體的訊息的效能問題**不一定要載入到記憶體的訊息串流至 MessageBox 資料庫，使用.NET XmlReader 介面。</span><span class="sxs-lookup"><span data-stu-id="b9954-110">**Performance problems for messages that are not loaded into memory** Messages that are not required to be loaded into memory are streamed to the MessageBox database using the .NET XmlReader interface.</span></span> <span data-ttu-id="b9954-111">雖然它們未受到必須載入記憶體的訊息之大小限制，但是有一些重要因素會影響 BizTalk Server 處理串流至 MessageBox 資料庫之資料的方式。</span><span class="sxs-lookup"><span data-stu-id="b9954-111">While they are not subject to the size limitations on messages that must be loaded into memory, there are some important factors that impact how BizTalk Server processes messages that are streamed to the MessageBox database.</span></span>  
  
## <a name="factors-that-affect-the-processing-of-large-messages"></a><span data-ttu-id="b9954-112">影響大型訊息處理的因素</span><span class="sxs-lookup"><span data-stu-id="b9954-112">Factors that affect the processing of large messages</span></span>  
 <span data-ttu-id="b9954-113">原始訊息大小、訊息格式以及訊息處理類型都會影響 BizTalk Server 處理大型訊息的方式。</span><span class="sxs-lookup"><span data-stu-id="b9954-113">The original message size, message format, and type of message processing all affect how BizTalk Server processes large messages.</span></span>  
  
- <span data-ttu-id="b9954-114">**原始訊息大小**BizTalk Server 所接收之訊息的大小是最明顯的大訊息時，會由 BizTalk Server 處理指示。</span><span class="sxs-lookup"><span data-stu-id="b9954-114">**Original message size** The size of the message received by BizTalk Server is the most visible indication of how large the message will be when it is processed by BizTalk Server.</span></span> <span data-ttu-id="b9954-115">在整個訊息均載入記憶體時，訊息的原始大小對效能的影響遠大於在訊息串流至 MessageBox 資料庫時其對效能的影響。</span><span class="sxs-lookup"><span data-stu-id="b9954-115">The original size of a message has a much greater impact on performance if the entire message is loaded into memory than if the message is streamed to the MessageBox database.</span></span>  
  
- <span data-ttu-id="b9954-116">**訊息格式**到 BizTalk Server 中有兩種主要格式接收訊息： XML 檔或一般檔案。</span><span class="sxs-lookup"><span data-stu-id="b9954-116">**Message format** Messages are received into BizTalk Server in one of two primary formats: XML files or flat files.</span></span>  
  
  -   <span data-ttu-id="b9954-117">**XML 檔案**為了讓 BizTalk Server 可以執行任何處理不透過路由傳遞訊息，訊息必須是 XML 檔案格式。</span><span class="sxs-lookup"><span data-stu-id="b9954-117">**XML files** In order for BizTalk Server to perform any processing on a message other than pass through routing, the message must be in the XML file format.</span></span> <span data-ttu-id="b9954-118">若要處理的檔案以 XML 格式接收，則大部分會保留原始大小。</span><span class="sxs-lookup"><span data-stu-id="b9954-118">If the files to be processed are received in XML format then they will retain their original size for the most part.</span></span>  
  
  -   <span data-ttu-id="b9954-119">**一般檔案**一般檔案必須先剖析為 XML 格式，BizTalk Server 才能執行處理而不透過路由傳遞。</span><span class="sxs-lookup"><span data-stu-id="b9954-119">**Flat files** Flat files must be parsed into an XML format before BizTalk Server can perform any processing other than pass through routing.</span></span> <span data-ttu-id="b9954-120">將一般檔案剖析為 XML 檔案會大幅增加檔案大小。</span><span class="sxs-lookup"><span data-stu-id="b9954-120">Parsing a flat file into an XML file can greatly increase the size of the file.</span></span> <span data-ttu-id="b9954-121">一般檔案不包含 XML 標記及其資料的描述性資訊。</span><span class="sxs-lookup"><span data-stu-id="b9954-121">Flat files do not contain XML tags with descriptive information about their data.</span></span> <span data-ttu-id="b9954-122">XML 檔案，相反地，可包裝其所有資料具描述性的 XML 標記。</span><span class="sxs-lookup"><span data-stu-id="b9954-122">XML files, on the other hand, wrap all of their data in descriptive XML tags.</span></span> <span data-ttu-id="b9954-123">在部分實例中，剖析會使一般檔案的大小增加 10 倍或更多，視該檔案的 XML 標記中包含的描述性資料多寡而定。</span><span class="sxs-lookup"><span data-stu-id="b9954-123">In some scenarios parsing can increase the size of a flat file by a factor of 10 or more, depending on how much descriptive data is contained in the XML tags for the file.</span></span>  
  
  -   <span data-ttu-id="b9954-124">**一般檔案文件包裝在 XML 文件中單一 CDATA 區段節點**這種類型的文件是 XML 和一般檔案的組合，可能會造成問題，因為 BizTalk Server 必須將整個包裝的一般檔案文件載入前的記憶體正在處理它。</span><span class="sxs-lookup"><span data-stu-id="b9954-124">**Flat file documents wrapped in a single CDATA section node in an XML document** This type of document is a combination of both XML and flat file and can be problematic because BizTalk Server must load the entire wrapped flat file document into memory before processing it.</span></span>  
  
- <span data-ttu-id="b9954-125">**訊息處理的類型**在 BizTalk Server 中，有兩種訊息處理類型： 僅路由以及對應。</span><span class="sxs-lookup"><span data-stu-id="b9954-125">**Type of message processing** In BizTalk Server, there are two types of message processing: Routing only and Mapping.</span></span> <span data-ttu-id="b9954-126">繫結至執行的訊息處理類型之效能變數是訊息大小以及訊息是否載入記憶體。</span><span class="sxs-lookup"><span data-stu-id="b9954-126">The performance variables tied to the type of message processing that is performed are message size and whether the message is loaded into memory.</span></span>  
  
  - <span data-ttu-id="b9954-127">**僅路由**若 BizTalk Server 僅用於升級的訊息屬性為基礎的路由傳送訊息，然後將訊息串流至 Messagebox 資料庫，使用.NET XmlReader 介面，而且訊息部分不個別載入記憶體。</span><span class="sxs-lookup"><span data-stu-id="b9954-127">**Routing only** If BizTalk Server is only used only for routing messages based upon promoted message properties, then the message is streamed into the Messagebox database using the .NET XmlReader interface, and message parts are not individually loaded into memory.</span></span> <span data-ttu-id="b9954-128">在此案例中，記憶體不足錯誤將不是問題，而主要的考量是將非常大型的訊息 (超過 100 MB) 寫入 MessageBox 資料庫所需的時間量。</span><span class="sxs-lookup"><span data-stu-id="b9954-128">In this scenario, out of memory errors are not an issue and the primary consideration is the amount of time that is required to write very large messages (over 100 MB) into the Messagebox database.</span></span> <span data-ttu-id="b9954-129">BizTalk Server 開發團隊已成功測試，在僅執行路由時處理高達 1 GB 大小的訊息。</span><span class="sxs-lookup"><span data-stu-id="b9954-129">The BizTalk Server development team has successfully tested the processing of messages up to 1 GB in size when performing routing only.</span></span>  
  
     <span data-ttu-id="b9954-130">決定在此案例中的效能的主要因素是**大型訊息分割大小**用來分割資料至資料庫。</span><span class="sxs-lookup"><span data-stu-id="b9954-130">The primary factor that determines performance in this scenario is the **Large message fragment size** used to fragment the data into the database.</span></span> <span data-ttu-id="b9954-131">**大型訊息分割大小**可設定的選項位於**BizTalk 群組屬性**組態 頁面上，預設值為 102400 位元組 (100 KB)。</span><span class="sxs-lookup"><span data-stu-id="b9954-131">The **Large message fragment size** is a configurable option on the **BizTalk Group Properties** configuration page and has a default value of 102400 bytes (100 KB).</span></span> <span data-ttu-id="b9954-132">增加此值會降低將訊息串流至 MessageBox 資料庫所需的往返次數。</span><span class="sxs-lookup"><span data-stu-id="b9954-132">Increasing this value reduces the number of round trips required to stream a message into the MessageBox database.</span></span>  
  
  - <span data-ttu-id="b9954-133">**對應**轉換對應文件可以是需要大量記憶體的作業。</span><span class="sxs-lookup"><span data-stu-id="b9954-133">**Mapping** Transforming a document with a map can be a memory-intensive operation.</span></span> <span data-ttu-id="b9954-134">當文件以對應轉換時，BizTalk Server 會將訊息傳遞至.Net XSLCompileTransform 類別，它會載入 XSL 樣式表。</span><span class="sxs-lookup"><span data-stu-id="b9954-134">When a document is transformed by a map, BizTalk Server passes the message to the .Net XSLCompileTransform class, which loads the XSL style sheet.</span></span> <span data-ttu-id="b9954-135">Load 方法順利完成之後，轉換方法可以是從多個執行緒同時呼叫。</span><span class="sxs-lookup"><span data-stu-id="b9954-135">After the Load method completes successfully, the Transform method can be called simultaneously from multiple threads.</span></span> <span data-ttu-id="b9954-136">[XslCompiledTransform 類別](http://go.microsoft.com/fwlink/p/?LinkID=282683)XSLCompiledTransform 類別提供的詳細資訊。</span><span class="sxs-lookup"><span data-stu-id="b9954-136">[XslCompiledTransform Class](http://go.microsoft.com/fwlink/p/?LinkID=282683) provides more information on the XSLCompiledTransform class.</span></span>  
  
     [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)]<span data-ttu-id="b9954-137"> 藉由實作可設定的訊息大小閾值，供轉換期間將文件載入記憶體，以大幅改善大型文件的記憶體管理。</span><span class="sxs-lookup"><span data-stu-id="b9954-137"> significantly improves memory management for large documents by implementing a configurable message size threshold for loading documents into memory during transforms.</span></span> <span data-ttu-id="b9954-138">大小低於此閾值的任何訊息都會在記憶體中處理，而大小大於此閾值的任何訊息則會緩衝至檔案系統，以降低記憶體需求。</span><span class="sxs-lookup"><span data-stu-id="b9954-138">Any message with a size below this threshold is handled in memory; any message with a size above this threshold is buffered to the file system to reduce memory requirements.</span></span> <span data-ttu-id="b9954-139">預設訊息大小閾值是 1 MB。</span><span class="sxs-lookup"><span data-stu-id="b9954-139">The default message size threshold is 1 MB.</span></span>  
  
## <a name="guidelines-for-processing-large-messages"></a><span data-ttu-id="b9954-140">處理大型訊息的指導方針</span><span class="sxs-lookup"><span data-stu-id="b9954-140">Guidelines for processing large messages</span></span>  
 <span data-ttu-id="b9954-141">請遵循這些指導方針，以改善在 BizTalk Server 中處理大型訊息的效能：</span><span class="sxs-lookup"><span data-stu-id="b9954-141">Follow these guidelines to improve performance when processing large messages in BizTalk Server:</span></span>  
  
1. <span data-ttu-id="b9954-142">調整訊息大小閾值，若在對應期間超過此閾值，則將文件緩衝至檔案系統。</span><span class="sxs-lookup"><span data-stu-id="b9954-142">Adjust the message size threshold above which documents are buffered to the file system during mapping.</span></span> <span data-ttu-id="b9954-143">若要修改大小閾值，建立名為 DWORD 值**TransformThreshold**在 BizTalk Server 登錄的下列位置：</span><span class="sxs-lookup"><span data-stu-id="b9954-143">To modify the size threshold, create a DWORD value named **TransformThreshold** at the following location in the BizTalk Server registry:</span></span>  
  
   ```  
   HKLM\Software\Microsoft\BizTalk Server\3.0\Administration\TransformThreshold  
   ```  
  
    <span data-ttu-id="b9954-144">建立此值之後，輸入十進位值的位元組數目，以設定新的閾值。</span><span class="sxs-lookup"><span data-stu-id="b9954-144">After you have created this value, enter a decimal value with the number of bytes to set the new threshold to.</span></span> <span data-ttu-id="b9954-145">例如，輸入十進位值 2097152，以增加訊息大小閾值至 2 MB (從預設的 1 MB)。</span><span class="sxs-lookup"><span data-stu-id="b9954-145">For example, enter a decimal value of 2097152 to increase the message size threshold to 2 MB (from the default of 1 MB).</span></span> <span data-ttu-id="b9954-146">以大量可用的記憶體增加系統上的此值來改善輸送量。</span><span class="sxs-lookup"><span data-stu-id="b9954-146">Increase this value on systems with a large amount of available memory to improve throughput.</span></span> <span data-ttu-id="b9954-147">將文件緩衝至磁碟機，以耗用整體輸送量成本的方式來節省記憶體。</span><span class="sxs-lookup"><span data-stu-id="b9954-147">Buffering documents to disk conserves memory at a cost to overall throughput.</span></span>  
  
   > [!NOTE]
   >  <span data-ttu-id="b9954-148">根據預設，對應期間緩衝至檔案系統的文件會寫入 *%temp%* BizTalk Server 電腦的目錄。</span><span class="sxs-lookup"><span data-stu-id="b9954-148">By default, documents that are buffered to the file system during mapping are written to the *%temp%* directory of the BizTalk Server computer.</span></span> <span data-ttu-id="b9954-149">變更的設定 *%temp%* 非系統磁碟機，以改善效能，對應期間緩衝至檔案系統的大型訊息的環境變數。</span><span class="sxs-lookup"><span data-stu-id="b9954-149">Change the setting for the *%temp%* environment variable to a non-system disk to improve performance when buffering large messages to the file system during mapping.</span></span>  
  
2. <span data-ttu-id="b9954-150">讓協調流程中使用的對應最小化：</span><span class="sxs-lookup"><span data-stu-id="b9954-150">Minimize the use of maps in orchestrations:</span></span>  
  
   -   <span data-ttu-id="b9954-151">若您在協調流程中使用對應擷取或設定與商務邏輯搭配使用的屬性，請改以辨別欄位或升級屬性取代。</span><span class="sxs-lookup"><span data-stu-id="b9954-151">If you are using a map to extract or set properties used with business logic in an orchestration, use distinguished fields or promoted properties instead.</span></span> <span data-ttu-id="b9954-152">使用對應擷取或設定值時，文件會載入記憶體。</span><span class="sxs-lookup"><span data-stu-id="b9954-152">When extracting or setting values with a map the document is loaded into memory.</span></span> <span data-ttu-id="b9954-153">使用辨別欄位或升級屬性時，協調流程引擎會存取訊息內文而不會將文件載入記憶體。</span><span class="sxs-lookup"><span data-stu-id="b9954-153">When using distinguished fields or promoted properties, the Orchestration engine accesses the message context and does not load the document into memory.</span></span>  
  
   -   <span data-ttu-id="b9954-154">若您使用對應將數個欄位彙總成一個欄位，請使用辨別欄位或升級屬性搭配協調流程變數，以累計結果集。</span><span class="sxs-lookup"><span data-stu-id="b9954-154">If you are using a map to aggregate several fields into one field, use distinguished fields or promoted properties with an orchestration variable to accumulate the result set.</span></span>  
  
   -   <span data-ttu-id="b9954-155">請勿將協調流程設定為含有多個轉換圖形輸入。</span><span class="sxs-lookup"><span data-stu-id="b9954-155">Do not configure an orchestration with multiple inputs to transform shapes.</span></span> <span data-ttu-id="b9954-156">含有多個轉換圖形輸入的協調流程在對應時不會串流至檔案系統。</span><span class="sxs-lookup"><span data-stu-id="b9954-156">An orchestration that contains multiple inputs to transform shapes will not stream to the file system while mapping.</span></span> <span data-ttu-id="b9954-157">如果文件大小超過指定的 TransformThreshold 登錄值，這項限制將導致要對應的整份文件均載入記憶體。</span><span class="sxs-lookup"><span data-stu-id="b9954-157">This limitation will cause the entire document that is being mapped to load into memory if the document size exceeds the specified TransformThreshold registry value.</span></span> <span data-ttu-id="b9954-158">這個問題可行的解決方法之一就是在接收埠層級套用轉換，如此一來，協調流程將永不接受一個以上的轉換圖形輸入。</span><span class="sxs-lookup"><span data-stu-id="b9954-158">One possible workaround to this issue would be to apply transforms at the receive port level so that the orchestration never accepts more than a single input to transform shapes.</span></span>  
  
3. <span data-ttu-id="b9954-159">調整**大型訊息分割大小**屬性上公開**BizTalk 群組屬性**組態 頁面上：</span><span class="sxs-lookup"><span data-stu-id="b9954-159">Adjust the **Large message fragment size** property exposed on the **BizTalk Group Properties** configuration page:</span></span>  
  
    <span data-ttu-id="b9954-160">如果接收的訊息之記憶體中大小超過指定的位元組數目**大型訊息分割大小**則訊息會分割成片段，指定的大小和片段會寫入至下 MessageBoxMicrosoft Distributed Transaction Coordinator (MSDTC) 交易，如下所示的內容：</span><span class="sxs-lookup"><span data-stu-id="b9954-160">If the in-memory size of a received message exceeds the number of bytes specified for **Large message fragment size** then the message is split into fragments of the specified size and the fragments are written into the MessageBox under the context of a Microsoft Distributed Transaction Coordinator (MSDTC) transaction as follows:</span></span>  
  
   1.  <span data-ttu-id="b9954-161">若內送訊息正在現有 MSDTC 交易的環境下發佈，則會在將訊息分割寫入 MessageBox 時，使用此交易。</span><span class="sxs-lookup"><span data-stu-id="b9954-161">If the incoming message is being published under the context of an existing MSDTC transaction, then this transaction is used when writing the message fragments to the MessageBox.</span></span> <span data-ttu-id="b9954-162">例如，若內送訊息由設定為必要交易的交易配接器發佈，則在將訊息分割寫入 MessageBox 時，會使用現有的交易。</span><span class="sxs-lookup"><span data-stu-id="b9954-162">For example if the incoming message is being published by a transactional adapter configured to require transactions then the existing transaction would be used when writing the message fragments to the MessageBox.</span></span>  
  
   2.  <span data-ttu-id="b9954-163">若內送訊息不在現有 MSDTC 交易的環境下發佈，則會建立新的 MSDTC 交易以寫入訊息分割。</span><span class="sxs-lookup"><span data-stu-id="b9954-163">If the incoming message is not being published under the context of an existing MSDTC transaction, then a new MSDTC transaction is created to write the message fragments.</span></span>  
  
   -   <span data-ttu-id="b9954-164">增加的值**大型訊息分割大小**以減少與大型訊息會分割並降低建立關聯的 MSDTC 交易的發生率的頻率。</span><span class="sxs-lookup"><span data-stu-id="b9954-164">Increase the value for **Large message fragment size** to reduce the frequency with which large messages are fragmented and reduce the incidence of creating the associated MSDTC transactions.</span></span> <span data-ttu-id="b9954-165">您應該執行此動作，因為從效能觀點來看，過度使用 MSDTC 交易的代價很高。</span><span class="sxs-lookup"><span data-stu-id="b9954-165">This should be done because excessive use of MSDTC transactions is expensive from a performance standpoint.</span></span> <span data-ttu-id="b9954-166">請注意，增加此值也可能增加使用的可用記憶體量。</span><span class="sxs-lookup"><span data-stu-id="b9954-166">Note that increasing this value may also increase the amount of available memory that is used.</span></span>  
  
   -   <span data-ttu-id="b9954-167">若將訊息寫入 MessageBox 所花費的時間超過 MSDTC 交易逾時允許的上限 (60 分鐘)，則交易會逾時、導致錯誤，且寫入訊息的嘗試會失敗並回復。</span><span class="sxs-lookup"><span data-stu-id="b9954-167">If it takes longer than the maximum allowable MSDTC transaction timeout of 60 minutes to write a message to the MessageBox, then the transaction times out, an error results, and the attempt to write the message fails and is rolled back.</span></span> <span data-ttu-id="b9954-168">**大型訊息分割大小**值應該增加足夠處理非常大型的訊息時避免發生這個問題。</span><span class="sxs-lookup"><span data-stu-id="b9954-168">The **Large message fragment size** value should be increased enough to avoid this problem when processing very large messages.</span></span> <span data-ttu-id="b9954-169">視可用的記憶體而定，此值最多可增加到 1000000 個位元組的值。</span><span class="sxs-lookup"><span data-stu-id="b9954-169">Depending on available memory, this value should be increased up to a maximum value of 1000000 bytes.</span></span>  
  
   -   <span data-ttu-id="b9954-170">訊息中的每個訊息分割都會對 MessageBox 資料庫建立一或多個 SQL Server 資料庫鎖定。</span><span class="sxs-lookup"><span data-stu-id="b9954-170">Each message fragment in a message creates one or more SQL Server database locks against the MessageBox database.</span></span> <span data-ttu-id="b9954-171">當鎖定數目超過數十萬時，SQL Server 可能會開始產生「鎖定不足」錯誤。</span><span class="sxs-lookup"><span data-stu-id="b9954-171">When the number of locks exceeds several hundred thousand, it is possible that SQL Server will start generating “out of lock” errors.</span></span> <span data-ttu-id="b9954-172">如果發生此問題，請增加**大型訊息分割大小**以降低對 MessageBox 資料庫的 SQL Server 資料庫鎖定數目。</span><span class="sxs-lookup"><span data-stu-id="b9954-172">If this problem occurs, increase the **Large message fragment size** to reduce the number of SQL Server database locks made against the MessageBox database.</span></span>  
  
4. <span data-ttu-id="b9954-173">若發生「鎖定不足」錯誤，請考慮將您的 MessageBox 資料庫儲存在 64 位元版本的 SQL Server 上。</span><span class="sxs-lookup"><span data-stu-id="b9954-173">Consider housing your MessageBox database on a 64-bit version of SQL Server if you are experiencing "out of lock" errors.</span></span> <span data-ttu-id="b9954-174">在 64 位元版本的 SQL Server 上，可用的鎖定數目大幅提高。</span><span class="sxs-lookup"><span data-stu-id="b9954-174">The number of available locks is significantly higher on the 64-bit version of SQL Server.</span></span>  
  
5. <span data-ttu-id="b9954-175">調整**大型訊息閾值**屬性上公開**BizTalk 群組屬性**組態 頁面上：</span><span class="sxs-lookup"><span data-stu-id="b9954-175">Adjust the **Large message threshold** property exposed on the **BizTalk Group Properties** configuration page:</span></span>  
  
    <span data-ttu-id="b9954-176">為訊息批次處理時，如果記憶體中大小的訊息批次達到指定的位元組數目**大型訊息閾值**然後已處理的訊息批次部分寫入 MessageBox 之前處理訊息批次的其餘部分。</span><span class="sxs-lookup"><span data-stu-id="b9954-176">As a message batch is processed, if the in-memory size of a message batch reaches the number of bytes specified for **Large message threshold** then the portion of the message batch that has been processed is written to the MessageBox before the remainder of the message batch is processed.</span></span> <span data-ttu-id="b9954-177">此動作是在 MSDTC 交易環境下執行，如下所示：</span><span class="sxs-lookup"><span data-stu-id="b9954-177">This is done under the context of an MSDTC transaction as follows:</span></span>  
  
   1. <span data-ttu-id="b9954-178">若訊息批次正在現有 MSDTC 交易的環境下發佈，則會在將處理的訊息批次部分寫入 MessageBox 時，使用此交易。</span><span class="sxs-lookup"><span data-stu-id="b9954-178">If the message batch is being published under the context of an existing MSDTC transaction, then this transaction is used when writing the processed portion of the message batch to the MessageBox.</span></span> <span data-ttu-id="b9954-179">例如，若內送訊息批次由設定為必要交易的交易配接器發佈，則在將處理的訊息批次部分寫入 MessageBox 時，會使用現有的交易。</span><span class="sxs-lookup"><span data-stu-id="b9954-179">For example if the incoming message batch is being published by a transactional adapter configured to require transactions then the existing transaction would be used when writing the processed portion of the message batch to the MessageBox.</span></span>  
  
   2. <span data-ttu-id="b9954-180">若訊息批次不在現有 MSDTC 交易的環境下發佈，則必須建立新的 MSDTC 交易，以將訊息批次部分寫入 MessageBox。</span><span class="sxs-lookup"><span data-stu-id="b9954-180">If the message batch is not being published under the context of an existing MSDTC transaction, then a new MSDTC transaction must be created to write the portions of the message batch to the MessageBox.</span></span> <span data-ttu-id="b9954-181">使用 MSDTC 交易可確保指定的訊息批次之所有部分均成功寫入 MessageBox 資料庫。</span><span class="sxs-lookup"><span data-stu-id="b9954-181">The MSDTC transaction is used to ensure that all of the portions of a given message batch are successfully written to the MessageBox database.</span></span>  
  
      <span data-ttu-id="b9954-182">**大型訊息閾值**設定可直接套用至訊息的批次，但訊息批次可以設定為值為 1，因為**大型訊息閾值**設定也可以間接適用於個別訊息。</span><span class="sxs-lookup"><span data-stu-id="b9954-182">The **Large message threshold** setting is directly applicable to message batches but since a message batch can be set to a value of one, the **Large message threshold** setting can also be indirectly applicable to individual messages.</span></span> <span data-ttu-id="b9954-183">例如當一個訊息的訊息批次超過指定時才**大型訊息閾值**參數則**大型訊息閾值**實際上只適用於批次中的單一訊息。</span><span class="sxs-lookup"><span data-stu-id="b9954-183">For example when a message batch of one message exceeds the specified **Large message threshold** parameter then the **Large message threshold** in effect applies only to the single message in the batch.</span></span>  
  
   -   <span data-ttu-id="b9954-184">**大型訊息閾值**應該調整參數，以減少用來分配訊息批次至 MessageBox 的 MSDTC 交易的建立。</span><span class="sxs-lookup"><span data-stu-id="b9954-184">The **Large message threshold** parameter should be adjusted to mitigate the creation of MSDTC transactions used to apportion message batches to the MessageBox.</span></span> <span data-ttu-id="b9954-185">您應該執行此動作，因為從效能觀點來看，過度使用 MSDTC 交易的代價很高。</span><span class="sxs-lookup"><span data-stu-id="b9954-185">This should be done because the excessive use of MSDTC transactions is expensive from a performance standpoint.</span></span> <span data-ttu-id="b9954-186">使用下列計算來判斷哪些的最小值**大型訊息閾值**設定應該避免建立不必要的 MSDTC 交易：</span><span class="sxs-lookup"><span data-stu-id="b9954-186">Use the following calculation to determine what the minimum value for the **Large message threshold** setting should be to avoid unnecessarily creating MSDTC transactions:</span></span>  
  
       ```  
       Batch Size * Average size (in bytes) of each message in the batch after being processed by the receive pipeline < Large message threshold  
       ```  
  
        <span data-ttu-id="b9954-187">只要以位元組為單位的訊息批次的總大小超過指定的值，如**大型訊息閾值**則不需要初始化 MSDTC 交易的 BizTalk 來分配訊息批次至 MessageBox資料庫。</span><span class="sxs-lookup"><span data-stu-id="b9954-187">As long as the total size in bytes of a message batch does not exceed the specified value for **Large message threshold** then there is no need for BizTalk to initiate an MSDTC transaction to apportion the message batch to the MessageBox database.</span></span>