---
title: 協議解析和外寄 EDI 訊息的結構描述判斷 |Microsoft 文件
ms.custom: ''
ms.date: 06/08/2017
ms.prod: biztalk-server
ms.reviewer: ''
ms.suite: ''
ms.tgt_pltfrm: ''
ms.topic: article
ms.assetid: e37aeb9d-1e95-464d-bb71-73653c1d4674
caps.latest.revision: 24
author: MandiOhlinger
ms.author: mandia
manager: anneta
ms.openlocfilehash: 4d33715d4f1683910269adf7b49965e31bce4840
ms.sourcegitcommit: cb908c540d8f1a692d01dc8f313e16cb4b4e696d
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 09/20/2017
ms.locfileid: "22231510"
---
# <a name="agreement-resolution-and-schema-determination-for-outgoing-edi-messages"></a><span data-ttu-id="a4e32-102">外寄 EDI 訊息的協議解析和結構描述判斷</span><span class="sxs-lookup"><span data-stu-id="a4e32-102">Agreement Resolution and Schema Determination for Outgoing EDI Messages</span></span>
<span data-ttu-id="a4e32-103">若要產生給交易夥伴的 EDI 訊息，EDI 傳送管線必須執行下列動作：</span><span class="sxs-lookup"><span data-stu-id="a4e32-103">To generate an EDI message to a trading partner, the EDI send pipeline must do the following:</span></span>  
  
-   <span data-ttu-id="a4e32-104">判斷訊息會解析為的協議</span><span class="sxs-lookup"><span data-stu-id="a4e32-104">Determine the agreement that the message resolves to</span></span>  
  
-   <span data-ttu-id="a4e32-105">判斷要用來驗證訊息的結構描述</span><span class="sxs-lookup"><span data-stu-id="a4e32-105">Determine the schema to use to validate the message</span></span>  
  
## <a name="agreement-resolution"></a><span data-ttu-id="a4e32-106">協議解析</span><span class="sxs-lookup"><span data-stu-id="a4e32-106">Agreement Resolution</span></span>  
 <span data-ttu-id="a4e32-107">EDI 傳送管線會執行一系列的步驟來執行協議尋查，以判斷外寄交換和協議屬性之間是否相符。</span><span class="sxs-lookup"><span data-stu-id="a4e32-107">The EDI send pipeline performs agreement lookup by performing a series of steps to determine whether there is a match between the outgoing interchange and the properties of an agreement.</span></span> <span data-ttu-id="a4e32-108">一旦 [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)] 判斷出協議，就會決定套用到交換的文件結構描述 (請參閱下文)。</span><span class="sxs-lookup"><span data-stu-id="a4e32-108">Once [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)] has determined the agreement, it determines the document schema that applies to the interchange (see below).</span></span> <span data-ttu-id="a4e32-109">它會使用與相符協議關聯的屬性和相關的結構描述，產生及驗證外寄訊息。</span><span class="sxs-lookup"><span data-stu-id="a4e32-109">It uses the properties associated with the matching agreement and the relevant schema to generate and validate the outgoing message.</span></span>  
  
 <span data-ttu-id="a4e32-110">為執行協議解析，[!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)] 執行的步驟如下：</span><span class="sxs-lookup"><span data-stu-id="a4e32-110">To perform agreement resolution, [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)] proceeds as follows:</span></span>  
  
1.  <span data-ttu-id="a4e32-111">比對 AgreementPartIDForSend 內容屬性與單向協議的識別碼，以解析協議。</span><span class="sxs-lookup"><span data-stu-id="a4e32-111">Resolves the agreement by matching the AgreementPartIDForSend context property with the ID of the one-way agreement.</span></span> <span data-ttu-id="a4e32-112">此屬性應該為整數類型，您可以在自訂元件中加以設定；這不是由 [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)] 設定。</span><span class="sxs-lookup"><span data-stu-id="a4e32-112">This property should be an integer type, it can be set in a custom component; it is not set by [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)].</span></span>  
  
2.  <span data-ttu-id="a4e32-113">如果步驟 1 未成功，則比對下列三個內容屬性與協議屬性，以解析協議：AgreementNameForSend、SenderPartyNameForSend、ReceiverPartyNameForSend。</span><span class="sxs-lookup"><span data-stu-id="a4e32-113">If step 1 does not succeed, resolves the agreement by matching all the following three context properties with the agreement properties: AgreementNameForSend, SenderPartyNameForSend, ReceiverPartyNameForSend.</span></span> <span data-ttu-id="a4e32-114">請注意，這三個屬性必須全都已設定好，才能成功解析為協議。</span><span class="sxs-lookup"><span data-stu-id="a4e32-114">Note that all the three properties must be set in order to successfully resolve to an agreement.</span></span> <span data-ttu-id="a4e32-115">您可以在自訂元件中設定這些屬性；這並不是由 [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)] 設定。</span><span class="sxs-lookup"><span data-stu-id="a4e32-115">These properties can be set in a custom component; it is not set by [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)].</span></span>  
  
3.  <span data-ttu-id="a4e32-116">如果步驟 2 未成功，會藉由比對訊息內容屬性與設定為其他的協議解析程式中的 DestinationPartyName 屬性中的合作對象名稱解析協議**識別碼** 索引標籤協議屬性。</span><span class="sxs-lookup"><span data-stu-id="a4e32-116">If step 2 does not succeed, resolves the agreement by matching the party name in the message context properties with the DestinationPartyName property, which is set as additional agreement resolver in the **Identifiers** tab of agreement properties.</span></span>  
  
4.  <span data-ttu-id="a4e32-117">如果步驟 3 未成功，則比對訊息內容中與協議屬性中的下列屬性，以解析協議：DestinationPartySenderIdentifier、DestinationPartySenderQualifier、DestinationPartyReceiverIdentifier 和 DestinationPartyReceiverQualifier。</span><span class="sxs-lookup"><span data-stu-id="a4e32-117">If step 3 does not succeed, resolves the agreement by matching the following properties in the context of a message with those in agreement properties: DestinationPartySenderIdentifier, DestinationPartySenderQualifier, DestinationPartyReceiverIdentifier, and DestinationPartyReceiverQualifier.</span></span> <span data-ttu-id="a4e32-118">請注意，這四個屬性必須全都已設定好，才能成功解析為協議。</span><span class="sxs-lookup"><span data-stu-id="a4e32-118">Note that all the four properties must be set in order to successfully resolve to an agreement.</span></span> <span data-ttu-id="a4e32-119">您可以在自訂元件中設定這些屬性；這並不是由 [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)] 設定。</span><span class="sxs-lookup"><span data-stu-id="a4e32-119">These properties can be set in a custom component; they are not set by [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)].</span></span> <span data-ttu-id="a4e32-120">如需詳細資訊，請參閱下面。</span><span class="sxs-lookup"><span data-stu-id="a4e32-120">For more information, see below.</span></span>  
  
    > [!NOTE]
    >  <span data-ttu-id="a4e32-121">如果有任何上述內容屬性升級，而 [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)] 找不到與這些內容屬性關聯的協議，則 [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)] 會擱置訊息。</span><span class="sxs-lookup"><span data-stu-id="a4e32-121">If any of the above sets of context properties are promoted and [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)] is unable to find an agreement associated with those context properties, then [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)] suspends the message.</span></span>  
    >   
    >  <span data-ttu-id="a4e32-122">如果使用者刻意撰寫一組內容屬性來協助解析協議，而解析程式無法識別 OnewayAgreement，則會擱置訊息。</span><span class="sxs-lookup"><span data-stu-id="a4e32-122">If the user intentionally writes a set of context properties for agreement resolution, and if the resolver fails to identify the OnewayAgreement, then the message is suspended.</span></span> <span data-ttu-id="a4e32-123">無法根據一組內容屬性來解析協議時，EventLog 中會擲回對應的警告訊息。</span><span class="sxs-lookup"><span data-stu-id="a4e32-123">On failure to resolve to an agreement based on a set of context properties, a corresponding warning message is thrown in the EventLog.</span></span>  
  
5.  <span data-ttu-id="a4e32-124">如果步驟 4 不成功，或上述內容屬性都未升級，則會將訂閱訊息的傳送埠與和協議關聯的傳送埠比對，將 EDI 訊息解析為協議。</span><span class="sxs-lookup"><span data-stu-id="a4e32-124">If step 4 does not succeed or none of the above context properties are promoted, then the EDI message is resolved to an agreement by matching the send port that subscribed to the message with the send port associated with an agreement.</span></span>  
  
    > [!NOTE]
    >  <span data-ttu-id="a4e32-125">如果同一個傳送埠與多個協議相關聯，則 [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)] 會產生錯誤。</span><span class="sxs-lookup"><span data-stu-id="a4e32-125">If the same send port is associated with multiple agreements, [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)] will generate an error.</span></span>  
  
6.  <span data-ttu-id="a4e32-126">如果在步驟 1、2、3 或 4 中找不到協議，傳送管線會使用後援協議設定來產生外寄訊息。</span><span class="sxs-lookup"><span data-stu-id="a4e32-126">If no agreement is found in steps 1, 2, 3, or 4, the send pipeline uses the fallback agreement settings to generate the outgoing message.</span></span>  
  
 <span data-ttu-id="a4e32-127">**藉由比對傳送者與接收者內容屬性的協議解析**</span><span class="sxs-lookup"><span data-stu-id="a4e32-127">**Agreement Resolution by Matching Sender and Receiver Context Properties**</span></span>  
  
 <span data-ttu-id="a4e32-128">在上述步驟 2 中，比對作業所使用的四個內容屬性為 EDI.DestinationPartySenderIdentifier、EDI.DestinationPartySenderQualifier、EDI.DestinationPartyReceiverIdentifier 和 EDI.DestinationPartyReceiverQualifier。</span><span class="sxs-lookup"><span data-stu-id="a4e32-128">In the second step above, the four context properties used in the match are EDI.DestinationPartySenderIdentifier, EDI.DestinationPartySenderQualifier, EDI.DestinationPartyReceiverIdentifier, and EDI.DestinationPartyReceiverQualifier.</span></span> <span data-ttu-id="a4e32-129">這些內容屬性的命名空間是 `http://schemas.microsoft.com/Edi/PropertySchema`。</span><span class="sxs-lookup"><span data-stu-id="a4e32-129">The namespace for these context properties is `http://schemas.microsoft.com/Edi/PropertySchema`.</span></span> [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)]<span data-ttu-id="a4e32-130">嘗試將相關的傳送者和接收者識別碼和辨識符號的單向協議屬性比對這些值。</span><span class="sxs-lookup"><span data-stu-id="a4e32-130"> attempts to match these values with the related sender and receiver identifiers and qualifiers in the one-way agreement properties.</span></span> <span data-ttu-id="a4e32-131">對於 X12，這些欄位是 ISA05、 ISA06、 ISA07 和 ISA08 中的**識別碼**頁面的單向協議索引標籤中**協議屬性**對話方塊; 對於 EDIFACT，這些欄位是 UNB2.1、 UNB2.2，UNB3.1 和 UNB3.2 中的**識別碼**頁面的單向協議索引標籤中**協議屬性** 對話方塊。</span><span class="sxs-lookup"><span data-stu-id="a4e32-131">For X12, these fields are ISA05, ISA06, ISA07, and ISA08 in the **Identifiers** page of the one-way agreement tab in the **Agreement Properties** dialog box; for EDIFACT, these fields are UNB2.1, UNB2.2, UNB3.1, and UNB3.2 in the **Identifiers** page of the one-way agreement tab in the **Agreement Properties** dialog box.</span></span>  
  
 <span data-ttu-id="a4e32-132">若要使用全部四個傳送者和接收者識別碼和辨識符號來解析傳送端協議，必須設定全部這四個內容屬性。</span><span class="sxs-lookup"><span data-stu-id="a4e32-132">To enable send-side agreement resolution using all four sender and receiver identifiers and qualifiers, you will have to set all four context properties.</span></span> <span data-ttu-id="a4e32-133">這樣就會唯一識別協議。</span><span class="sxs-lookup"><span data-stu-id="a4e32-133">Doing so uniquely identifies the agreement.</span></span> <span data-ttu-id="a4e32-134">使用這個協議尋查方法，您在傳送端處理方面就可擁有更大的彈性。</span><span class="sxs-lookup"><span data-stu-id="a4e32-134">Using this method of agreement lookup gives you more flexibility in send-side processing.</span></span> <span data-ttu-id="a4e32-135">例如，這個方法可避免您在某些狀況下建立多個傳送埠，以及避免使用複雜的傳送埠篩選條件。</span><span class="sxs-lookup"><span data-stu-id="a4e32-135">For example, this method may enable you to avoid creating multiple send ports in some circumstances, and to avoid complicated send port filters.</span></span> <span data-ttu-id="a4e32-136">視需要，也可以避免設定 OneWayAgreementId 屬性。</span><span class="sxs-lookup"><span data-stu-id="a4e32-136">It also enables you to avoid setting the OneWayAgreementId property, if desired.</span></span>  
  
 <span data-ttu-id="a4e32-137">如果已為訊息設定全部的四個內容屬性，而這些內容屬性與合作對象屬性完全不符，訊息就會遭到擱置。</span><span class="sxs-lookup"><span data-stu-id="a4e32-137">If all four context properties have been set for a message, and no match is found between those context properties and the property properties, the message is suspended.</span></span> <span data-ttu-id="a4e32-138">只有在未設定全部四個內容屬性時，才會使用與協議相關聯的傳送埠來解析協議。</span><span class="sxs-lookup"><span data-stu-id="a4e32-138">The agreement will be resolved using the send port associated with an agreement only if all four context properties have not been set.</span></span>  
  
> [!NOTE]
>  <span data-ttu-id="a4e32-139">EDI 管線中的訊息會進入協議解析的後續步驟，直到訊息在協議為啟用狀態的步驟中獲得解析為止。</span><span class="sxs-lookup"><span data-stu-id="a4e32-139">A message in the EDI pipeline goes to the succeeding step in Agreement Resolution till the message gets resolved with the step having Agreement in enable state.</span></span> <span data-ttu-id="a4e32-140">例如，如果訊息在協議解析的第一個步驟獲得解析，但協議處於停用狀態，則訊息會進入後續解析步驟。</span><span class="sxs-lookup"><span data-stu-id="a4e32-140">For example, if the message gets resolved in the first step of Agreement Resolution but the Agreement is in a disabled state then the message goes to the succeeding step for resolution.</span></span>  
  
## <a name="schema-determination"></a><span data-ttu-id="a4e32-141">結構描述判斷</span><span class="sxs-lookup"><span data-stu-id="a4e32-141">Schema Determination</span></span>  
 <span data-ttu-id="a4e32-142">EDI 傳送管線會根據每個交易集的中繼 XML 檔案中包含的結構描述名稱和結構描述命名空間 (做為文件類型資訊或在根節點中)，判斷套用至訊息的結構描述。</span><span class="sxs-lookup"><span data-stu-id="a4e32-142">The EDI send pipeline determines the schema that applies to the message from the schema name and schema namespace contained in the intermediate XML file for each transaction set (either as doc type information or in the root node).</span></span>  
  
 <span data-ttu-id="a4e32-143">對於已經保留的交換，傳送管線會針對整個交換，使用中繼 XML 檔案之個別交易集中的文件類型資訊。</span><span class="sxs-lookup"><span data-stu-id="a4e32-143">For an interchange that has been preserved, the send pipeline uses the doc type information in the individual transaction sets of the intermediate XML file for the complete interchange.</span></span> <span data-ttu-id="a4e32-144">它會使用控制區段結構描述來處理信封區段。</span><span class="sxs-lookup"><span data-stu-id="a4e32-144">It uses the control segment schemas for processing the envelope segments.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="a4e32-145">另請參閱</span><span class="sxs-lookup"><span data-stu-id="a4e32-145">See Also</span></span>  
 [<span data-ttu-id="a4e32-146">BizTalk Server 如何傳送 EDI 訊息</span><span class="sxs-lookup"><span data-stu-id="a4e32-146">How BizTalk Server Sends EDI Messages</span></span>](../core/how-biztalk-server-sends-edi-messages.md)