---
title: "協調流程 |Microsoft 文件"
ms.custom: 
ms.date: 06/08/2017
ms.prod: biztalk-server
ms.reviewer: 
ms.suite: 
ms.tgt_pltfrm: 
ms.topic: article
helpviewer_keywords:
- orchestrations
- correlations, orchestrations
- orchestrations, correlations
- orchestrations, deploying
- deploying, orchestrations
- orchestrations, about orchestrations
ms.assetid: fb01f78a-b805-46be-a7d9-2b7597daab96
caps.latest.revision: "8"
author: MandiOhlinger
ms.author: mandia
manager: anneta
ms.openlocfilehash: 73fb7a4af3a8ef7da8e9da97047006470eb8cc18
ms.sourcegitcommit: cb908c540d8f1a692d01dc8f313e16cb4b4e696d
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 09/20/2017
---
# <a name="orchestrations"></a><span data-ttu-id="dae65-102">協調流程</span><span class="sxs-lookup"><span data-stu-id="dae65-102">Orchestrations</span></span>
<span data-ttu-id="dae65-103">*協調流程*是可以訂閱 （接收） 的可執行的商務程序和發佈 （傳送） 訊息到 MessageBox 資料庫。</span><span class="sxs-lookup"><span data-stu-id="dae65-103">*Orchestrations* are executable business processes that can subscribe to (receive) and publish (send) messages through the MessageBox database.</span></span> <span data-ttu-id="dae65-104">此外，協調流程可以建構新的訊息。</span><span class="sxs-lookup"><span data-stu-id="dae65-104">In addition, orchestrations can construct new messages.</span></span> <span data-ttu-id="dae65-105">使用訂閱接收訊息並路由基礎結構中討論[訊息的生命週期](../core/lifecycle-of-a-message.md)。</span><span class="sxs-lookup"><span data-stu-id="dae65-105">Messages are received using the subscription and routing infrastructure discussed in [Lifecycle of a Message](../core/lifecycle-of-a-message.md).</span></span> <span data-ttu-id="dae65-106">若已為協調流程填入訂閱，則會啟動新的執行個體並傳送訊息，或者，在執行個體訂閱的狀況下，若有需要，執行個體會解除凍結，然後會傳送訊息。</span><span class="sxs-lookup"><span data-stu-id="dae65-106">When subscriptions are filled for orchestrations, a new instance is activated and the message is delivered, or in the case of instance subscriptions, the instance is rehydrated if necessary and the message is then delivered.</span></span> <span data-ttu-id="dae65-107">當從協調流程傳送訊息時，它們會以訊息到達接收位置時的相同方式發佈至 MessageBox，同時會有適當的屬性插入至資料庫中以供路由使用。</span><span class="sxs-lookup"><span data-stu-id="dae65-107">When messages are sent from an orchestration, they are published to the MessageBox in the same manner as a message arriving on a receive location with the appropriate properties getting inserted into the database for use in routing.</span></span>  
  
 <span data-ttu-id="dae65-108">在協調流程中建構的訊息必須放置在 MessageBox 資料庫中，並由協調流程執行個體所參考，但是它們不應該被發佈，因為它們尚未傳送。</span><span class="sxs-lookup"><span data-stu-id="dae65-108">Messages that are constructed in an orchestration must be placed in the MessageBox database and referenced by the orchestration instance, but they should not be published because they have not yet been sent.</span></span> <span data-ttu-id="dae65-109">XLANG/s 子服務會呼叫訊息代理程式 API，直接插入訊息。</span><span class="sxs-lookup"><span data-stu-id="dae65-109">The XLANG/s subservice makes calls to the Message Agent API to insert messages directly.</span></span> <span data-ttu-id="dae65-110">這可讓協調流程引擎將訊息內文插入至 MessageBox，並讓它與正在執行的協調流程執行個體直接產生關聯。</span><span class="sxs-lookup"><span data-stu-id="dae65-110">This allows the orchestration engine to insert the message body into the MessageBox and have it directly associated with the running orchestration instance.</span></span> <span data-ttu-id="dae65-111">在 MessageBox 資料庫中已建構訊息的持續性，會與協調流程中的持續點進行協調，以做為資料庫作業的其他最佳化。</span><span class="sxs-lookup"><span data-stu-id="dae65-111">The persistence of the constructed message in the MessageBox database is coordinated with persistence points in the orchestration as an additional optimization of database operations.</span></span>  
  
 <span data-ttu-id="dae65-112">在協調流程中使發佈和訂閱的行為似乎不同的概念是繫結。</span><span class="sxs-lookup"><span data-stu-id="dae65-112">The concept in orchestrations that makes the publish and subscribe seem to act differently is binding.</span></span> <span data-ttu-id="dae65-113">協調流程連接埠是描述互動的邏輯連接埠。</span><span class="sxs-lookup"><span data-stu-id="dae65-113">Orchestration ports are logical ports that describe an interaction.</span></span> <span data-ttu-id="dae65-114">您必須將這些邏輯連接埠繫結至實體連接埠，如此一來訊息才會傳送，不過這個繫結程序只不過是設定訊息路由的訂閱。</span><span class="sxs-lookup"><span data-stu-id="dae65-114">You must bind these logical ports to a physical port so that messages are delivered, but this binding process is nothing more than configuring subscriptions for message routing.</span></span>  
  
 <span data-ttu-id="dae65-115">有四個基本選項可以繫結這些連接埠：</span><span class="sxs-lookup"><span data-stu-id="dae65-115">There are four basic options for binding these ports:</span></span>  
  
-   <span data-ttu-id="dae65-116">立即指定 (直接在協調流程中指定連接埠)</span><span class="sxs-lookup"><span data-stu-id="dae65-116">Specify Now (specifying ports directly in the orchestration)</span></span>  
  
-   <span data-ttu-id="dae65-117">稍後指定 (在部署期間指定連接埠)</span><span class="sxs-lookup"><span data-stu-id="dae65-117">Specify Later (specifying ports at deployment time)</span></span>  
  
-   <span data-ttu-id="dae65-118">使用動態傳送埠，其中位址是以協調流程程式碼所設定</span><span class="sxs-lookup"><span data-stu-id="dae65-118">Using a dynamic send port where the address is set in the orchestration code</span></span>  
  
-   <span data-ttu-id="dae65-119">從協調流程建立直接繫結到 MessageBox 資料庫或另一個協調流程</span><span class="sxs-lookup"><span data-stu-id="dae65-119">Creating a direct binding from the orchestration to either the MessageBox database or to another orchestration</span></span>  
  
## <a name="deploying-orchestrations"></a><span data-ttu-id="dae65-120">部署協調流程</span><span class="sxs-lookup"><span data-stu-id="dae65-120">Deploying Orchestrations</span></span>  
 <span data-ttu-id="dae65-121">若繫結是在設計期間指定，則在部署協調流程時，會建立符合在協調流程中設定之參數的實體連接埠。</span><span class="sxs-lookup"><span data-stu-id="dae65-121">When a binding is specified at design time, the physical port that matches the parameters configured in the orchestration is created when the orchestration is deployed.</span></span> <span data-ttu-id="dae65-122">若繫結是在部署期間設定，則符合邏輯連接埠需求的任何連接埠，都可以繫結到協調流程連接埠。</span><span class="sxs-lookup"><span data-stu-id="dae65-122">When the binding is configured at deployment time, any port that matches the requirements of the logical port can be bound to the orchestration port.</span></span> <span data-ttu-id="dae65-123">至於動態繫結，選擇 [立即指定] 選項即會建立實體連接埠，不過這個連接埠是未設定位址資訊的動態傳送埠。</span><span class="sxs-lookup"><span data-stu-id="dae65-123">For dynamic binding, a physical port is created just as with the Specify Now option, but the port is a dynamic send port that has no address information configured.</span></span>  
  
 <span data-ttu-id="dae65-124">常令人混淆的概念是，當協調流程中的傳送埠繫結到實體傳送埠時，並無法阻止訊息傳送到其他訂閱者。</span><span class="sxs-lookup"><span data-stu-id="dae65-124">A confusing concept is that while a send port in an orchestration is bound to a physical send port, this does not preclude that message from getting delivered to other subscribers.</span></span> <span data-ttu-id="dae65-125">也就是說，若另一個傳送埠透過它的篩選條件，訂閱要傳送到繫結連接埠的訊息，那麼這兩個傳送埠都會接收到該訊息。</span><span class="sxs-lookup"><span data-stu-id="dae65-125">That is, if another send port happens to have a subscription, through its filters, for the message being sent to the bound port, both send ports receive the message.</span></span> <span data-ttu-id="dae65-126">繫結只會建立訂閱，如此一來，從協調流程傳送的訊息永遠都會符合繫結傳送埠的準則。</span><span class="sxs-lookup"><span data-stu-id="dae65-126">Binding simply creates the subscription such that the message sent from the orchestration always matches the criteria for the bound send port.</span></span> <span data-ttu-id="dae65-127">同樣地，繫結至接收埠的協調流程連接埠建立適當的訂用帳戶為基礎的訊息類型和接收連接埠的識別碼。</span><span class="sxs-lookup"><span data-stu-id="dae65-127">Likewise, the orchestration port bound to a receive port creates the appropriate subscription based on message type and receive port ID.</span></span> <span data-ttu-id="dae65-128">這些訂閱保證進出協調流程的訊息傳送到繫結的連接埠，但訊息仍移到相同發佈和訂閱機制稍早所述。</span><span class="sxs-lookup"><span data-stu-id="dae65-128">The subscriptions guarantee that the messages going in and out of the orchestration get delivered to the bound ports, but the messages still go through the same publish and subscribe mechanism described earlier.</span></span>  
  
 <span data-ttu-id="dae65-129">最有可能誤解、濫用或未充分使用的繫結選項是 [直接繫結] 選項。</span><span class="sxs-lookup"><span data-stu-id="dae65-129">Probably the most misunderstood, and misused or underused binding option is the Direct binding option.</span></span> <span data-ttu-id="dae65-130">直接繫結可以讓協調流程以各種路由屬性，將訊息發佈到 MessageBox 資料庫，例如，訊息是由接收位置所發佈。</span><span class="sxs-lookup"><span data-stu-id="dae65-130">Direct binding allows an orchestration to publish messages to the MessageBox database with varying routing properties much like messages are published by receive locations.</span></span> <span data-ttu-id="dae65-131">在簡單的直接傳訊中，訊息會發佈到 MessageBox，而其升級屬性會像任何其他接收到 BizTalk Server 中的已發佈訊息般地路由。</span><span class="sxs-lookup"><span data-stu-id="dae65-131">In simple direct messaging, the message is published to the MessageBox with its promoted properties to be routed like any other published message received into BizTalk Server.</span></span> <span data-ttu-id="dae65-132">這可讓任何訂閱者以接收此訊息，但需要至少一個 「 訂閱者 」 存在，或在協調流程將會收到路由失敗錯誤。</span><span class="sxs-lookup"><span data-stu-id="dae65-132">This enables any subscriber to receive this message, but requires that at least one subscriber exist or the orchestration will receive a routing failure error.</span></span>  
  
 <span data-ttu-id="dae65-133">直接繫結的另一個選項是，使用自我相互關聯的連接埠。</span><span class="sxs-lookup"><span data-stu-id="dae65-133">Another option for direct binding is to use self-correlating ports.</span></span> <span data-ttu-id="dae65-134">自我相互關聯的連接埠會建立唯一相互關聯 Token，並使用該 Token 單獨在執行個體之間相互關聯訊息。</span><span class="sxs-lookup"><span data-stu-id="dae65-134">Self-correlating ports are ports that create a unique correlation token and use that token alone in correlating messages between instances.</span></span> <span data-ttu-id="dae65-135">自我相互關聯的連接埠最常見的用途，就是呼叫或啟動在連接埠參數中傳遞的協調流程。</span><span class="sxs-lookup"><span data-stu-id="dae65-135">The most common use of a self-correlating port is to call or start an orchestration passing in a port parameter.</span></span> <span data-ttu-id="dae65-136">在呼叫的協調流程中，可以使用連接埠來傳送訊息，不過在呼叫協調流程中相同的連接埠也可以用來接收訊息。</span><span class="sxs-lookup"><span data-stu-id="dae65-136">In the called orchestration, the port can be used to send a message, while in the calling orchestration the same port can be used to receive a message.</span></span> <span data-ttu-id="dae65-137">因為連接埠有一個唯一的相互關聯 Token，訊息會路由回到呼叫的協調流程。</span><span class="sxs-lookup"><span data-stu-id="dae65-137">Because the port has a unique correlation token, the message is routed back to the calling orchestration.</span></span> <span data-ttu-id="dae65-138">自我相互關聯的連接埠就像協調流程執行個體之間的私用通訊通道。</span><span class="sxs-lookup"><span data-stu-id="dae65-138">Self-correlation ports act as private communication channels between orchestration instances.</span></span>  
  
 <span data-ttu-id="dae65-139">最後的選項是在呼叫的協調流程和被呼叫的協調流程中使用夥伴協調流程，而連接埠是使用相同的共用連接埠類型所設定的，並在連接埠組態中選取相同的連接埠。</span><span class="sxs-lookup"><span data-stu-id="dae65-139">The final option is to use a partner orchestration in which, in both the calling orchestration and the called orchestration, the port is configured using the same shared port type and in the port configuration, the same port is selected.</span></span> <span data-ttu-id="dae65-140">例如，在 Orch1 和 Orch2 中會選取 Orch2.MyDirectPort。</span><span class="sxs-lookup"><span data-stu-id="dae65-140">For example, in both Orch1 and Orch2, Orch2.MyDirectPort is selected.</span></span> <span data-ttu-id="dae65-141">這個繫結類型會根據傳送的協調流程類型、連接埠名稱和作業名稱，來設定接收協調流程的訂閱。</span><span class="sxs-lookup"><span data-stu-id="dae65-141">This type of binding sets up a subscription for the receiving orchestration based on the sending orchestration type, the port name, and the operation name.</span></span> <span data-ttu-id="dae65-142">這可再次確保訊息會傳送到正確的執行個體。</span><span class="sxs-lookup"><span data-stu-id="dae65-142">This again ensures that the messages get routed to the correct instance.</span></span>  
  
 <span data-ttu-id="dae65-143">所有的直接傳訊選項都會使用基礎發佈與訂閱模型。</span><span class="sxs-lookup"><span data-stu-id="dae65-143">All of the direct messaging options use the underlying publish and subscribe model.</span></span> <span data-ttu-id="dae65-144">這些選項之間的差異在於屬性中，屬性是用來建立訂閱和遞送，並在有使用時協助解決。</span><span class="sxs-lookup"><span data-stu-id="dae65-144">The difference between these options is in the properties that are used for creating subscriptions and routing, and in the use cases they help solve.</span></span>  
  
 <span data-ttu-id="dae65-145">在協調流程中使用直接繫結連接埠常遇到的問題就是，協調流程可能會發佈它本身也訂閱的訊息。</span><span class="sxs-lookup"><span data-stu-id="dae65-145">One common problem encountered when using direct bound ports in orchestrations is that an orchestration may publish a message that it is also subscribed to.</span></span> <span data-ttu-id="dae65-146">例如，協調流程是設定來由 PurchaseOrder 訊息所啟動。</span><span class="sxs-lookup"><span data-stu-id="dae65-146">For example, an orchestration is configured to be activated by a PurchaseOrder message.</span></span> <span data-ttu-id="dae65-147">這個協調流程會使用直接連接埠，將 PurchaseOrder 訊息發佈到 MessageBox。</span><span class="sxs-lookup"><span data-stu-id="dae65-147">This orchestration uses a direct port to publish the PurchaseOrder message to the MessageBox.</span></span> <span data-ttu-id="dae65-148">不過，除了如預期般地接收訊息以外，另一個協調流程的執行個體也會啟動，因為它也有訂閱 PurchaseOrder 訊息。</span><span class="sxs-lookup"><span data-stu-id="dae65-148">However, in addition to receiving the message as expected, another instance of an orchestration is started because it too had a subscription for PurchaseOrder messages.</span></span> <span data-ttu-id="dae65-149">處理會進入無止盡的迴圈，而開發人員可能需要一段時間才能弄清楚發生什麼事。</span><span class="sxs-lookup"><span data-stu-id="dae65-149">The processing gets into an endless loop and it may take some time for a developer to figure out what has happened.</span></span>  
  
## <a name="correlation"></a><span data-ttu-id="dae65-150">Correlation</span><span class="sxs-lookup"><span data-stu-id="dae65-150">Correlation</span></span>  
 <span data-ttu-id="dae65-151">*相互關聯*協調流程中是一種機制相關的訊息接收到相同執行中協調流程執行個體。</span><span class="sxs-lookup"><span data-stu-id="dae65-151">*Correlation* in orchestrations is the mechanism for receiving related messages into the same running orchestration instance.</span></span> <span data-ttu-id="dae65-152">在「協調流程設計師」中，開發人員會遵循下列一般步驟來使用相互關聯：</span><span class="sxs-lookup"><span data-stu-id="dae65-152">In the Orchestration Designer a developer follows these general steps to use a correlation:</span></span>  
  
-   <span data-ttu-id="dae65-153">定義包含用於相關訊息之升級屬性的相互關聯類型。</span><span class="sxs-lookup"><span data-stu-id="dae65-153">Defines a correlation type that includes the promoted properties that are used to relate messages.</span></span>  
  
-   <span data-ttu-id="dae65-154">定義剛定義之相互關聯類型執行個體的相互關聯集。</span><span class="sxs-lookup"><span data-stu-id="dae65-154">Defines a correlation set that is an instance of the correlation type just defined.</span></span>  
  
-   <span data-ttu-id="dae65-155">對於傳送埠和接收埠，指定它們是否起始或遵循指定的相互關聯集。</span><span class="sxs-lookup"><span data-stu-id="dae65-155">For the send and receive ports, specifies whether they initiate or follow a given correlation set.</span></span>  
  
 <span data-ttu-id="dae65-156">在起始相互關聯集之後，執行個體訂閱會開始執行，而此為所有遵循此相互關聯集來接收訊息的那些連接埠而建立訂閱的時機。</span><span class="sxs-lookup"><span data-stu-id="dae65-156">Instance subscriptions come into play when a correlation set is initiated, as this is when subscriptions are created for all of those ports that follow this correlation set to receive messages.</span></span> <span data-ttu-id="dae65-157">因為相互關聯類型會定義即將用於相互關聯的屬性，協調流程引擎可以從由起始動作所傳送或接收的訊息中擷取這些屬性。</span><span class="sxs-lookup"><span data-stu-id="dae65-157">Because the correlation type defines the properties to be used for correlation, the orchestration engine can extract these properties from the message being sent or received by the initiating action.</span></span> <span data-ttu-id="dae65-158">接著，這些值會用來定義所有剩餘動作的訂閱，而這些動作會遵循這個相互關聯集。</span><span class="sxs-lookup"><span data-stu-id="dae65-158">These values are then used to define subscriptions for all of the remaining actions which follow this correlation set.</span></span>  
  
 <span data-ttu-id="dae65-159">BizTalk Server 所接收並計劃用於相互關聯中的訊息，有其正確定義的升級屬性並會升級至訊息內容，這是很重要的。</span><span class="sxs-lookup"><span data-stu-id="dae65-159">It is important that messages received into BizTalk Server and intended for use in a correlation have their promoted properties correctly defined and promoted to the message context.</span></span> <span data-ttu-id="dae65-160">管線中的解譯器元件會在開始接收到訊息時擷取值，而大部分的屬性會在此時升級。</span><span class="sxs-lookup"><span data-stu-id="dae65-160">Most properties get promoted when a disassembler component in a pipeline extracts the values when the message is initially received.</span></span> <span data-ttu-id="dae65-161">基於這個原因，就不可能使用 PassThrough 接收管線，來接收必須相互關聯至協調流程之執行中執行個體的訊息。</span><span class="sxs-lookup"><span data-stu-id="dae65-161">For this reason, it is not possible to use the PassThrough receive pipeline to receive messages that must be correlated to a running instance of an orchestration.</span></span> <span data-ttu-id="dae65-162">當您使用 SOAP 接收配接器來接收相互關聯訊息時就會發生這個問題，因為在使用「Web 服務發佈精靈」時，PassThrough 管線就是接收管線的預設值。</span><span class="sxs-lookup"><span data-stu-id="dae65-162">This issue arises when you use the SOAP receive adapter to receive correlated messages, because the PassThrough pipeline is the default value for the receive pipeline when using the Web Services Publishing Wizard.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="dae65-163">另請參閱</span><span class="sxs-lookup"><span data-stu-id="dae65-163">See Also</span></span>  
 <span data-ttu-id="dae65-164">[成品](../core/artifacts.md) </span><span class="sxs-lookup"><span data-stu-id="dae65-164">[Artifacts](../core/artifacts.md) </span></span>  
 [<span data-ttu-id="dae65-165">建立協調流程使用協調流程設計師</span><span class="sxs-lookup"><span data-stu-id="dae65-165">Creating Orchestrations Using Orchestration Designer</span></span>](../core/creating-orchestrations-using-orchestration-designer.md)