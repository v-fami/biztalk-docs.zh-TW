---
title: 批次處理接收訊息處理 |Microsoft Docs
ms.custom: ''
ms.date: 06/08/2017
ms.prod: biztalk-server
ms.reviewer: ''
ms.suite: ''
ms.tgt_pltfrm: ''
ms.topic: article
ms.assetid: 32bf0b70-e9d1-4fab-9c74-160e51390700
caps.latest.revision: 8
author: MandiOhlinger
ms.author: mandia
manager: anneta
ms.openlocfilehash: 21ce691f51d6c389073c98dadc9ce0f5dfb68504
ms.sourcegitcommit: 266308ec5c6a9d8d80ff298ee6051b4843c5d626
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 06/27/2018
ms.locfileid: "36971055"
---
# <a name="batching-messages-for-receive-processing"></a><span data-ttu-id="b168c-102">批次處理接收訊息</span><span class="sxs-lookup"><span data-stu-id="b168c-102">Batching Messages for Receive Processing</span></span>
## <a name="batch-callbacks"></a><span data-ttu-id="b168c-103">批次回呼</span><span class="sxs-lookup"><span data-stu-id="b168c-103">Batch Callbacks</span></span>  
 <span data-ttu-id="b168c-104">由接收配接器提交至傳訊引擎的批次是以非同步方式處理。</span><span class="sxs-lookup"><span data-stu-id="b168c-104">Batches submitted by receive adapters to the Messaging Engine are processed asynchronously.</span></span> <span data-ttu-id="b168c-105">因此，配接器需要某種機制，將回呼繫結至配接器中的某個狀態，這樣才能夠收到成功或失敗的通知，並執行任何必要的清理動作。</span><span class="sxs-lookup"><span data-stu-id="b168c-105">Therefore the adapter needs a mechanism to tie a callback to some state in the adapter so it can be notified of success or failure and perform any necessary cleanup actions.</span></span> <span data-ttu-id="b168c-106">回呼語意相當有彈性，因此配接器可以使用三個方法中的其中一種或任意組合。</span><span class="sxs-lookup"><span data-stu-id="b168c-106">The callback semantics are flexible such that adapters can use one or a combination of three approaches.</span></span> <span data-ttu-id="b168c-107">它們是：</span><span class="sxs-lookup"><span data-stu-id="b168c-107">These are:</span></span>  
  
- <span data-ttu-id="b168c-108">實作的相同物件執行個體上進行所有的回呼**IBTBatchCallBack**。</span><span class="sxs-lookup"><span data-stu-id="b168c-108">All callbacks are made on the same object instance that implements **IBTBatchCallBack**.</span></span>  
  
- <span data-ttu-id="b168c-109">使用要求新批次時傳遞到引擎中的 Cookie，使回呼與配接器中的狀態產生相互關聯。</span><span class="sxs-lookup"><span data-stu-id="b168c-109">The cookie passed into the engine when requesting a new batch is used to correlate the callback to the state in the adapters.</span></span>  
  
- <span data-ttu-id="b168c-110">不同的回呼物件會實作每個批次**IBTBatchCallBack**。</span><span class="sxs-lookup"><span data-stu-id="b168c-110">There is a different callback object for each batch that implements **IBTBatchCallBack**.</span></span> <span data-ttu-id="b168c-111">這裡的每個物件都具有本身的私用狀態。</span><span class="sxs-lookup"><span data-stu-id="b168c-111">Here each object holds its own private state.</span></span>  
  
  <span data-ttu-id="b168c-112">配接器時處理批次會回撥的實作**IBTBatchCallBack.BatchComplete**。</span><span class="sxs-lookup"><span data-stu-id="b168c-112">When the batch has been processed, the adapter is called back on its implementation of **IBTBatchCallBack.BatchComplete**.</span></span> <span data-ttu-id="b168c-113">批次的整體狀態由第一個參數 HRESULT 狀態顯示出來。</span><span class="sxs-lookup"><span data-stu-id="b168c-113">The overall status of the batch is indicated by the first parameter, the HRESULT status.</span></span> <span data-ttu-id="b168c-114">如果這個值大於或等於零，即表示批次已成功，因為引擎具有資料的擁有權，而配接器可以自由地從連線上刪除該項資料。</span><span class="sxs-lookup"><span data-stu-id="b168c-114">If this value is greater than or equal to zero, then the batch was successful in the sense that the engine has ownership of the data and the adapter is free to delete that data from the wire.</span></span> <span data-ttu-id="b168c-115">負數的狀態表示批次失敗：批次中沒有任何作業成功，而配接器將負責處理失敗。</span><span class="sxs-lookup"><span data-stu-id="b168c-115">A negative status indicates that the batch failed: None of the operations in the batch were successful and the adapter is responsible for handling the failure.</span></span>  
  
  <span data-ttu-id="b168c-116">如果批次失敗，配接器就必須知道是哪一項作業的哪一個項目失敗。</span><span class="sxs-lookup"><span data-stu-id="b168c-116">If the batch failed, then the adapter needs to know which item in which operation failed.</span></span> <span data-ttu-id="b168c-117">例如，假設配接器從磁碟讀取了 20 個檔案，並使用單一批次將它們提交到 [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)] 中。</span><span class="sxs-lookup"><span data-stu-id="b168c-117">For example, suppose that the adapter was reading 20 files from disk and submitting them into [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)] using a single batch.</span></span> <span data-ttu-id="b168c-118">如果第十個檔案已損毀，配接器需要擱置這一個檔案，然後重新提交剩下的 19。</span><span class="sxs-lookup"><span data-stu-id="b168c-118">If the tenth file was corrupted, the adapter would need to suspend that one file and resubmit the remaining 19.</span></span> <span data-ttu-id="b168c-119">這項資訊可供第二個和第三個參數中的配接器 —`opCount` （作業計數） 的簡短的型別和`operationStatus`，類型 BTBatchOperationStatus []。</span><span class="sxs-lookup"><span data-stu-id="b168c-119">This information is available to the adapter in the second and third parameters—`opCount` (operation count) of type short and `operationStatus`, which is of type BTBatchOperationStatus[].</span></span>  
  
> [!NOTE]
>  <span data-ttu-id="b168c-120">對於單一批次物件，您絕對不要提交訊息一次以上。</span><span class="sxs-lookup"><span data-stu-id="b168c-120">On a single batch object you should never submit a message more than once.</span></span> <span data-ttu-id="b168c-121">在同一批次上多次提交相同訊息物件會導致引擎錯誤。</span><span class="sxs-lookup"><span data-stu-id="b168c-121">Submitting the same message object more than once on the same batch will result in engine errors.</span></span>  
  
 <span data-ttu-id="b168c-122">作業計數會指出多少種作業都在批次 (的大小**BTBatchOperationStatus**陣列)。</span><span class="sxs-lookup"><span data-stu-id="b168c-122">The operation count indicates how many types of operations were in the batch (the size of the **BTBatchOperationStatus** array).</span></span> <span data-ttu-id="b168c-123">作業狀態陣列中的每個元素會對應至指定的作業類型。</span><span class="sxs-lookup"><span data-stu-id="b168c-123">Each element in the operation status array corresponds to a given operation type.</span></span> <span data-ttu-id="b168c-124">藉由使用**BTBatchOperationStatus**陣列中，配接器可以判斷哪一個項目中指定的作業失敗，查看**BTBatchOperationStatus.MessageStatus**負數 HRESULT 的陣列表示失敗的值。</span><span class="sxs-lookup"><span data-stu-id="b168c-124">By using the **BTBatchOperationStatus** array, the adapter can determine which item in a given operation failed by looking at the **BTBatchOperationStatus.MessageStatus** array for negative HRESULT values signifying failure.</span></span> <span data-ttu-id="b168c-125">在上面的實例中，配接器會建立一個新批次，其中包含 19 個訊息提交和 1 個訊息擱置。</span><span class="sxs-lookup"><span data-stu-id="b168c-125">In the scenario above, the adapter creates a new batch containing 19 message submits and one message suspend.</span></span>  
  
 <span data-ttu-id="b168c-126">下列程式碼片段顯示配接器如何透過傳輸 Proxy 向引擎要求新批次，並使用 Cookie 的方式提交單一訊息到引擎中。</span><span class="sxs-lookup"><span data-stu-id="b168c-126">The following code fragment shows how an adapter requests a new batch from the engine through its transport proxy and submits a single message into the engine using the cookie approach.</span></span> <span data-ttu-id="b168c-127">傳訊引擎會呼叫**BatchComplete**為已完成處理整個批次的批次回呼方法提交訊息。</span><span class="sxs-lookup"><span data-stu-id="b168c-127">The Messaging Engine calls the **BatchComplete** method as the batch callback when it has completed processing the entire batch of submitted messages.</span></span>  
  
```  
using Microsoft.BizTalk.TransportProxy.Interop;  
using Microsoft.BizTalk.Message.Interop;  
  
public class MyAdapter :   
                  IBTTransport,   
                  IBTTransportConfig,   
                  IBTTransportControl,  
                  IPersistPropertyBag,   
                  IBaseComponent,  
                  IBTBatchCallBack  
{  
      private IBTTransportProxy _tp;  
  
      public void BatchComplete(      
            Int32                         status,   
            Int16                         opCount,   
            BTBatchOperationStatus[]      operationStatus,   
            System.Object                 callbackCookie)  
      {  
            // Use cookie to correlate callback with work done,  
            // in this example the batch is to submit a single  
            // file the name of which will be in the  
            // callbackCookie  
            string fileName = (string)callbackCookie;  
            if ( status >= 0 )  
                  // DeleteFile from disc  
                  File.Delete(fileName);          
            else  
                  // Rename file to fileName.bad  
                  File.Move(fileName, fileName + ".bad");  
      }  
  
      private void SubmitMessage(  
            IBaseMessage                  msg,   
            string                        fileName)  
      {  
            // Note: Pass in the filename as the cookie  
            IBTTransportBatch batch =   
                  _tp.GetBatch(this, (object)fileName);  
  
            // Add msg to batch for submitting   
            batch.SubmitMessage(msg);   
  
            // Process this batch  
            batch.Done(null);  
      }  
}  
```  
  
 <span data-ttu-id="b168c-128">[!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)] SDK 包含下列配接器的範例：FILE、HTTP、MSMQ 和交易式配接器。</span><span class="sxs-lookup"><span data-stu-id="b168c-128">The [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)] SDK includes samples for the following adapters: File, HTTP, MSMQ, and the Transactional Adapter.</span></span> <span data-ttu-id="b168c-129">這些配接器全都是建立一個通用建置組塊上，稱為 BaseAdapter。</span><span class="sxs-lookup"><span data-stu-id="b168c-129">All of these adapters are built on top of a common building block called the BaseAdapter.</span></span> <span data-ttu-id="b168c-130">BaseAdapter 的 1.0.1 版包含所有相關的程式碼，可用來剖析作業狀態和重建新批次以進行提交。</span><span class="sxs-lookup"><span data-stu-id="b168c-130">Version 1.0.1 of the BaseAdapter includes all of the relevant code to parse the operation status and rebuild a new batch to submit.</span></span>  
  
## <a name="race-condition"></a><span data-ttu-id="b168c-131">競爭情形</span><span class="sxs-lookup"><span data-stu-id="b168c-131">Race Condition</span></span>  
 <span data-ttu-id="b168c-132">解決錯誤以及決定提交批次最後結果的這兩項工作，似乎相當簡單，但事實上它們需要依賴來自不同執行緒的資訊：</span><span class="sxs-lookup"><span data-stu-id="b168c-132">The two tasks of resolving errors and deciding the final outcome of a submitted batch seem simple enough, but in fact they rely on information from different threads:</span></span>  
  
- <span data-ttu-id="b168c-133">配接器處理所傳遞的資訊為基礎的錯誤[!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)]配接器**BatchComplete**回呼方法。</span><span class="sxs-lookup"><span data-stu-id="b168c-133">The adapter processes errors based on information passed by [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)] to the adapter's **BatchComplete** callback method.</span></span> <span data-ttu-id="b168c-134">這個回呼會在配接器的執行緒上執行。</span><span class="sxs-lookup"><span data-stu-id="b168c-134">This callback executes on the adapter's thread.</span></span>  
  
- <span data-ttu-id="b168c-135">**DTCCommitConfirm**是一種方法，在**IBTDTCCommitConfirm**物件。</span><span class="sxs-lookup"><span data-stu-id="b168c-135">**DTCCommitConfirm** is a method on the **IBTDTCCommitConfirm** object.</span></span> <span data-ttu-id="b168c-136">執行個體**IBTDTCCommitConfirm**批次所傳回物件**ibttransportbatch:: Done**呼叫。</span><span class="sxs-lookup"><span data-stu-id="b168c-136">An instance of the **IBTDTCCommitConfirm** object is returned by the batch **IBTTransportBatch::Done** call.</span></span> <span data-ttu-id="b168c-137">這個執行個體位於相同的執行緒**ibttransportbatch:: Done**呼叫時，配接器的回呼執行緒不同。</span><span class="sxs-lookup"><span data-stu-id="b168c-137">This instance is on the same thread as the **IBTTransportBatch::Done** call, which is different from the adapter's callback thread.</span></span>  
  
  <span data-ttu-id="b168c-138">每個呼叫的配接器對**ibttransportbatch:: Done**傳訊引擎會回呼方法的對應呼叫**BatchComplete**在個別的執行緒，報告的結果提交批次。</span><span class="sxs-lookup"><span data-stu-id="b168c-138">For every call that the adapter makes to **IBTTransportBatch::Done** the Messaging Engine makes a corresponding call to the callback method **BatchComplete** in a separate thread to report the result of the batch submission.</span></span> <span data-ttu-id="b168c-139">在  **BatchComplete**配接器必須認可或回復交易根據批次成功或失敗。</span><span class="sxs-lookup"><span data-stu-id="b168c-139">In **BatchComplete** the adapter needs to commit or roll back the transaction based on whether the batch passed or failed.</span></span> <span data-ttu-id="b168c-140">在任一情況下，配接器應該都會接著呼叫**DTCCommitConfirm**報告交易的狀態。</span><span class="sxs-lookup"><span data-stu-id="b168c-140">In either case, the adapter should then call **DTCCommitConfirm** to report the status of the transaction.</span></span>  
  
  <span data-ttu-id="b168c-141">可能的競爭條件存在，是因為配接器的實作**BatchComplete**可能會假設**IBTDTCCommitConfirm**所傳回的物件**ibttransportbatch:: Done**時，一律可用**BatchComplete**執行。</span><span class="sxs-lookup"><span data-stu-id="b168c-141">A possible race condition exists because the adapter’s implementation of **BatchComplete** can assume that the **IBTDTCCommitConfirm** object returned by **IBTTransportBatch::Done** is always available when **BatchComplete** executes.</span></span> <span data-ttu-id="b168c-142">不過， **BatchComplete**可以呼叫個別的傳訊引擎執行緒中，甚至**ibttransportbatch:: Done**傳回。</span><span class="sxs-lookup"><span data-stu-id="b168c-142">However, **BatchComplete** can be called in a separate Messaging Engine thread, even before **IBTTransportBatch::Done** returns.</span></span> <span data-ttu-id="b168c-143">可能的配接器嘗試存取**IBTDTCCommitConfirm**物件做為一部分**BatchComplete**實作中，會發生存取違規，因為該呼叫的執行緒不會再存在。</span><span class="sxs-lookup"><span data-stu-id="b168c-143">It is possible that when the adapter tries to access the **IBTDTCCommitConfirm** object as a part of the **BatchComplete** implementation, there is an access violation because that calling thread no longer exists.</span></span> <span data-ttu-id="b168c-144">請使用下列解決方法來避免這個情形。</span><span class="sxs-lookup"><span data-stu-id="b168c-144">Use the following solution to avoid this condition.</span></span>  
  
  <span data-ttu-id="b168c-145">在下列範例中，將使用事件來解決問題。</span><span class="sxs-lookup"><span data-stu-id="b168c-145">In the following example, the problem is solved by using an event.</span></span> <span data-ttu-id="b168c-146">這裡會使用事件的屬性來存取介面指標。</span><span class="sxs-lookup"><span data-stu-id="b168c-146">Here the interface pointer is accessed through a property that uses the event.</span></span> <span data-ttu-id="b168c-147">Get 方法永遠會等到 Set 方法完成後才繼續。</span><span class="sxs-lookup"><span data-stu-id="b168c-147">The get always waits for the set to complete before proceeding.</span></span>  
  
```  
protected IBTDTCCommitConfirm CommitConfirm  
{  
      set  
      {  
            this.commitConfirm = value;  
            this.commitConfirmEvent.Set();  
      }  
      get  
      {  
            this.commitConfirmEvent.WaitOne();  
            return this.commitConfirm;  
      }  
}  
protected IBTDTCCommitConfirm commitConfirm = null;  
private ManualResetEvent commitConfirmEvent = new ManualResetEvent(false);  
```  
  
## <a name="batch-status-codes"></a><span data-ttu-id="b168c-148">批次狀態碼</span><span class="sxs-lookup"><span data-stu-id="b168c-148">Batch Status Codes</span></span>  
 <span data-ttu-id="b168c-149">整體批次狀態碼會指出批次處理的結果。</span><span class="sxs-lookup"><span data-stu-id="b168c-149">The overall batch status code indicates the outcome of the batch.</span></span> <span data-ttu-id="b168c-150">作業狀態會提供提交狀態碼給個別訊息項目。</span><span class="sxs-lookup"><span data-stu-id="b168c-150">The operation status gives the submission status code for individual message items.</span></span> <span data-ttu-id="b168c-151">批次失敗的原因有很多種。</span><span class="sxs-lookup"><span data-stu-id="b168c-151">Batches can fail for various reasons.</span></span> <span data-ttu-id="b168c-152">可能是發生有關安全性的失敗，或是當提交訊息時，引擎正在關閉</span><span class="sxs-lookup"><span data-stu-id="b168c-152">There might be a security-related failure, or the message might have been submitted when the engine was shutting down.</span></span> <span data-ttu-id="b168c-153">(引擎關閉時通常不會接受任何新工作，但是會允許正在進行中的工作完成)。下表顯示批次狀態或作業狀態傳回的一些常見 HRESULT 值。</span><span class="sxs-lookup"><span data-stu-id="b168c-153">(Typically when the engine shuts down it does not accept any new work but does allow in-process work to be completed.) The following table indicates some common HRESULT values that are returned either in the batch status or the operation status.</span></span> <span data-ttu-id="b168c-154">同時也會指出這些值是成功碼，還是失敗碼。</span><span class="sxs-lookup"><span data-stu-id="b168c-154">It also indicates whether these are success or failure codes.</span></span> <span data-ttu-id="b168c-155">正確處理這些程式碼所述進行完全[如何處理配接器失敗](../core/how-to-handle-adapter-failures.md)。</span><span class="sxs-lookup"><span data-stu-id="b168c-155">The proper handling of these codes is described more fully in [How to Handle Adapter Failures](../core/how-to-handle-adapter-failures.md).</span></span>  
  
|<span data-ttu-id="b168c-156">代碼 (在類別 BTTransportProxy 中定義)</span><span class="sxs-lookup"><span data-stu-id="b168c-156">Code (defined in the class BTTransportProxy)</span></span>|<span data-ttu-id="b168c-157">成功/失敗碼</span><span class="sxs-lookup"><span data-stu-id="b168c-157">Success/failure code</span></span>|<span data-ttu-id="b168c-158">描述</span><span class="sxs-lookup"><span data-stu-id="b168c-158">Description</span></span>|  
|----------------------------------------------------|---------------------------|-----------------|  
|<span data-ttu-id="b168c-159">BTS_S_EPM_SECURITY_CHECK_FAILED</span><span class="sxs-lookup"><span data-stu-id="b168c-159">BTS_S_EPM_SECURITY_CHECK_FAILED</span></span>|<span data-ttu-id="b168c-160">成功</span><span class="sxs-lookup"><span data-stu-id="b168c-160">Success</span></span>|<span data-ttu-id="b168c-161">連接埠已設定為執行安全性檢查，並捨棄驗證失敗的訊息。</span><span class="sxs-lookup"><span data-stu-id="b168c-161">The port was configured to perform a security check and drop messages that failed authentication.</span></span> <span data-ttu-id="b168c-162">配接器不會擱置傳回這個狀態碼的批次。</span><span class="sxs-lookup"><span data-stu-id="b168c-162">Adapters should not suspend batches that return this status code.</span></span>|  
|<span data-ttu-id="b168c-163">BTS_S_EPM_MESSAGE_SUSPENDED</span><span class="sxs-lookup"><span data-stu-id="b168c-163">BTS_S_EPM_MESSAGE_SUSPENDED</span></span>|<span data-ttu-id="b168c-164">成功</span><span class="sxs-lookup"><span data-stu-id="b168c-164">Success</span></span>|<span data-ttu-id="b168c-165">表示有一則或多則訊息被擱置，而引擎具有資料的擁有權。</span><span class="sxs-lookup"><span data-stu-id="b168c-165">Indicates that one or more messages were suspended, and the engine has ownership of the data.</span></span> <span data-ttu-id="b168c-166">這是成功碼，因為傳訊引擎已經接受訊息提交。</span><span class="sxs-lookup"><span data-stu-id="b168c-166">It is a success code in that the Messaging Engine has accepted the message submission.</span></span>|  
|<span data-ttu-id="b168c-167">E_BTS_URL_DISALLOWED</span><span class="sxs-lookup"><span data-stu-id="b168c-167">E_BTS_URL_DISALLOWED</span></span>|<span data-ttu-id="b168c-168">失敗</span><span class="sxs-lookup"><span data-stu-id="b168c-168">Failure</span></span>|<span data-ttu-id="b168c-169">訊息已提交具有無效**InboundTransportLocation**。</span><span class="sxs-lookup"><span data-stu-id="b168c-169">A message was submitted with an invalid **InboundTransportLocation**.</span></span>|  
  
## <a name="batch-operations"></a><span data-ttu-id="b168c-170">批次作業</span><span class="sxs-lookup"><span data-stu-id="b168c-170">Batch Operations</span></span>  
 <span data-ttu-id="b168c-171">下表詳細說明的成員方法和作業**IBTTransportBatch**物件配接器用來將物件加入至指定的批次。</span><span class="sxs-lookup"><span data-stu-id="b168c-171">The following table details the member methods and operations of the **IBTTransportBatch** object that the adapter uses to add work to a given batch.</span></span>  
  
|<span data-ttu-id="b168c-172">方法名稱</span><span class="sxs-lookup"><span data-stu-id="b168c-172">Method name</span></span>|<span data-ttu-id="b168c-173">作業類型</span><span class="sxs-lookup"><span data-stu-id="b168c-173">Operation type</span></span>|<span data-ttu-id="b168c-174">描述</span><span class="sxs-lookup"><span data-stu-id="b168c-174">Description</span></span>|  
|-----------------|--------------------|-----------------|  
|<span data-ttu-id="b168c-175">**SubmitMessage**</span><span class="sxs-lookup"><span data-stu-id="b168c-175">**SubmitMessage**</span></span>|<span data-ttu-id="b168c-176">提交</span><span class="sxs-lookup"><span data-stu-id="b168c-176">Submit</span></span>|<span data-ttu-id="b168c-177">將訊息提交到引擎中。</span><span class="sxs-lookup"><span data-stu-id="b168c-177">Submits a message into the engine.</span></span>|  
|<span data-ttu-id="b168c-178">**SubmitResponseMessage**</span><span class="sxs-lookup"><span data-stu-id="b168c-178">**SubmitResponseMessage**</span></span>|<span data-ttu-id="b168c-179">提交</span><span class="sxs-lookup"><span data-stu-id="b168c-179">Submit</span></span>|<span data-ttu-id="b168c-180">將回應訊息提交到引擎中。</span><span class="sxs-lookup"><span data-stu-id="b168c-180">Submits a response message into the engine.</span></span> <span data-ttu-id="b168c-181">這是成對的「請求-回應」中的回應訊息。</span><span class="sxs-lookup"><span data-stu-id="b168c-181">This is the response message in a solicit-response pair.</span></span>|  
|<span data-ttu-id="b168c-182">**DeleteMessage**</span><span class="sxs-lookup"><span data-stu-id="b168c-182">**DeleteMessage**</span></span>|<span data-ttu-id="b168c-183">DELETE</span><span class="sxs-lookup"><span data-stu-id="b168c-183">Delete</span></span>|<span data-ttu-id="b168c-184">刪除因為配接器使用非封鎖傳送方式透過連線成功傳輸而產生的訊息。</span><span class="sxs-lookup"><span data-stu-id="b168c-184">Deletes a message that an adapter has successfully transmitted over the wire using a non-blocking send.</span></span> <span data-ttu-id="b168c-185">使用封鎖傳送配接器不需要呼叫這個方法，因為傳訊引擎會執行刪除代替配接器的配接器會傳回`true`從**TransmitMesssage**。</span><span class="sxs-lookup"><span data-stu-id="b168c-185">Adapters that use blocking sends do not need to call this method because the Messaging Engine will delete it on the adapter's behalf if the adapter returns `true` from **TransmitMesssage**.</span></span>|  
|<span data-ttu-id="b168c-186">**MoveToSuspendQ**</span><span class="sxs-lookup"><span data-stu-id="b168c-186">**MoveToSuspendQ**</span></span>|<span data-ttu-id="b168c-187">MoveToSuspendQ</span><span class="sxs-lookup"><span data-stu-id="b168c-187">MoveToSuspendQ</span></span>|<span data-ttu-id="b168c-188">將訊息移到訊息擱置佇列中。</span><span class="sxs-lookup"><span data-stu-id="b168c-188">Moves a message into the Suspended queue.</span></span>|  
|<span data-ttu-id="b168c-189">**重新提交**</span><span class="sxs-lookup"><span data-stu-id="b168c-189">**Resubmit**</span></span>|<span data-ttu-id="b168c-190">Resubmit</span><span class="sxs-lookup"><span data-stu-id="b168c-190">Resubmit</span></span>|<span data-ttu-id="b168c-191">要求稍後重新嘗試傳送訊息。</span><span class="sxs-lookup"><span data-stu-id="b168c-191">Requests that a message should be retried for transmission at a later time.</span></span> <span data-ttu-id="b168c-192">這通常會在傳輸嘗試失敗之後被呼叫。</span><span class="sxs-lookup"><span data-stu-id="b168c-192">This is typically called after a transmission attempt has failed.</span></span>|  
|<span data-ttu-id="b168c-193">**MoveToNextTransport**</span><span class="sxs-lookup"><span data-stu-id="b168c-193">**MoveToNextTransport**</span></span>|<span data-ttu-id="b168c-194">MoveToNextTransport</span><span class="sxs-lookup"><span data-stu-id="b168c-194">MoveToNextTransport</span></span>|<span data-ttu-id="b168c-195">要求使用其備份傳輸來傳送訊息。</span><span class="sxs-lookup"><span data-stu-id="b168c-195">Requests that a message be transmitted using its backup transport.</span></span> <span data-ttu-id="b168c-196">這通常會在用盡所有嘗試次數而仍失敗之後被呼叫。</span><span class="sxs-lookup"><span data-stu-id="b168c-196">Typically called after all retries have been exhausted.</span></span> <span data-ttu-id="b168c-197">如果沒有備份傳輸，這個方法將會失敗</span><span class="sxs-lookup"><span data-stu-id="b168c-197">If no backup transport is present this method will fail</span></span>|  
|<span data-ttu-id="b168c-198">**SubmitRequestMessage**</span><span class="sxs-lookup"><span data-stu-id="b168c-198">**SubmitRequestMessage**</span></span>|<span data-ttu-id="b168c-199">SubmitRequest</span><span class="sxs-lookup"><span data-stu-id="b168c-199">SubmitRequest</span></span>|<span data-ttu-id="b168c-200">提交要求訊息。</span><span class="sxs-lookup"><span data-stu-id="b168c-200">Submits a request message.</span></span> <span data-ttu-id="b168c-201">這是成對的「要求-回應」中的要求訊息。</span><span class="sxs-lookup"><span data-stu-id="b168c-201">This is a request message in a request-response pair.</span></span>|  
|<span data-ttu-id="b168c-202">**CancelRequestForResponse**</span><span class="sxs-lookup"><span data-stu-id="b168c-202">**CancelRequestForResponse**</span></span>|<span data-ttu-id="b168c-203">CancelRequestForResponse</span><span class="sxs-lookup"><span data-stu-id="b168c-203">CancelRequestForResponse</span></span>|<span data-ttu-id="b168c-204">通知引擎：配接器已經不再等待成對的「要求-回應」中的回應訊息。</span><span class="sxs-lookup"><span data-stu-id="b168c-204">Notifies the engine that the adapter no longer wishes to wait for the response message in a request-response pair.</span></span>|  
|<span data-ttu-id="b168c-205">**Clear**</span><span class="sxs-lookup"><span data-stu-id="b168c-205">**Clear**</span></span>|<span data-ttu-id="b168c-206">NA</span><span class="sxs-lookup"><span data-stu-id="b168c-206">NA</span></span>|<span data-ttu-id="b168c-207">從批次清除所有工作。</span><span class="sxs-lookup"><span data-stu-id="b168c-207">Clears all work from the batch.</span></span>|  
|<span data-ttu-id="b168c-208">**完成**</span><span class="sxs-lookup"><span data-stu-id="b168c-208">**Done**</span></span>|<span data-ttu-id="b168c-209">NA</span><span class="sxs-lookup"><span data-stu-id="b168c-209">NA</span></span>|<span data-ttu-id="b168c-210">將訊息批次提交給引擎進行處理。</span><span class="sxs-lookup"><span data-stu-id="b168c-210">Submits a batch of messages to the engine for processing.</span></span>|  
  
## <a name="batch-management"></a><span data-ttu-id="b168c-211">批次管理</span><span class="sxs-lookup"><span data-stu-id="b168c-211">Batch Management</span></span>  
 <span data-ttu-id="b168c-212">批次是在傳訊引擎中以原生程式碼來實作的。</span><span class="sxs-lookup"><span data-stu-id="b168c-212">Batches are implemented in native code in the Messaging Engine.</span></span> <span data-ttu-id="b168c-213">因此，以 Managed 程式碼撰寫的配接器應該在完成批次後，為批次發佈執行階段可呼叫包裝函式 (RCW)。</span><span class="sxs-lookup"><span data-stu-id="b168c-213">For this reason an adapter written in managed code should release the runtime callable wrapper (RCW) for the batch after it has finished with the batch.</span></span> <span data-ttu-id="b168c-214">這是由 managed 程式碼中使用**Marshal.ReleaseComObject** API。</span><span class="sxs-lookup"><span data-stu-id="b168c-214">This is done in managed code by using the **Marshal.ReleaseComObject** API.</span></span> <span data-ttu-id="b168c-215">請務必記得要在 while 迴圈中呼叫這個 API，直到傳回的參考計數到達零為止。</span><span class="sxs-lookup"><span data-stu-id="b168c-215">It is important to remember that this API should be called in a while loop until the returned reference count reaches zero.</span></span>  
  
 [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)]<span data-ttu-id="b168c-216"> 會在同步處理同一批次中的訊息。</span><span class="sxs-lookup"><span data-stu-id="b168c-216"> processes messages synchronously within a batch.</span></span> <span data-ttu-id="b168c-217">您可以並行處理許多批次，如此可以藉由調整應用程式定義域中的批次大小，在配接器中進行一些最佳化工作。</span><span class="sxs-lookup"><span data-stu-id="b168c-217">Many batches may be processed concurrently, which may provide an opportunity for some optimization in the adapter by adjusting the batch size in the application domain.</span></span> <span data-ttu-id="b168c-218">例如，您可以處理 FTP 網站上的所有檔案 (直到達到某個限制為止)。</span><span class="sxs-lookup"><span data-stu-id="b168c-218">For example, you might process all the files on an FTP site (until some limit is hit).</span></span> <span data-ttu-id="b168c-219">在 SAP 的情況下，您可以將單一資料流處理成一些接下來會以批次方式提交的訊息。</span><span class="sxs-lookup"><span data-stu-id="b168c-219">In the case of SAP you might process a single stream into a number of messages that are then submitted as a batch.</span></span>  
  
 <span data-ttu-id="b168c-220">配接器使用來將作業傳遞回 [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)] 的批次，並不需要完全對應 [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)] 提供給配接器的訊息清單。</span><span class="sxs-lookup"><span data-stu-id="b168c-220">The batch used by an adapter to pass operations back to [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)] does not need to exactly correspond to the list of messages that [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)] gives to the adapter.</span></span> <span data-ttu-id="b168c-221">換句話說，執行交易傳送時您必須將分割重新提交作業**MoveToNextTransport**並**MoveToSuspendQ**成個別的批次。</span><span class="sxs-lookup"><span data-stu-id="b168c-221">In other words, when doing transactional sends you must split the resubmit operations **MoveToNextTransport** and **MoveToSuspendQ** into separate batches.</span></span> <span data-ttu-id="b168c-222">許多配接器會將已經提交給多個結束點的訊息批次區分為不同的訊息清單，以作進一步處理。</span><span class="sxs-lookup"><span data-stu-id="b168c-222">Many adapters sort a batch of messages that have been submitted for multiple endpoints into separate lists of messages for further processing.</span></span>  
  
 <span data-ttu-id="b168c-223">要注意的是，在 [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)] 中，並沒有與訊息批次處理相關的規則 (除了與交易關聯的規則之外)。</span><span class="sxs-lookup"><span data-stu-id="b168c-223">The point is that there are no rules (besides those associated with the transaction) associated with message batching in [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)].</span></span> <span data-ttu-id="b168c-224">批次處理只是配接器用來將訊息劃分成進出 [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)] 之區塊的特定實作方式。</span><span class="sxs-lookup"><span data-stu-id="b168c-224">Batching is simply an implementation-specific way for the adapter to chunk messages into and out of [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)].</span></span>  
  
 <span data-ttu-id="b168c-225">配接器可以將 [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)] 提供的多個較小批次中的訊息，批次處理成較大批次以回應 [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)]。</span><span class="sxs-lookup"><span data-stu-id="b168c-225">An adapter can batch messages from multiple smaller batches that [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)] has given it into a larger batch for the response to [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)].</span></span> <span data-ttu-id="b168c-226">這在處理大量小型訊息的交易式配接器中，可能是一項重大的最佳化成果。</span><span class="sxs-lookup"><span data-stu-id="b168c-226">This might be a significant optimization in transactional adapters that are dealing with large numbers of very small messages.</span></span> <span data-ttu-id="b168c-227">它會將「每則訊息的交易總數」比率降至最低。</span><span class="sxs-lookup"><span data-stu-id="b168c-227">It minimizes the "total number of transactions per message" ratio.</span></span>  
  
 <span data-ttu-id="b168c-228">[!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)] 一般會產生介於 5 和 10 則訊息的傳送端批次。</span><span class="sxs-lookup"><span data-stu-id="b168c-228">Typically [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)] produces send-side batches of between 5 and 10 messages.</span></span> <span data-ttu-id="b168c-229">如果這些是非常小的訊息，配接器可能會批次最多 100 個訊息或多個之前它會將之刪除交易式批次提交回[!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)]。</span><span class="sxs-lookup"><span data-stu-id="b168c-229">If these are very small messages, an adapter might batch up to 100 messages or more before it submits a transactional batch of deletes back to [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)].</span></span> <span data-ttu-id="b168c-230">像這樣的最佳化並不容易實作；您必須確定訊息不會滯留於配接器記憶體中，無止境地等待達到某個閾值。</span><span class="sxs-lookup"><span data-stu-id="b168c-230">An optimization like this is not easy to implement; you must make sure that messages never get stuck in the adapter memory, waiting endlessly for some threshold to be met.</span></span>  
  
 <span data-ttu-id="b168c-231">像是 MQSeries 這類具有高處理能力的配接器，會在 [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)] 的批次處理上展現可觀的效能。</span><span class="sxs-lookup"><span data-stu-id="b168c-231">The significance of batching can be seen in the performance numbers for [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)] for the high-throughput adapters like MQSeries.</span></span> <span data-ttu-id="b168c-232">這些配接器是以至少為傳送頻率兩倍的頻率來接收訊息。</span><span class="sxs-lookup"><span data-stu-id="b168c-232">In these adapters, messages are received at least twice as often as they are sent.</span></span> <span data-ttu-id="b168c-233">根據預設，接收配接器會使用含有 100 則訊息的批次；傳送配接器會使用指定的預設 [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)] 批次。</span><span class="sxs-lookup"><span data-stu-id="b168c-233">By default the receive adapter uses batches of 100 messages and the send adapter uses the default [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)] batch it is given.</span></span>  
  
## <a name="transactional-batches"></a><span data-ttu-id="b168c-234">交易批次</span><span class="sxs-lookup"><span data-stu-id="b168c-234">Transactional Batches</span></span>  
 <span data-ttu-id="b168c-235">當您撰寫建立交易物件的配接器，並將它交付至 [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)] 時，您就有責任要撰寫執行以下工作的程式碼：</span><span class="sxs-lookup"><span data-stu-id="b168c-235">When you write an adapter that creates a transaction object and hands it to [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)], you are accepting responsibility for writing code that does the following:</span></span>  
  
- <span data-ttu-id="b168c-236">決定批次作業的最後結果：認可或結束交易。</span><span class="sxs-lookup"><span data-stu-id="b168c-236">Decides the final outcome of the batch operation: to either commit or end the transaction.</span></span> <span data-ttu-id="b168c-237">此結果可能取決於這個並非依存於 [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)] 之交易範圍內的其他交易分支，例如寫入訊息佇列 (MSMQ) 佇列或交易式資料庫作業。</span><span class="sxs-lookup"><span data-stu-id="b168c-237">This may depend upon other transactional branches within the scope of this one transaction that are not [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)] dependent, such as writing to an Message Queuing (MSMQ) queue or a transactional database operation.</span></span>  
  
- <span data-ttu-id="b168c-238">告知[!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)]的最後結果，藉由呼叫**IBTDTCCommitConfirm.DTCCommitConfirm**方法。</span><span class="sxs-lookup"><span data-stu-id="b168c-238">Informs [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)] of the final outcome by calling the **IBTDTCCommitConfirm.DTCCommitConfirm** method.</span></span> <span data-ttu-id="b168c-239">傳回 `true` 即表示成功認可交易；傳回 `false` 則代表交易失敗和回復。</span><span class="sxs-lookup"><span data-stu-id="b168c-239">Returning `true` indicates a successful commit of the transaction; returning `false` signifies failure and rollback of the transaction.</span></span>  
  
  <span data-ttu-id="b168c-240">配接器必須通知 [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)] 關於交易的最後結果，以維護其內部追蹤資料。</span><span class="sxs-lookup"><span data-stu-id="b168c-240">The adapter must inform [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)] about the final outcome of the transaction to maintain its internal tracking data.</span></span> <span data-ttu-id="b168c-241">配接器會[!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)]的呼叫結果**DTCCommitConfirm**。</span><span class="sxs-lookup"><span data-stu-id="b168c-241">The adapter informs [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)] of the outcome by calling **DTCCommitConfirm**.</span></span> <span data-ttu-id="b168c-242">如果配接器不這麼做，就會發生嚴重的記憶體遺漏，而且即使作業成功完成，MSDTC 交易還是會逾時並失敗。</span><span class="sxs-lookup"><span data-stu-id="b168c-242">If the adapter does not do this, a significant memory leak occurs and the MSDTC transaction could time out and fail despite its operations completing successfully.</span></span>