---
title: 如何識別 MessageBox Database2 中的瓶頸 |Microsoft 文件
ms.custom: ''
ms.date: 06/08/2017
ms.prod: biztalk-server
ms.reviewer: ''
ms.suite: ''
ms.tgt_pltfrm: ''
ms.topic: article
ms.assetid: 10b2eb1e-541c-457d-9735-ac6fb069b209
caps.latest.revision: 7
author: MandiOhlinger
ms.author: mandia
manager: anneta
ms.openlocfilehash: e69966f0f3ecff5a27788c9a92d4e3f1ac0eae68
ms.sourcegitcommit: cb908c540d8f1a692d01dc8f313e16cb4b4e696d
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 09/20/2017
ms.locfileid: "22254198"
---
# <a name="how-to-identify-bottlenecks-in-the-messagebox-database"></a><span data-ttu-id="f984d-102">如何識別 MessageBox 資料庫中的瓶頸</span><span class="sxs-lookup"><span data-stu-id="f984d-102">How to Identify Bottlenecks in the MessageBox Database</span></span>
<span data-ttu-id="f984d-103">若要識別 MessageBox 資料庫中的瓶頸，請先確認 SQL Server Agent 服務已啟動。</span><span class="sxs-lookup"><span data-stu-id="f984d-103">To identify bottlenecks in the MessageBox database, first ensure that the SQL-Server-Agent Service is started.</span></span> <span data-ttu-id="f984d-104">將服務的啟動狀態從「手動」變更為「自動」，如此一來，即使重新啟動伺服器，服務也會自動重新啟動。</span><span class="sxs-lookup"><span data-stu-id="f984d-104">Change the Service startup state from Manual to Auto so that even if the server is restarted, the service will automatically restart.</span></span>  
  
 <span data-ttu-id="f984d-105">根據預設，如果 Spool、TrackingData 或 ApplicationQ 資料表成長，BizTalk 服務就會減緩處理速度 (節流)。</span><span class="sxs-lookup"><span data-stu-id="f984d-105">By default the BizTalk service will throttle if the Spool, TrackingData or ApplicationQ tables grow.</span></span> <span data-ttu-id="f984d-106">SQL 代理程式工作會對這些資料表進行剪除；如果此項工作未執行，就會導致 Spool 成長，並促使節流開始作用，以保護資料庫不再接受額外的壓力。</span><span class="sxs-lookup"><span data-stu-id="f984d-106">These tables are pruned by SQL-Agent jobs, which, if not running will cause the Spool to grow causing throttling to kick in protecting the database from additional pressure.</span></span> <span data-ttu-id="f984d-107">請檢查下列效能計數器的狀態：</span><span class="sxs-lookup"><span data-stu-id="f984d-107">Check the status of the following performance counters:</span></span>  
  
-   <span data-ttu-id="f984d-108">BizTalk: 訊息代理程式 (主控件名稱) 訊息傳遞節流狀態</span><span class="sxs-lookup"><span data-stu-id="f984d-108">BizTalk:Message Agent (Host Name) Message Delivery Throttling State</span></span>  
  
-   <span data-ttu-id="f984d-109">BizTalk: 訊息代理程式 (主控件名稱) 訊息發佈節流狀態</span><span class="sxs-lookup"><span data-stu-id="f984d-109">BizTalk:Message Agent (Host Name) Message Publishing Throttling State</span></span>  
  
 <span data-ttu-id="f984d-110">0 的值表示沒有發生節流。</span><span class="sxs-lookup"><span data-stu-id="f984d-110">A value of 0 indicates no throttling is occurring.</span></span> <span data-ttu-id="f984d-111">6 的值表示因為資料庫成長，系統正在進行節流。</span><span class="sxs-lookup"><span data-stu-id="f984d-111">A value of 6 is indicative the system is throttling due to database growth.</span></span> <span data-ttu-id="f984d-112">如何解釋這些計數器的其他值，請參閱相關文件。</span><span class="sxs-lookup"><span data-stu-id="f984d-112">Please refer to the documentation on how to interpret other values of these counters.</span></span>  
  
## <a name="spool-table-growth"></a><span data-ttu-id="f984d-113">Spool 資料表成長</span><span class="sxs-lookup"><span data-stu-id="f984d-113">Spool Table Growth</span></span>  
 <span data-ttu-id="f984d-114">Spool 會開始成長，可能有多種原因。</span><span class="sxs-lookup"><span data-stu-id="f984d-114">The Spool can start growing for multiple reasons.</span></span> <span data-ttu-id="f984d-115">Spool 成長的其中一個原因，是應用程式佇列逐漸在成長。</span><span class="sxs-lookup"><span data-stu-id="f984d-115">One reason for Spool growth is if the application queues are growing.</span></span> <span data-ttu-id="f984d-116">這些佇列可能會因為下游瓶頸及/或資源爭用等因素而成長。</span><span class="sxs-lookup"><span data-stu-id="f984d-116">They could grow due to various reasons like downstream bottlenecks and/or resource contention.</span></span>  
  
 <span data-ttu-id="f984d-117">如果應用程式佇列小，而 Spool 仍然很大，請確認清除工作是否能應付成長速度。</span><span class="sxs-lookup"><span data-stu-id="f984d-117">If the application queues are small and the Spool is still large, verify that the purge jobs are keeping up.</span></span> <span data-ttu-id="f984d-118">確定 SQL Agent 服務正在執行，再檢查下列工作是否順利完成：</span><span class="sxs-lookup"><span data-stu-id="f984d-118">Ensure that the SQL-Agent Service is running and then verify that the following jobs are successfully completing:</span></span>  
  
-   <span data-ttu-id="f984d-119">MessageBox_Message_Cleanup_BizTalkMessageBoxDb</span><span class="sxs-lookup"><span data-stu-id="f984d-119">MessageBox_Message_Cleanup_BizTalkMessageBoxDb</span></span>  
  
-   <span data-ttu-id="f984d-120">MessageBox_Parts_Cleanup_BizTalkMessageBoxDb</span><span class="sxs-lookup"><span data-stu-id="f984d-120">MessageBox_Parts_Cleanup_BizTalkMessageBoxDb</span></span>  
  
 <span data-ttu-id="f984d-121">如果 MessageZeroSum 資料表很大，表示已經處理過訊息 (DeQueue 已成功完成，並從應用程式佇列資料表中刪除了資料)，並且在資料列加上標幟以待刪除。</span><span class="sxs-lookup"><span data-stu-id="f984d-121">If the MessageZeroSum table is large it indicates that the messages have been processed (DeQueue has successfully completed and deleted data from the Application Queue tables) and the rows have been flagged for deletion.</span></span> <span data-ttu-id="f984d-122">然而，清除工作無法趕上刪除資料的速度。</span><span class="sxs-lookup"><span data-stu-id="f984d-122">However, the purge jobs are unable to keep up with deleting the data.</span></span> <span data-ttu-id="f984d-123">其中一個原因是如果在 SQL Server 電腦發生嚴重的 CPU 爭用情況，影響的清除工作能夠跟上由於 CPU 資源用盡。</span><span class="sxs-lookup"><span data-stu-id="f984d-123">One reason for this is if the SQL-Server machine is experiencing severe CPU contention, impacting the ability of the purge jobs to keep up due to CPU starvation.</span></span>  
  
## <a name="application-queue-table-growth"></a><span data-ttu-id="f984d-124">應用程式佇列資料表成長</span><span class="sxs-lookup"><span data-stu-id="f984d-124">Application Queue Table Growth</span></span>  
 <span data-ttu-id="f984d-125">應用程式佇列會裝載在途轉換資料，這些資料一經處理，就會由 DeQueue 加以清除。</span><span class="sxs-lookup"><span data-stu-id="f984d-125">Application queues host in-flight transition data that, once processed, are cleaned up by DeQueue.</span></span>  
  
 <span data-ttu-id="f984d-126">在處理這些訊息之後，便可以清理 Spool (其中保存著這些資料列的參考)。</span><span class="sxs-lookup"><span data-stu-id="f984d-126">After these messages are processed the Spool (holding references to these rows) can be cleaned.</span></span>  
  
 <span data-ttu-id="f984d-127">例如，RxHostQ 將資料發行至協調流程 PxHostQ，後者又接著發行資料至傳送的 TxHostQ，它們各自參考 Spool 資料表中的一列。</span><span class="sxs-lookup"><span data-stu-id="f984d-127">For example, the RxHostQ publishes data to the orchestration PxHostQ which in turn publishes data to the sending TxHostQ each referencing a row in the Spool table.</span></span> <span data-ttu-id="f984d-128">透過系統成功處理特定 HostQ 的訊息之後，DeQueue 會刪除這些資料列。</span><span class="sxs-lookup"><span data-stu-id="f984d-128">After the messages for a particular HostQ have successfully processed through the system these rows are deleted by DeQueue.</span></span> <span data-ttu-id="f984d-129">在刪除這些資料列之後，清除工作便可以清除 Spool (不再由這些資料列參考)。</span><span class="sxs-lookup"><span data-stu-id="f984d-129">After these rows are deleted, the Spool (which is no longer referenced by these rows) can then be cleaned by the purge jobs.</span></span>  
  
 <span data-ttu-id="f984d-130">應用程式佇列成長，代表負責清空應用程式佇列的主控件執行個體無法跟上內送速率 (亦即，發佈至特定應用程式佇列之訊息傳遞速率)。</span><span class="sxs-lookup"><span data-stu-id="f984d-130">Application Queue growth indicates that the Host Instances responsible for draining the Application Queue are unable to keep up with the incoming rate, that is, the rate at which messages are being published to the particular application queue.</span></span>  
  
 <span data-ttu-id="f984d-131">例如，因為負責處理協調流程的伺服器受限於 CPU 能力，無法處理得更快，所以協調流程應用程式佇列 (PxHostQ) 可能會成長。</span><span class="sxs-lookup"><span data-stu-id="f984d-131">For example, the orchestration application queue (PxHostQ) may grow because the server responsible for processing orchestrations is CPU bound and unable to process any faster.</span></span> <span data-ttu-id="f984d-132">但是，如果接收伺服器很快，也可能會因為其發行速度快過協調流程伺服器所能處理的速度，而導致應用程式佇列成長。</span><span class="sxs-lookup"><span data-stu-id="f984d-132">However, if the receiving server is fast it may publish faster than what the orchestration server can process leading to the application queue growth.</span></span>  
  
 <span data-ttu-id="f984d-133">協調流程佇列成長的另一個原因，可能是記憶體爭用的關係；這種情況是記憶體中同時有許多長時間執行的協調流程執行個體一起具現化，造成記憶體壅塞，而間接促使節流縮小執行緒集區，直到記憶體壓力減緩為止。</span><span class="sxs-lookup"><span data-stu-id="f984d-133">Another reason for orchestration queue growth could be due to memory contention whereby numerous long running orchestration instances are all concurrently instantiated in memory, causing memory bloat indirectly causing throttling to shrink the thread pool until memory pressure is relieved.</span></span> <span data-ttu-id="f984d-134">傳送應用程式佇列可能成長的其中一個原因，是下游系統接收 (從 BizTalk 傳出的) 訊息的速度不夠快。</span><span class="sxs-lookup"><span data-stu-id="f984d-134">One reason why the send application queue may grow is if the downstream system is unable to receive (outgoing from BizTalk) messages fast enough.</span></span> <span data-ttu-id="f984d-135">如此，訊息就會繼續留在 BizTalk 系統內，造成應用程式佇列成長，最後也會促使節流開始降低接收速率，從而影響系統的整體輸送量。</span><span class="sxs-lookup"><span data-stu-id="f984d-135">Thus the messages will continue to reside within the BizTalk system causing Application queue growth which will ultimately cause throttling to kick in reducing the receiving rate impacting the overall throughput of the system.</span></span>  
  
## <a name="trackingdata-table-growth"></a><span data-ttu-id="f984d-136">TrackingData 資料表成長</span><span class="sxs-lookup"><span data-stu-id="f984d-136">TrackingData Table Growth</span></span>  
 <span data-ttu-id="f984d-137">MessageBox 資料庫中的 TrackingData 資料表是在其中攔截器寫入訊息和服務執行個體追蹤和 BAM 追蹤的追蹤資料的轉換資料表。</span><span class="sxs-lookup"><span data-stu-id="f984d-137">The TrackingData table in the MessageBox database is a transition table into which interceptors write tracking data for both message and service instance tracking and BAM tracking.</span></span> <span data-ttu-id="f984d-138">如果停用了追蹤，這個資料表應該是空的。</span><span class="sxs-lookup"><span data-stu-id="f984d-138">If tracking is disabled, this table should be empty.</span></span> <span data-ttu-id="f984d-139">預設會啟用管線和協調流程中輸入/輸出事件的追蹤中的訊息與服務執行個體。</span><span class="sxs-lookup"><span data-stu-id="f984d-139">By default message and service instance tracking is enabled for the pipelines and orchestrations In/Out events.</span></span>  
  
 <span data-ttu-id="f984d-140">如果已啟用訊息內文追蹤，請確定 MessageBox 伺服器 (亦即，「允許主控件追蹤」的主控件) 正在執行。</span><span class="sxs-lookup"><span data-stu-id="f984d-140">If Message Body Tracking is enabled, ensure that the MessageBox server (that is, the host with "allow host tracking") is running.</span></span> <span data-ttu-id="f984d-141">當它將資料由 MessageBox 資料庫中的 TrackingData 資料表移至 BizTalkDTADb 資料表時，將會減少瓶頸。</span><span class="sxs-lookup"><span data-stu-id="f984d-141">It will reduce a bottleneck as it moves data from TrackingData table in the MessageBox database to the BizTalkDTADb tables.</span></span>  
  
 <span data-ttu-id="f984d-142">您可啟用自訂的訊息和追蹤的服務執行個體，例如，在升級的屬性和訊息內文追蹤，追蹤的自訂事件。</span><span class="sxs-lookup"><span data-stu-id="f984d-142">It is possible to track custom events by enabling custom message and service instance  tracking, for example, on promoted properties and message body tracking.</span></span> <span data-ttu-id="f984d-143">除了追蹤資料，BAM 資料也會寫入到這個資料表。</span><span class="sxs-lookup"><span data-stu-id="f984d-143">In addition to tracking data, BAM data is also written to this table.</span></span> <span data-ttu-id="f984d-144">TDDS (已啟用追蹤的主控件) 必須負責將此資料從 MessageBox 資料庫移至 BizTalkDTADb 和 BAMPrimaryImport 資料庫，並在成功移動之後，刪除此資料。</span><span class="sxs-lookup"><span data-stu-id="f984d-144">It is the responsibility of TDDS (the host on which tracking is enabled) to move this data from the MessageBox database to the BizTalkDTADb and BAMPrimaryImport databases, and then once successfully moved, delete this data.</span></span> <span data-ttu-id="f984d-145">訊息內文追蹤資料是另外由 SQL 代理程式工作 TrackedMessages_Copy_BizTalkMsgBoxDb 來進行移動。</span><span class="sxs-lookup"><span data-stu-id="f984d-145">Message body tracking data is moved separately by a SQL-Agent job TrackedMessages_Copy_BizTalkMsgBoxDb.</span></span>  
  
 <span data-ttu-id="f984d-146">如果 TDDS 無法跟上攔截器將資料寫入 TrackingData 資料表的速率，則此資料表將會成長，促使節流開始作用，終究影響到持續性輸送量。</span><span class="sxs-lookup"><span data-stu-id="f984d-146">If TDDS is unable to keep up with the rate at which the interceptors are writing data to the TrackingData table, this table will grow, causing throttling to kick in, ultimately impacting sustainable throughput.</span></span> <span data-ttu-id="f984d-147">若要減輕這個問題，請確定至少有 1 個啟用追蹤的主控件正在執行。</span><span class="sxs-lookup"><span data-stu-id="f984d-147">To alleviate this problem, ensure that at least 1 host is running with tracking enabled.</span></span>  
  
 <span data-ttu-id="f984d-148">如果資料仍然在擴增，請檢查 BizTalkDTADb 資料庫，以確定資料庫未成長到無法控制的地步。</span><span class="sxs-lookup"><span data-stu-id="f984d-148">If the data still builds up, verify the BizTalkDTADb database to ensure that the database is not growing out of control.</span></span> <span data-ttu-id="f984d-149">確定封存和清除工作都在執行中，並且跟得上資料到達的速率。</span><span class="sxs-lookup"><span data-stu-id="f984d-149">Ensure that the archiving and purging job is running and is able to keep up with the rate at which data is arriving.</span></span>  
  
> [!NOTE]
>  <span data-ttu-id="f984d-150">BizTalkDTADb 資料表的資料必須已經封存，否則清除工作無法刪除其中的資料。</span><span class="sxs-lookup"><span data-stu-id="f984d-150">The purge job is unable to delete data from the BizTalkDTADb tables until this data has been archived.</span></span>  
  
 <span data-ttu-id="f984d-151">確認 TrackingData 資料表沒有一直在成長。</span><span class="sxs-lookup"><span data-stu-id="f984d-151">Verify that the TrackingData table is not growing.</span></span> <span data-ttu-id="f984d-152">確定至少有 1 個執行中的主控件執行個體啟用了追蹤功能 (TDDS)。</span><span class="sxs-lookup"><span data-stu-id="f984d-152">Ensure that at least 1 host instance that is running has tracking enabled (TDDS).</span></span> <span data-ttu-id="f984d-153">如果 BizTalkDTADb 資料庫已經成長得過大，可能對 TDDS 從 MessageBox 資料庫移動資料至 BizTalkDTADb 資料庫的能力產生不利影響。</span><span class="sxs-lookup"><span data-stu-id="f984d-153">If the BizTalkDTADb database has grown too large, it can have a negative impact on the ability of TDDS to move data from the MessageBox database to the BizTalkDTADb database.</span></span>  
  
 <span data-ttu-id="f984d-154">TrackingData 資料表成長會促使節流開始作用，從而影響執行階段持續性輸送量。</span><span class="sxs-lookup"><span data-stu-id="f984d-154">Growth in the TrackingData table can cause throttling to kick in, impacting sustainable runtime throughput.</span></span>