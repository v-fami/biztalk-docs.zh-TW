---
title: "BizTalk Server 如何實作主控件節流 |Microsoft 文件"
ms.custom: 
ms.date: 06/08/2017
ms.prod: biztalk-server
ms.reviewer: 
ms.suite: 
ms.tgt_pltfrm: 
ms.topic: article
helpviewer_keywords:
- host throttling, rate based throttling
- host throttling, outbound
- host throttling, algorithm
- host throttling, components
- host throttling, inbound
- host throttling, resource based throttling
- host throttling, user controlled throttling
- host throttling, strategies
ms.assetid: 46d3c3de-66b9-4c8a-8369-e68563fc9c40
caps.latest.revision: "27"
author: MandiOhlinger
ms.author: mandia
manager: anneta
ms.openlocfilehash: 1944b61f9710b02f4e6db18a38972849847c532e
ms.sourcegitcommit: cb908c540d8f1a692d01dc8f313e16cb4b4e696d
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 09/20/2017
---
# <a name="how-biztalk-server-implements-host-throttling"></a>BizTalk Server 如何實作主控件節流
[!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)] 主控件節流機制可持續監控節流狀況、計算節流狀況的嚴重性，然後根據計算的嚴重性逐步套用主控件節流。 節流機制會自行調整而且適用於大部分的預設組態選項[!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)]處理實例。 [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)]主控件節流會公開數個設定選項，可用來微調特定案例的節流。 如需變更這些組態選項的詳細資訊，請參閱[如何修改主控件設定](../core/how-to-modify-host-settings.md)。  
  
## <a name="components-of-the-host-throttling-algorithm"></a>主控件節流演算法的元件  
 [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)] 在套用主控件節流時會使用下列演算法：  
  
1.  持續監控下列參數，以查看其是否超過特定的閾值。 若參數值超過參數的閾值，則節流狀況就會存在。  
  
    -   使用中的記憶體數量 (全系統與主控件程序記憶體)。  
  
    -   已傳遞或已處理之內含式訊息的數目 (輸出節流的閾值)。  
  
    -   使用中的執行緒數目。  
  
    -   資料庫大小，以所有主控件之佇列表格中的項目個數及多工緩衝處理與追蹤表格中的項目個數來計量。  
  
    -   並行資料庫連線的數目。  
  
    -   訊息發佈 (輸入) 與傳遞或處理 (輸出) 的速率。  
  
2.  決定節流狀況的嚴重性。 節流狀況會以下列方式來區分嚴重性層級 (從最嚴重到最不嚴重)。  
  
    -   使用中的主控件程序記憶體超過閾值。  
  
    -   內含式訊息數目超過閾值。  
  
    -   使用中的執行緒計數超過閾值。  
  
    -   資料庫大小超過閾值。  
  
    -   所有其他節流狀況。  
  
3.  依節流狀況的嚴重性逐步套用節流。 當嚴重性層級增加時，可以更積極地套用節流。 漸進式節流可以下列方式來達成：  
  
    -   偵測到一或多個節流狀況並指派其嚴重性。  
  
    -   根據嚴重性層級最高的狀況發出實作節流的指示。 根據節流狀況，若此狀況持續存在，則各種執行緒集區的大小可能會減少，並藉由凍結執行中的協調流程來釋放記憶體。  
  
    -   根據訊息為輸入或輸出訊息，以決定要在發佈或處理訊息時套用延遲。 延遲期間會與節流狀況的嚴重性成正比，因此，層級較高的嚴重性節流狀況將比層級較低的嚴重性節流狀況初始化更長的節流期間。 透過狀況變更時的節流機制，這個延遲期間可在特定範圍內上下調整。 目前的延遲期間會透過公開**訊息傳遞延遲 （毫秒）**和**訊息發佈延遲 （毫秒）**與相關聯的效能計數器**biztalk： 訊息代理程式**效能物件類別。 這些效能物件計數器會記錄在主題[主控件節流效能計數器](../core/host-throttling-performance-counters.md)。  
  
    -   節流機制會繼續檢查節流狀況是否存在。 若節流狀況已移轉，則會解除封鎖已節流的訊息，並允許執行緒集區與其他資源在不受限制的模式下運作。 若系統繼續操作且沒有任何節流狀況，則延遲期間會大為降低。 若節流狀況持續存在，則延遲數量會漸增且與狀況的嚴重性成正比，而後續訊息會受到更高的延遲。  
  
    -   當延遲期間過後，就不再實作節流。  
  
## <a name="type-of-throttling-conditions"></a>節流狀況的類型  
 節流條件的三種主要類型： 速率型、 資源型和協調流程。  
  
1.  **根據速率的節流**分為兩類： 輸入 （已發佈） 和輸出 （已傳遞）：  
  
    -   對於輸入 （已發佈） 訊息，BizTalk Server 會調整的訊息如果**訊息發佈內送速率**主控件執行個體超過**訊息發佈外寄速率\***指定**速率增加因數 （百分比）**值。 **速率增加因數 （百分比）**參數是可在**訊息發佈節流設定** 對話方塊。 輸入訊息之根據速率的節流，主要是藉由在將訊息批次發佈至 MessageBox 資料庫之前引發延遲來完成。 不必採取其他動作，就能完成輸入訊息之根據速率的節流。  
  
    -   對於輸出 （已傳遞） 訊息，BizTalk Server 會調整訊息的傳遞如果**訊息傳遞內送速率**主控件執行個體超過**訊息傳遞外寄速率** \*指定**速率增加因數 （百分比）**值。 **速率增加因數 （百分比）**參數是可在**訊息處理節流設定** 對話方塊。 輸出訊息之根據速率的節流，主要是藉由在從記憶體中佇列移除訊息並將訊息傳遞至「結束點管理員」(EPM) 或協調流程引擎以進行處理之前，引發延遲來完成。 不必採取其他動作，就能完成輸出訊息之根據速率的節流。  
  
         如需速率增加因數及其他速率型節流值的詳細資訊，請參閱[如何修改速率型節流設定](../core/how-to-modify-rate-based-throttling-settings.md)。  
  
2.  **根據資源的節流**監視系統資源，例如執行緒、 記憶體和資料庫大小，並可套用至任何服務類別。 如需資源型節流值的詳細資訊，請參閱[如何修改資源基礎節流設定](../core/how-to-modify-resource-based-throttling-settings.md)。  
  
3.  **協調流程節流**可避免凍結以及需要暫停/繼續訂閱。 如需協調流程節流值的詳細資訊，請參閱[如何修改協調流程節流設定](../core/how-to-modify-orchestration-throttling-settings.md)。  
  
## <a name="throttling-condition-triggers-actions-and-mitigation-strategies"></a>節流狀況觸發程序、動作，以及移轉策略  
 本節描述各種節流狀況的觸發程序、節流機制所產生的動作，以及可用來移轉節流狀況的技術。  
  
### <a name="inbound-throttling"></a>輸入節流  
 BizTalk 節流機制會將輸入節流套用至協調流程引擎 (XLANG) 與輸入配接器。  
  
 使用**訊息發佈節流狀態**和**訊息發佈節流狀態持續時間**與相關聯的計數器**biztalk: Messageagent**效能物件類別，來計量目前的節流狀態與節流期間。 如需有關可用之主控件節流效能計數器的詳細資訊，請參閱[主控件節流效能計數器](../core/host-throttling-performance-counters.md)。  
  
 輸入節流會造成輸入訊息積存於來源中。 若輸入節流是套用至接收配接器，則接收配接器可能會停止接收訊息，直到移轉了節流狀況為止。  
  
|訊息發佈<br /><br /> 節流狀態|節流條件的觸發程序|採取的節流動作|移轉策略|效能物件|效能計數器|  
|---------------------------------------------|--------------------------------------|------------------------------|-------------------------|------------------------|-------------------------|  
|2|**訊息發佈內送速率**主控件執行個體超過**訊息發佈外寄速率\***指定**速率增加因數 （百分比）**值。 資料庫無法趕上發佈速率。|封鎖動態計算的時間週期之前，發佈執行緒**訊息發佈內送速率**相當於**訊息發佈外寄速率**\*指定的**速率增加因數 （百分比）**值。|使用效能計數器，來決定訊息發佈內送與訊息發佈外寄速率。 考慮適合您環境的增加因素。<br /><br /> 確認值提供給**取樣視窗持續期間**和**最小取樣數目**參數都是適用於您的案例。<br /><br /> 如需有關這些參數的詳細資訊，請參閱[如何修改速率型節流設定](../core/how-to-modify-rate-based-throttling-settings.md)。|BizTalk:MessageAgent|訊息發佈內送速率<br /><br /> 訊息發佈外寄速率|  
|4|程序記憶體超過指定的閾值。<br /><br /> 若要發佈的批次擁有遽增的記憶體需求或是太多執行緒正在處理訊息，就會發生此狀況|縮減 EPM 所使用的執行緒集區大小。<br /><br /> 封鎖 EPM 執行緒，以防止處理新訊息批次。<br /><br /> 若有遽增的記憶體需求使批次中的訊息持續存在於資料庫中，則在訊息持續存在於資料庫中之前，發佈執行緒也會受到漸進式延遲。<br /><br /> 由於程序記憶體壓力而是否要封鎖發佈批次，則取決於幾個因數，包括批次中的訊息數目，或是批次中是否有凍結或訊息刪除命令。|考慮藉由縮減 EPM 執行緒集區和 (或) 配接器批次的大小，來降低負載的數量。<br /><br /> 如果處理程序並未耗用過多的記憶體，請考慮增加**程序虛擬**主機的閾值。<br /><br /> 如需有關變更**程序虛擬**值，請參閱[如何修改資源基礎節流設定](../core/how-to-modify-resource-based-throttling-settings.md)。|BizTalk:MessageAgent|高程序記憶體<br /><br /> 程序記憶體使用量 (MB)<br /><br /> 程序記憶體使用量閾值 (MB)|  
|6|主控件訊息佇列大小、多工緩衝處理表格大小或追蹤表格大小超過指定的閾值。<br /><br /> 此狀況的可能原因包括：<br /><br /> -BizTalk Server 用來維持 BizTalk Server 資料庫未執行 SQL Agent 作業，或執行速度很慢。<br />-下游元件未及時處理來自於記憶體中佇列的訊息。<br />-擱置的訊息數目很高。<br />-已達到系統最大持續性負載。|縮減 EPM 所使用的執行緒集區大小。<br /><br /> 封鎖 EPM 執行緒，以防止處理新訊息批次。<br /><br /> 在訊息持續存在於資料庫之前，發佈執行緒也會受到漸進式延遲。|確定 BizTalk Server 用來維持 BizTalk Server 資料庫執行或不失敗的 SQL 代理程式工作。<br /><br /> 視需要終止和繼續已擱置的執行個體。<br /><br /> 增加的預設值為**訊息 DB 中的計數**儲存 BizTalk 資料庫的 SQL server 的空間需求納入考量的臨界值。<br /><br /> 如果您的資料庫大小適用於處理額外的訊息待處理項目，請考慮增加**多工緩衝處理乘數**和**追蹤資料乘數**值，以便讓其他待處理項目中的多工緩衝處理與追蹤資料表。<br /><br /> 如需變更這些值的詳細資訊，請參閱[如何修改資源基礎節流設定](../core/how-to-modify-resource-based-throttling-settings.md)。|BizTalk:MessageAgent<br /><br /> BizTalk:Message Box：一般計數器<br /><br /> BizTalk:Message Box：主控件計數器|MessageAgent /資料庫大小<br /><br /> Message Box：一般計數器/多緩衝處理大小<br /><br /> Message Box：一般計數器/追蹤資料大小<br /><br /> Message Box：主控件計數器/主控件佇列 – 長度<br /><br /> Message Box：主控件計數器/主控件佇列 - 已擱置的訊息 – 長度|  
|8|主控件執行個體所使用的資料庫工作階段超過指定的閾值。|縮減 EPM 所使用的執行緒集區大小。<br /><br /> 封鎖 EPM 執行緒，以防止處理新訊息批次。<br /><br /> 在訊息持續存在於資料庫之前，發佈執行緒也會受到漸進式延遲。|請考慮增加**資料庫連接**主機的閾值。<br /><br /> 如需有關如何變更此值的詳細資訊，請參閱[如何修改資源基礎節流設定](../core/how-to-modify-resource-based-throttling-settings.md)。|BizTalk:MessageAgent|資料庫工作階段|  
|9|處理程序執行緒計數超過指定的閾值。|縮減 EPM 所使用的執行緒集區大小。<br /><br /> 封鎖 EPM 執行緒，以防止處理新訊息批次。<br /><br /> 在訊息持續存在於資料庫之前，發佈執行緒也會受到漸進式延遲。|考慮調整不同的執行緒集區大小，以確定系統不會建立大量的執行緒。<br /><br /> 如需修改執行緒集區大小的詳細資訊，請參閱[如何修改一般設定](../core/how-to-modify-general-settings.md)和[如何修改資源基礎節流設定](../core/how-to-modify-resource-based-throttling-settings.md)。|BizTalk:MessageAgent|執行緒計數<br /><br /> 執行緒計數閾值|  
|5|系統記憶體超過指定的閾值。|縮減 EPM 所使用的執行緒集區大小。<br /><br /> 封鎖 EPM 執行緒，以防止處理新訊息批次。<br /><br /> 若有遽增的記憶體需求使批次中的訊息持續存在於資料庫中，則在訊息持續存在於資料庫中之前，發佈執行緒也會受到漸進式延遲。<br /><br /> 由於程序記憶體壓力而是否要封鎖發佈批次，則取決於幾個因數，包括批次中的訊息數目，或是批次中是否有凍結或訊息刪除命令。|考慮藉由縮減 EPM 執行緒集區和/或配接器批次大小，來降低負載。<br /><br /> 如果處理程序並未耗用過多的記憶體，請考慮增加**全域實體**主機的閾值。<br /><br /> 如需有關變更**全域實體**臨界值，請參閱[如何修改資源基礎節流設定](../core/how-to-modify-resource-based-throttling-settings.md)。|BizTalk:MessageAgent|實體記憶體使用量 (MB)<br /><br /> 實體記憶體使用量閾值 (MB)|  
  
### <a name="outbound-throttling"></a>輸出節流  
 BizTalk 節流機制會將輸出節流套用至協調流程引擎 (XLANG) 與輸出配接器。  
  
 使用**訊息傳遞節流狀態**和**訊息傳遞節流狀態持續時間**與相關聯的計數器**biztalk: Messageagent**效能物件類別目錄來計量目前的節流狀態與節流期間。 如需有關可用之主控件節流效能計數器查看[主控件節流效能計數器](../core/host-throttling-performance-counters.md)。  
  
 輸出節流會造成訊息延遲傳遞，而且訊息可能建立在記憶體中佇列內，並造成清除佇列執行緒遭到封鎖，直到移轉了節流狀況為止。 在清除佇列執行緒被封鎖時，不會從 MessageBox 將額外的訊息提取至記憶體中佇列內以進行輸出傳遞。  
  
|訊息傳遞<br /><br /> 節流狀態|節流條件的觸發程序|採取的節流動作|移轉策略|效能物件|效能計數器|  
|-------------------------------------------|--------------------------------------|------------------------------|-------------------------|------------------------|-------------------------|  
|1|**訊息傳遞內送速率**主控件執行個體超過**訊息傳遞外寄速率\***指定**速率增加因數 （百分比）**值<br /><br /> 可能的原因包括高處理複雜性、慢速輸出配接器，或暫時性系統資源不足。|封鎖傳遞執行緒，直到訊息傳遞內送速率相當於動態計算的時間週期**訊息傳遞外寄速率\***指定**速率加速因素 （%%）**值。|使用效能計數器，來決定訊息傳遞內送與訊息傳遞外寄速率。 考慮適合您環境的增加因素。<br /><br /> 確認值提供給**取樣視窗持續期間**和**最小取樣數目**參數都是適用於您的案例。<br /><br /> 如需有關這些參數的詳細資訊，請參閱[如何修改速率型節流設定](../core/how-to-modify-rate-based-throttling-settings.md)。|BizTalk:MessageAgent|訊息傳遞內送速率<br /><br /> 訊息發佈外寄速率|  
|4|程序記憶體超過指定的閾值。<br /><br /> 這可能發生於記憶體耗用處理實例中、處理大型訊息時，或是傳送配接器嘗試同時處理大量訊息時。|降低訊息傳遞至配接器或 XLANG 的速度。<br /><br /> 若適用，可藉由凍結服務執行個體與壓縮快取，來縮減處理程序記憶體消耗。<br /><br /> 縮減 EPM 和/或訊息代理程式所使用的執行緒集區大小。<br /><br /> 定期強制 .NET 記憶體回收 (GC)。|若系統並未因根據以程序記憶體為主的節流而成為閒置，則可能不需要其他動作。<br /><br /> 如果**內含式訊息計數**計數器很高，而且 CPU 使用率也不會過量即使沒有處理序記憶體為主的節流，可能需要採取任何其他動作。<br /><br /> 若系統出現過度節流，請考慮增加與相關聯的值**程序虛擬**主機的臨界值，並確認主控件執行個體不會產生 「 記憶體不足 」 錯誤。 如果藉由增加引發 「 記憶體不足 」 錯誤**程序虛擬**臨界值，請考慮縮減的值**內部訊息佇列大小**和**內含式訊息**臨界值。 此策略特別會與大型訊息處理實例有關。<br /><br /> 如需有關這些參數的詳細資訊，請參閱[如何修改資源基礎節流設定](../core/how-to-modify-resource-based-throttling-settings.md)。|BizTalk:MessageAgent|高程序記憶體<br /><br /> 程序記憶體 usage(MB)<br /><br /> 程序記憶體使用量閾值 (MB)<br /><br /> 內含式訊息計數<br /><br /> 作用中執行個體計數|  
|3|已傳遞之內含式訊息的數目超過指定的閾值。<br /><br /> 可能的原因包括高處理複雜性、慢速輸出配接器，或暫時性系統資源不足。|降低訊息傳遞至配接器或 XLANG 的速度。<br /><br /> 縮減訊息代理程式所使用的執行緒集區大小。|若發生過度節流，請考慮增加與相關聯的值**內含式訊息**臨界值。<br /><br /> 如需有關此參數的詳細資訊，請參閱[如何修改資源基礎節流設定](../core/how-to-modify-resource-based-throttling-settings.md)**附註：**增加此值可能會造成不良影響配接器效能和 （或) 增加記憶體處理程序的使用方式。|BizTalk:MessageAgent|內含式訊息計數<br /><br /> 內含式訊息計數閾值|  
|9|處理程序執行緒計數超過指定的閾值。|縮減 EPM 和 (或) 訊息代理程式所使用的執行緒集區大小。|考慮調整不同的執行緒集區大小，以確定系統不會建立大量的執行緒。<br /><br /> 如需修改執行緒集區大小的詳細資訊，請參閱[如何修改一般設定](../core/how-to-modify-general-settings.md)和[如何修改資源基礎節流設定](../core/how-to-modify-resource-based-throttling-settings.md)。|BizTalk:MessageAgent|執行緒計數<br /><br /> 執行緒計數閾值|  
|5|系統記憶體超過閾值。|降低訊息傳遞至配接器或 XLANG 的速度。<br /><br /> 若適用，可藉由凍結服務執行個體與壓縮快取，來縮減處理程序記憶體消耗。<br /><br /> 縮減 EPM 和/或訊息代理程式所使用的執行緒集區大小。|考慮藉由縮減 EPM 執行緒集區和/或配接器批次大小，來降低負載。<br /><br /> 如果處理程序並未耗用過多的記憶體，請考慮增加**全域實體**主機的閾值。<br /><br /> 如需有關變更**全域實體**臨界值，請參閱[如何修改資源基礎節流設定](../core/how-to-modify-resource-based-throttling-settings.md)。|BizTalk:MessageAgent|實體記憶體使用量 (MB)|