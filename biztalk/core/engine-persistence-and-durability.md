---
title: 引擎保存性與耐久性 |Microsoft 文件
ms.custom: ''
ms.date: 06/08/2017
ms.prod: biztalk-server
ms.reviewer: ''
ms.suite: ''
ms.tgt_pltfrm: ''
ms.topic: article
ms.assetid: 9bd209e9-75d2-422f-b3b2-377986f41f2f
caps.latest.revision: 7
author: MandiOhlinger
ms.author: mandia
manager: anneta
ms.openlocfilehash: 13f9f3f1a02ddfe84a963704476e867783f31042
ms.sourcegitcommit: cb908c540d8f1a692d01dc8f313e16cb4b4e696d
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 09/20/2017
ms.locfileid: "22242590"
---
# <a name="engine-persistence-and-durability"></a><span data-ttu-id="56b99-102">引擎保存性與耐久性</span><span class="sxs-lookup"><span data-stu-id="56b99-102">Engine Persistence and Durability</span></span>
<span data-ttu-id="56b99-103">本節說明 BizTalk Server 如何透過 SQL Server 將程序狀態存放至磁碟，可靠的整合鬆散耦合的商務程序。</span><span class="sxs-lookup"><span data-stu-id="56b99-103">This section explains how BizTalk Server reliably integrates loosely coupled business processes by persisting process state to disk via SQL Server.</span></span> <span data-ttu-id="56b99-104">藉由在適當的時間保存狀態、利用交易，系統能確保即使發生硬體或軟體故障，程序狀態也不會遺失。</span><span class="sxs-lookup"><span data-stu-id="56b99-104">By persisting state at appropriate times, leveraging transactions, the system guarantees that no process state is lost even in the event of a hardware or software outage.</span></span> <span data-ttu-id="56b99-105">這稱為系統耐久性。</span><span class="sxs-lookup"><span data-stu-id="56b99-105">This is referred to as system durability.</span></span>  
  
## <a name="loosely-coupled-business-process-management"></a><span data-ttu-id="56b99-106">鬆散耦合的商務程序管理</span><span class="sxs-lookup"><span data-stu-id="56b99-106">Loosely Coupled Business Process Management</span></span>  
 <span data-ttu-id="56b99-107">整合現有系統以執行單一邏輯商務程序需要對現有系統外部的程序狀態進行管理。</span><span class="sxs-lookup"><span data-stu-id="56b99-107">Integrating existing systems to perform a single logical business process requires management of process state outside of the existing systems.</span></span> <span data-ttu-id="56b99-108">不管商務程序是長期執行或是短期有效，程序狀態都必須個別維護，才能避免將系統緊密耦合在一起所導致的自訂通訊路徑劇增。</span><span class="sxs-lookup"><span data-stu-id="56b99-108">Whether the business process is long running or short lived, process state must be maintained independently in order to avoid the explosion of custom communications paths that result from tightly coupling systems together.</span></span>  
  
 <span data-ttu-id="56b99-109">很明顯地，若該商務程序相當重要，執行商務程序執行個體的狀態就必須非常可靠。</span><span class="sxs-lookup"><span data-stu-id="56b99-109">Clearly, the state of a running business process instance must be reliable if the business process is mission critical.</span></span> <span data-ttu-id="56b99-110">為確保商務程序是可靠且耐久的，BizTalk 利用 SQL Server 交易將程序狀態和商務資料保存至資料庫中的磁碟，稱為 MessageBox 資料庫。</span><span class="sxs-lookup"><span data-stu-id="56b99-110">To assure that business processes are reliable and durable, BizTalk leverages SQL Server transactions to persist process state and business data to disk in a database known as the MessageBox database.</span></span> <span data-ttu-id="56b99-111">如需 MessageBox 資料庫的詳細資訊，請參閱[MessageBox 資料庫](../core/the-messagebox-database.md)。</span><span class="sxs-lookup"><span data-stu-id="56b99-111">For more information about the MessageBox database, see [The MessageBox Database](../core/the-messagebox-database.md).</span></span>  
  
 <span data-ttu-id="56b99-112">在 [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)] 中，每則訊息以及除去最無關緊要的商務程序執行個體後的所有商務程序執行個體 (例如協調流程執行個體)，在處理期間都至少會保存在 MessageBox 資料庫中一次。</span><span class="sxs-lookup"><span data-stu-id="56b99-112">Every message and all but the most trivial business process instances (for example, orchestration instances) in [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)] are persisted in the MessageBox database at least once during processing.</span></span>  
  
## <a name="persistence-and-sustainability"></a><span data-ttu-id="56b99-113">保存性與持續性</span><span class="sxs-lookup"><span data-stu-id="56b99-113">Persistence and Sustainability</span></span>  
 <span data-ttu-id="56b99-114">BizTalk Server 保存所有訊息及大部分協調流程的事實已對持續性，如中所述的直接影響[何謂持續性效能？](../core/what-is-sustainable-performance.md)</span><span class="sxs-lookup"><span data-stu-id="56b99-114">The fact that BizTalk Server persists all messages and most orchestrations has a direct affect on sustainability as noted in [What Is Sustainable Performance?](../core/what-is-sustainable-performance.md)</span></span> <span data-ttu-id="56b99-115">當訊息送達 MessageBox 資料庫中時，它們是連接到等待訂閱者 （例如，協調流程和傳送連接埠），並排入佇列或發佈至 messagebox SQL 資料表，以等待收取和處理它們的 「 訂閱者 」。</span><span class="sxs-lookup"><span data-stu-id="56b99-115">As messages arrive in the MessageBox database, they are routed to waiting subscribers (for example, orchestrations and send ports) and en-queued, or published, into messagebox SQL tables to wait for subscribers to pick them up and process them.</span></span> <span data-ttu-id="56b99-116">某些抵達的訊息會啟動新的訂閱者執行個體。</span><span class="sxs-lookup"><span data-stu-id="56b99-116">Some of the arriving messages activate new subscriber instances.</span></span> <span data-ttu-id="56b99-117">其他訊息抵達並經由相互關聯路由至正在執行訂閱者 (如相互關聯協調流程) 的等候執行個體。</span><span class="sxs-lookup"><span data-stu-id="56b99-117">Other messages arrive and are routed, via correlation, to a waiting instance of an already running subscriber such as a correlated orchestration.</span></span>  
  
 <span data-ttu-id="56b99-118">為了讓相互關聯的協調流程得以繼續處理，必須將抵達的相互關聯訊息保持在未封鎖的狀態。</span><span class="sxs-lookup"><span data-stu-id="56b99-118">In order for correlated orchestrations to continue processing, arriving correlated messages must remain un-blocked.</span></span> <span data-ttu-id="56b99-119">為便於進行，BizTalk 即使在高負載狀況下也會盡可能地確保能夠繼續接收訊息 (啟動中和相互關聯)，讓等待相互關聯訊息的訂閱者可以完成程序，並騰出空間供更多程序執行。</span><span class="sxs-lookup"><span data-stu-id="56b99-119">To facilitate this, BizTalk does its best to make sure messages (both activating and correlated) continue to be received, even under high load, so that subscribers waiting for correlated messages can finish and make room for more processes to run.</span></span> <span data-ttu-id="56b99-120">這表示接收訊息的速度可能比處理訊息與從 MessageBox 資料庫移除訊息的速度要快，因此會建置訊息積存。</span><span class="sxs-lookup"><span data-stu-id="56b99-120">This means it is possible to receive messages faster than they can be processed and removed from the MessageBox database, thus building up a message backlog.</span></span> <span data-ttu-id="56b99-121">做為存放及轉寄的技術，BizTalk 提供此類的緩衝是理所當然的，不過，若接收速率一直都大於處理速率，就會導致一些問題，也就是導致大量積存。</span><span class="sxs-lookup"><span data-stu-id="56b99-121">Being a store-and-forward technology, it is natural for BizTalk to provide this type of buffering, however, it can result in problems if the receive rate is consistently faster than the process rate indefinitely, resulting in a large backlog.</span></span>  
  
 <span data-ttu-id="56b99-122">BizTalk Server 所接收或建立的每則訊息都是永遠不變的。</span><span class="sxs-lookup"><span data-stu-id="56b99-122">Every message that is received by, or created within, BizTalk Server is immutable.</span></span> <span data-ttu-id="56b99-123">也就是說，一旦接收或建立之後，其內容便無法變更。</span><span class="sxs-lookup"><span data-stu-id="56b99-123">That is, once it has been received or created, its content cannot be changed.</span></span> <span data-ttu-id="56b99-124">此外，所接收的訊息可能會有多個訂閱者。</span><span class="sxs-lookup"><span data-stu-id="56b99-124">In addition, received messages may have multiple subscribers.</span></span> <span data-ttu-id="56b99-125">特定訊息的每個訂閱者都會參考該訊息相同且單一的複本。</span><span class="sxs-lookup"><span data-stu-id="56b99-125">Each subscriber of a particular message references the same, single copy of that message.</span></span> <span data-ttu-id="56b99-126">當此方法將儲存空間最小化時，必須保留每則訊息的參考計數，而且必須定期維護，以避免參考計數為 0 的訊息。</span><span class="sxs-lookup"><span data-stu-id="56b99-126">While this approach minimizes storage, a ref-count must be kept for each message and maintenance must be performed periodically to get rid of those messages that have a ref count of 0.</span></span>  
  
 <span data-ttu-id="56b99-127">若在 MessageBox 資料庫中可建置夠大的積存，該資料庫的維護程序 (針對每個 MessageBox 資料庫以一組 SQL 工作的型式實作) 會落後，而且若沒有機會更新的話，最後會造成如磁碟空間不足的問題。</span><span class="sxs-lookup"><span data-stu-id="56b99-127">If a large enough backlog is allowed to build up in the MessageBox database, the maintenance processes for the database (implemented as a set of SQL Jobs for each MessageBox database) will fall behind and, if not given an opportunity to catch up, will eventually cause issues such as running out of disk space.</span></span> <span data-ttu-id="56b99-128">為避免這種情況，BizTalk Server 提供節流機制，可在 MessageBox 資料庫積存到達某些使用者設定的層級時，降低訊息接收速率。</span><span class="sxs-lookup"><span data-stu-id="56b99-128">To avoid this situation, BizTalk Server provides a throttling mechanism that slows down the message receive rate when the MessageBox database backlog gets to some user-configurable level.</span></span> <span data-ttu-id="56b99-129">如需節流的詳細資訊，請參閱[最佳化資源使用量透過主控件節流](../core/optimizing-resource-usage-through-host-throttling.md)。</span><span class="sxs-lookup"><span data-stu-id="56b99-129">For more information about throttling, see [Optimizing Resource Usage Through Host Throttling](../core/optimizing-resource-usage-through-host-throttling.md).</span></span>  
  
 <span data-ttu-id="56b99-130">假設所有的活動與程序都提供持續性，則某段時間的主要持續性量值就是不允許無限制成長的積存。</span><span class="sxs-lookup"><span data-stu-id="56b99-130">Given all of the activities and processes that contribute to sustainability, the primary measure of sustainability over time is that a backlog is not allowed to grow indefinitely.</span></span> <span data-ttu-id="56b99-131">換句話說，經過一段時間，在高低峰輸送量層級之間必須有一個平衡值，讓 MessageBox 資料庫能夠保持常數值與可管理的平均積存。</span><span class="sxs-lookup"><span data-stu-id="56b99-131">In other words, over time, there must be a balance between the high and low peak throughput levels so that the MessageBox database is able to maintain a constant and manageable average backlog.</span></span> <span data-ttu-id="56b99-132">積存的主要量值為多工緩衝處理表格的深度，以名稱如右的 [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)] 效能計數器公開：BizTalk:Message Box:General Counters:Spool Size。</span><span class="sxs-lookup"><span data-stu-id="56b99-132">The primary measure of backlog is the depth of the spool table, which is exposed as a [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)] performance counter called BizTalk:Message Box:General Counters:Spool Size.</span></span> <span data-ttu-id="56b99-133">如需有關此效能計數器的詳細資訊，請參閱[訊息方塊效能計數器](../core/message-box-performance-counters.md)。</span><span class="sxs-lookup"><span data-stu-id="56b99-133">For more information about this performance counter, see [Message Box Performance Counters](../core/message-box-performance-counters.md).</span></span>  
  
 <span data-ttu-id="56b99-134">如需有關如何使用多工緩衝處理大小和其他計數器來決定系統可持續之輸送量上限的詳細資訊，請參閱[測量最大持續引擎輸送量](../core/measuring-maximum-sustainable-engine-throughput.md)。</span><span class="sxs-lookup"><span data-stu-id="56b99-134">For more information on how to use the spool size and other counters to determine the maximum throughput a system can sustain, see [Measuring Maximum Sustainable Engine Throughput](../core/measuring-maximum-sustainable-engine-throughput.md).</span></span>  
  
## <a name="recommendations"></a><span data-ttu-id="56b99-135">建議</span><span class="sxs-lookup"><span data-stu-id="56b99-135">Recommendations</span></span>  
 [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)]<span data-ttu-id="56b99-136"> 會保存所有的訊息與大部分的協調流程，如果疏於理會，則訊息將會無限制的積存，而可能產生諸如磁碟空間不足之類的問題。</span><span class="sxs-lookup"><span data-stu-id="56b99-136"> persists all messages and most orchestrations and can, left un-checked, develop a backlog of messages that can result in issues such as running out of disk space.</span></span> <span data-ttu-id="56b99-137">積存的主要量值為 MessageBox 多工緩衝處理表格的深度，以名稱如右的效能計數器公開：BizTalk:Message Box:General Counters:Spool Size。</span><span class="sxs-lookup"><span data-stu-id="56b99-137">The primary measure of backlog is the depth of the messagebox spool table, which is exposed as a performance counter called: BizTalk:Message Box:General Counters:Spool Size.</span></span>  
  
 <span data-ttu-id="56b99-138">考慮可持續的輸送量時，多工緩衝處理大小必須維持穩定的平均值一段時間。</span><span class="sxs-lookup"><span data-stu-id="56b99-138">When thinking about sustainable throughput, the spool size must sustain a stable average over time.</span></span> <span data-ttu-id="56b99-139">也就是說，多工緩衝處理無法繼續無限制的成長。</span><span class="sxs-lookup"><span data-stu-id="56b99-139">That is, the spool cannot continue to grow un-checked indefinitely.</span></span> <span data-ttu-id="56b99-140">在[測量最大持續引擎輸送量](../core/measuring-maximum-sustainable-engine-throughput.md)更詳細討論此行為是，其會利用多工緩衝處理大小和其他效能提供一個方法來決定系統可持續的最大輸送量指標。</span><span class="sxs-lookup"><span data-stu-id="56b99-140">In [Measuring Maximum Sustainable Engine Throughput](../core/measuring-maximum-sustainable-engine-throughput.md), this behavior is discussed in more detail and a method of determining the maximum throughput a system can sustain is provided which leverages the spool size and other performance indicators.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="56b99-141">另請參閱</span><span class="sxs-lookup"><span data-stu-id="56b99-141">See Also</span></span>  
 <span data-ttu-id="56b99-142">[測量最大持續性引擎輸送量](../core/measuring-maximum-sustainable-engine-throughput.md) </span><span class="sxs-lookup"><span data-stu-id="56b99-142">[Measuring Maximum Sustainable Engine Throughput](../core/measuring-maximum-sustainable-engine-throughput.md) </span></span>  
 <span data-ttu-id="56b99-143">[什麼是持續性效能？](../core/what-is-sustainable-performance.md) </span><span class="sxs-lookup"><span data-stu-id="56b99-143">[What Is Sustainable Performance?](../core/what-is-sustainable-performance.md) </span></span>  
 <span data-ttu-id="56b99-144">[效能秘訣和訣竅](../core/performance-tips-and-tricks.md) </span><span class="sxs-lookup"><span data-stu-id="56b99-144">[Performance Tips and Tricks](../core/performance-tips-and-tricks.md) </span></span>  
 [<span data-ttu-id="56b99-145">訊息方塊效能計數器</span><span class="sxs-lookup"><span data-stu-id="56b99-145">Message Box Performance Counters</span></span>](../core/message-box-performance-counters.md)