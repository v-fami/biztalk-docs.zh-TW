---
title: 執行修復和重新提交自訂例外狀況處理常式範例 |Microsoft Docs
ms.custom: ''
ms.date: 06/08/2017
ms.prod: biztalk-server
ms.reviewer: ''
ms.suite: ''
ms.tgt_pltfrm: ''
ms.topic: article
ms.assetid: 7363c440-44aa-4d08-8290-72787d17ac60
caps.latest.revision: 2
author: MandiOhlinger
ms.author: mandia
manager: anneta
ms.openlocfilehash: 34bb03565f7b044f9c6c2f29332862ae8aafef7e
ms.sourcegitcommit: 266308ec5c6a9d8d80ff298ee6051b4843c5d626
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 06/27/2018
ms.locfileid: "37004479"
---
# <a name="running-the-repair-and-resubmit-custom-exception-handler-sample"></a><span data-ttu-id="9c294-102">執行修復和重新提交自訂例外狀況處理常式範例</span><span class="sxs-lookup"><span data-stu-id="9c294-102">Running the Repair and Resubmit Custom Exception Handler Sample</span></span>
<span data-ttu-id="9c294-103">「 修復和重新提交自訂例外狀況處理常式 」 範例示範非常有效的技術，將人為介入整合到 ESB 和 Microsoft BizTalk 型應用程式處理，並會實作實用的設計模式。</span><span class="sxs-lookup"><span data-stu-id="9c294-103">The Repair and Resubmit Custom Exception Handler sample demonstrates an extremely effective technique for integrating human intervention into ESB and Microsoft BizTalk–based application processes and implements a useful design pattern.</span></span> <span data-ttu-id="9c294-104">範例程式碼緊密整合到 ESB 例外狀況管理系統。</span><span class="sxs-lookup"><span data-stu-id="9c294-104">The sample code integrates seamlessly into the ESB exception management system.</span></span>  
  
 <span data-ttu-id="9c294-105">此範例會示範如何使用自訂的例外狀況處理常式，以及在協調流程中。</span><span class="sxs-lookup"><span data-stu-id="9c294-105">The sample shows how you can use a custom exception handler in an orchestration.</span></span> <span data-ttu-id="9c294-106">當協調流程 (EAIProcess.odx) 中的程序發生錯誤時，例外狀況處理常式就會產生，並發佈 ESB 錯誤訊息。</span><span class="sxs-lookup"><span data-stu-id="9c294-106">When a process in the orchestration (EAIProcess.odx) encounters an error, the exception handler generates and publishes an ESB fault message.</span></span> <span data-ttu-id="9c294-107">此錯誤訊息是 「 在途中 」 訊息 （包括其相關的 BizTalk 內容屬性） 包含其承載中發生例外狀況和 BizTalk 協調流程引擎攔截到目前的 System.Exception 執行個體。</span><span class="sxs-lookup"><span data-stu-id="9c294-107">This fault message includes in its payload the messages (including their BizTalk-related context properties) that were "in flight" when the exception occurred and the current System.Exception instance caught by the BizTalk Orchestration engine.</span></span> <span data-ttu-id="9c294-108">當發生這種情況時，「 拒絕 」 的訊息和 「 Approved 」 訊息會保存並顯示錯誤訊息。</span><span class="sxs-lookup"><span data-stu-id="9c294-108">When this occurs, a "Denied" message and an "Approved" message are persisted with the fault message.</span></span>  
  
 <span data-ttu-id="9c294-109">名為 EAIProcessHandler.odx 部署低耦合的方式，且可做為自訂的例外狀況處理常式，第二個協調流程訂閱產生 EAIProcess.odx 協調流程中的特定錯誤程式碼，並使用錯誤訊息。</span><span class="sxs-lookup"><span data-stu-id="9c294-109">A second orchestration named EAIProcessHandler.odx, which is deployed in a decoupled manner and acts as a custom exception handler, subscribes to the specific fault code generated in the EAIProcess.odx orchestration and consumes the fault message.</span></span> <span data-ttu-id="9c294-110">這個例外狀況處理常式會擷取原始的訊息 （做為具類型的文件） 和錯誤訊息中原本保存 System.Exception 執行個體。</span><span class="sxs-lookup"><span data-stu-id="9c294-110">This exception handler extracts the original messages (as typed documents) and the System.Exception instances originally persisted in the fault message.</span></span>  
  
 <span data-ttu-id="9c294-111">原始訊息現在會變成可供處理，其原始的內容屬性的項目。</span><span class="sxs-lookup"><span data-stu-id="9c294-111">The original messages now become available for processing with all their original context properties.</span></span> <span data-ttu-id="9c294-112">自訂例外狀況處理常式 (EAIProcessHandler.odx) 然後會將 「 拒絕 」 和 「 Approved 」 訊息寫入至檔案系統中的下列位置：</span><span class="sxs-lookup"><span data-stu-id="9c294-112">The custom exception handler (EAIProcessHandler.odx) then writes both the "Denied" and the "Approved" messages to the file system in the following locations:</span></span>  
  
- <span data-ttu-id="9c294-113">已核准的訊息：</span><span class="sxs-lookup"><span data-stu-id="9c294-113">Approved message:</span></span>  
  
  -   <span data-ttu-id="9c294-114">\Source\Samples\Exception Handling\Test\Filedrop\EAIProcess.PostApproval</span><span class="sxs-lookup"><span data-stu-id="9c294-114">\Source\Samples\Exception Handling\Test\Filedrop\EAIProcess.PostApproval</span></span>  
  
- <span data-ttu-id="9c294-115">拒絕的訊息修復和重新提交：</span><span class="sxs-lookup"><span data-stu-id="9c294-115">Denied message for repair and resubmit:</span></span>  
  
  -   <span data-ttu-id="9c294-116">\Source\Samples\Exception Handling\Test\Filedrop\EAIProcessHandler.RepairSubmit</span><span class="sxs-lookup"><span data-stu-id="9c294-116">\Source\Samples\Exception Handling\Test\Filedrop\EAIProcessHandler.RepairSubmit</span></span>  
  
- <span data-ttu-id="9c294-117">拒絕的訊息：</span><span class="sxs-lookup"><span data-stu-id="9c294-117">Denied message:</span></span>  
  
  -   <span data-ttu-id="9c294-118">\Source\Samples\Exception Handling\Test\Filedrop\EAIProcessHandler.PostDecline</span><span class="sxs-lookup"><span data-stu-id="9c294-118">\Source\Samples\Exception Handling\Test\Filedrop\EAIProcessHandler.PostDecline</span></span>  
  
  <span data-ttu-id="9c294-119">例外狀況處理常式會將"Denied"訊息修復和重新提交序列化至檔案系統使用的 Microsoft InfoPath 處理指示。</span><span class="sxs-lookup"><span data-stu-id="9c294-119">The exception handler serializes the "Denied" message for Repair and Resubmit to the file system using a Microsoft InfoPath processing instruction.</span></span> <span data-ttu-id="9c294-120">InfoPath 範本可讓使用者編輯表單，並重新提交結果 （請參閱 圖 1），這會開始驗證訊息 EAIProcess.odx 協調流程。</span><span class="sxs-lookup"><span data-stu-id="9c294-120">An InfoPath template allows the user to edit the form and resubmit the result (see Figure 1), which starts the EAIProcess.odx orchestration that validates the message.</span></span>  
  
  <span data-ttu-id="9c294-121">![修復重新提交](../esb-toolkit/media/ch6-repairresubmit.gif "第 6 章第 RepairResubmit")</span><span class="sxs-lookup"><span data-stu-id="9c294-121">![Repair Resubmit](../esb-toolkit/media/ch6-repairresubmit.gif "Ch6-RepairResubmit")</span></span>  
  
  <span data-ttu-id="9c294-122">**圖 1**</span><span class="sxs-lookup"><span data-stu-id="9c294-122">**Figure 1**</span></span>  
  
  <span data-ttu-id="9c294-123">**InfoPath 修復和重新提交範本所產生的測試訊息**</span><span class="sxs-lookup"><span data-stu-id="9c294-123">**A test message generated by the InfoPath Repair and Resubmit template**</span></span>  
  
  <span data-ttu-id="9c294-124">此外，還有名為所有的泛型的傳送埠。已設定為使用 GlobalFaultProcessor 管線的 Exceptions_FILE。</span><span class="sxs-lookup"><span data-stu-id="9c294-124">Additionally, there is a generic send port named ALL.Exceptions_FILE that is configured to use the GlobalFaultProcessor pipeline.</span></span> <span data-ttu-id="9c294-125">此連接埠訂閱系統中的所有例外狀況，這兩個 BizTalk 失敗訊息路由遞送的訊息與 ESB 錯誤訊息。</span><span class="sxs-lookup"><span data-stu-id="9c294-125">This port subscribes to all exceptions in the system, both BizTalk failed message routing messages and ESB fault messages.</span></span> <span data-ttu-id="9c294-126">例外狀況管理架構將它們正規化所有成單一的格式和序列化使用資料夾 \Source\Samples\Exception Handling\Test\Filedrop\All_Exceptions InfoPath 處理指示。</span><span class="sxs-lookup"><span data-stu-id="9c294-126">The Exception Management Framework normalizes them all to a single format and serializes them using an InfoPath processing instruction to the folder \Source\Samples\Exception Handling\Test\Filedrop\All_Exceptions.</span></span>  
  
## <a name="installation"></a><span data-ttu-id="9c294-127">安裝</span><span class="sxs-lookup"><span data-stu-id="9c294-127">Installation</span></span>  
 <span data-ttu-id="9c294-128">所有例外狀況管理範例會使用相同的一組核心服務和 BizTalk 應用程式成品。</span><span class="sxs-lookup"><span data-stu-id="9c294-128">All the exception management samples use the same set of core services and BizTalk application artifacts.</span></span> <span data-ttu-id="9c294-129">因此，您必須要能夠執行所有的例外狀況管理範例安裝例外狀況管理範例成品只有一次。</span><span class="sxs-lookup"><span data-stu-id="9c294-129">Therefore, you have to install the exception management sample artifacts only once to be able to run all the exception management samples.</span></span> <span data-ttu-id="9c294-130">如需有關如何安裝例外狀況管理範例的資訊，請參閱 <<c0> [ 安裝例外狀況管理範例](../esb-toolkit/installing-the-exception-management-samples.md)。</span><span class="sxs-lookup"><span data-stu-id="9c294-130">For information about how to install the exception management samples, see [Installing the Exception Management Samples](../esb-toolkit/installing-the-exception-management-samples.md).</span></span>  
  
## <a name="running-the-sample-application"></a><span data-ttu-id="9c294-131">執行範例應用程式</span><span class="sxs-lookup"><span data-stu-id="9c294-131">Running the Sample Application</span></span>  
 <span data-ttu-id="9c294-132">**若要執行修復和重新提交自訂例外狀況處理常式範例**</span><span class="sxs-lookup"><span data-stu-id="9c294-132">**To run the Repair and Resubmit Custom Exception Handler sample**</span></span>  
  
1.  <span data-ttu-id="9c294-133">第一次執行此範例之前，請確定接收位置和傳送埠 Url 指向 \Source\Samples\Exception Handling\Test\Filedrop 資料夾中的適當目錄。</span><span class="sxs-lookup"><span data-stu-id="9c294-133">Before you run this sample for the first time, make sure that the receive location and send port URLs point to the appropriate directories in the \Source\Samples\Exception Handling\Test\Filedrop folder.</span></span> <span data-ttu-id="9c294-134">接收位置應該指定資料夾 EAIProcess.RequestPort，並傳送連接埠 Url 應該指定 EAIProcess.PostApproval 和 EAIProcessHandler.PostDecline 的資料夾。</span><span class="sxs-lookup"><span data-stu-id="9c294-134">The receive location should specify the folder EAIProcess.RequestPort, and the send port URLs should specify the folders EAIProcess.PostApproval and EAIProcessHandler.PostDecline.</span></span>  
  
2.  <span data-ttu-id="9c294-135">如果尚未執行 GlobalBank.ESB 應用程式，使用 BizTalk 管理主控台來啟動它。</span><span class="sxs-lookup"><span data-stu-id="9c294-135">If the GlobalBank.ESB application is not already running, use the BizTalk Administration Console to start it.</span></span>  
  
3.  <span data-ttu-id="9c294-136">藉由複製名為 Request_EAIProcessHandler.xml，\Source\Samples\Exception Handling\Test\Data 資料夾中，指定 EAIProcess.RequestPort_FILE 接收位置的資料夾中的範例檔案，啟動範例： \Source\Samples\例外狀況 Handling\Test\Filedrop\EAIProcess.RequestPort。</span><span class="sxs-lookup"><span data-stu-id="9c294-136">Start the sample by copying the sample file named Request_EAIProcessHandler.xml, located in the \Source\Samples\Exception Handling\Test\Data folder, to the folder specified for the EAIProcess.RequestPort_FILE receive location: \Source\Samples\Exception Handling\Test\Filedrop\EAIProcess.RequestPort.</span></span>  
  
4.  <span data-ttu-id="9c294-137">開啟名為 EAIProcessHandler.PostDecline （\Source\Samples\Exception Handling\Test\Filedrop 資料夾中） 的資料夾。</span><span class="sxs-lookup"><span data-stu-id="9c294-137">Open the folder named EAIProcessHandler.PostDecline (in the \Source\Samples\Exception Handling\Test\Filedrop folder).</span></span> <span data-ttu-id="9c294-138">您會看到 「 已拒絕 \* 」 訊息的例外狀況處理協調流程所產生。</span><span class="sxs-lookup"><span data-stu-id="9c294-138">You will see the "Declined\*" message generated by the exception handling orchestration.</span></span>  
  
5.  <span data-ttu-id="9c294-139">開啟名為 EAIProcessHandler.RepairSubmit （\Source\Samples\Exception Handling\Test\Filedrop 資料夾中） 的資料夾。</span><span class="sxs-lookup"><span data-stu-id="9c294-139">Open the folder named EAIProcessHandler.RepairSubmit (in the \Source\Samples\Exception Handling\Test\Filedrop folder).</span></span> <span data-ttu-id="9c294-140">您會看到 「 RepairSubmit 」 訊息的例外狀況處理協調流程所產生。</span><span class="sxs-lookup"><span data-stu-id="9c294-140">You will see a "RepairSubmit" message generated by the exception handling orchestration.</span></span>  
  
6.  <span data-ttu-id="9c294-141">按兩下 RepairSubmit 檔案，在適當的 InfoPath 範本中加以開啟。</span><span class="sxs-lookup"><span data-stu-id="9c294-141">Double-click the RepairSubmit file to open it in the appropriate InfoPath template.</span></span> <span data-ttu-id="9c294-142">您會看到 準備好進行編輯並重新提交訊息。</span><span class="sxs-lookup"><span data-stu-id="9c294-142">You will see the message ready for edit and resubmission.</span></span>  
  
7.  <span data-ttu-id="9c294-143">值變更**單價**欄位從**0**來**2**，然後按一下**提交**按鈕位於工具列上的 InfoPath若要提交回 BizTalk 處理編輯的文件的表單。</span><span class="sxs-lookup"><span data-stu-id="9c294-143">Change the value of the **Unit Price** field from **0** to **2**, and then click the **Submit** button located on the toolbar of the InfoPath form to submit the edited document back to BizTalk for processing.</span></span> <span data-ttu-id="9c294-144">提交程序使用的設定 BizTalk HTTP 接收位置。</span><span class="sxs-lookup"><span data-stu-id="9c294-144">The submit process uses a BizTalk-configured HTTP receive location.</span></span>  
  
8.  <span data-ttu-id="9c294-145">瀏覽至 EAIProcess.PostApproval 資料夾中 （在 [\Source\Samples\Exception Handling\Test\Filedrop] 資料夾中）。</span><span class="sxs-lookup"><span data-stu-id="9c294-145">Navigate to the EAIProcess.PostApproval folder (in the \Source\Samples\Exception Handling\Test\Filedrop folder).</span></span> <span data-ttu-id="9c294-146">現在，您會看到包含單價的更新的值的 「 核准 \* 」 文件。</span><span class="sxs-lookup"><span data-stu-id="9c294-146">You will now see the "Approval\*" document containing the updated value for the unit price.</span></span>  
  
## <a name="how-the-sample-works"></a><span data-ttu-id="9c294-147">此範例的運作方式</span><span class="sxs-lookup"><span data-stu-id="9c294-147">How the Sample Works</span></span>  
 <span data-ttu-id="9c294-148">您所提交的訊息啟動 EAIProcess 協調流程。</span><span class="sxs-lookup"><span data-stu-id="9c294-148">The message you submit activates the EAIProcess orchestration.</span></span> <span data-ttu-id="9c294-149">EAIProcess 協調流程處理訊息時，它會嘗試將 1 除以單價。</span><span class="sxs-lookup"><span data-stu-id="9c294-149">When the EAIProcess orchestration processes the message, it attempts to divide 1 by the unit price.</span></span> <span data-ttu-id="9c294-150">因為單位價格為零，就會發生除以零例外狀況。</span><span class="sxs-lookup"><span data-stu-id="9c294-150">Because the unit price is zero, a divide-by-zero exception occurs.</span></span> <span data-ttu-id="9c294-151">協調流程的事件處理常式中的程式碼會攔截此例外狀況，並建立錯誤訊息。</span><span class="sxs-lookup"><span data-stu-id="9c294-151">Code in the event handler of the orchestration catches this exception and creates a fault message.</span></span> <span data-ttu-id="9c294-152">訊息中的訂單數量大於 10，因此商務邏輯決定此例外狀況已**d**欄位的值**1000年**。</span><span class="sxs-lookup"><span data-stu-id="9c294-152">The order quantity in the message is greater than 10, so the business logic dictates that this exception has a **FaultCode** field value of **1000**.</span></span>  
  
 <span data-ttu-id="9c294-153">EAIProcess 協調流程接著會將錯誤訊息發佈到 BizTalk Message Box，透過直接繫結連接埠和協調流程結束。</span><span class="sxs-lookup"><span data-stu-id="9c294-153">The EAIProcess orchestration then publishes the fault message to the BizTalk Message Box through a direct-bound port, and the orchestration ends.</span></span>  
  
 <span data-ttu-id="9c294-154">自訂錯誤處理常式的協調流程，名為 EAIProcessHandler，其訂閱的訊息**d**欄位的值**1000年**，挑選新的錯誤訊息。</span><span class="sxs-lookup"><span data-stu-id="9c294-154">A custom fault handler orchestration named EAIProcessHandler, which subscribes to messages with a **FaultCode** field value of **1000**, picks up the new fault message.</span></span> <span data-ttu-id="9c294-155">協調流程中的程式碼會建立 「 拒絕 」 訊息和 InfoPath 檔案，而且再放這到 EAIProcessHandler.PostDecline 和 EAIProcessHandler.RepairSubmit 資料夾供人為介入。</span><span class="sxs-lookup"><span data-stu-id="9c294-155">The code in the orchestration creates the "Denied" message and the InfoPath file, and then it places this into the EAIProcessHandler.PostDecline and EAIProcessHandler.RepairSubmit folders ready for human intervention.</span></span>