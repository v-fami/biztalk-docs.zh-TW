---
title: "執行保存自訂例外狀況處理常式範例訊息 |Microsoft 文件"
ms.custom: 
ms.date: 06/08/2017
ms.prod: biztalk-server
ms.reviewer: 
ms.suite: 
ms.tgt_pltfrm: 
ms.topic: article
ms.assetid: a0a4c819-f6bd-4dea-8be9-e3006337665f
caps.latest.revision: "2"
author: MandiOhlinger
ms.author: mandia
manager: anneta
ms.openlocfilehash: f6d7927357e4c2be03ecd8b2e77d45558b5bc692
ms.sourcegitcommit: cb908c540d8f1a692d01dc8f313e16cb4b4e696d
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 09/20/2017
---
# <a name="running-the-message-persisting-custom-exception-handler-sample"></a><span data-ttu-id="4b37b-102">執行保存自訂例外狀況處理常式範例訊息</span><span class="sxs-lookup"><span data-stu-id="4b37b-102">Running the Message Persisting Custom Exception Handler Sample</span></span>
<span data-ttu-id="4b37b-103">訊息保存自訂例外狀況處理常式範例示範鬆散偶合的一般處理常式會收到錯誤訊息時，會擷取包含此項目，並將其以磁碟檔案寫入至檔案系統的 Microsoft BizTalk 訊息。</span><span class="sxs-lookup"><span data-stu-id="4b37b-103">The Message Persisting Custom Exception Handler sample demonstrates a loosely coupled, generic handler that receives fault messages, extracts the Microsoft BizTalk messages they contain, and writes them as disk files to the file system.</span></span>  
  
 <span data-ttu-id="4b37b-104">此範例顯示如何在協調流程中使用的自訂例外狀況處理常式。</span><span class="sxs-lookup"><span data-stu-id="4b37b-104">The sample shows how you can use a custom exception handler in an orchestration.</span></span> <span data-ttu-id="4b37b-105">當處理程序協調流程 (EAIProcess.odx) 中的發生錯誤時，會產生例外狀況處理常式，並發佈 ESB 錯誤訊息。</span><span class="sxs-lookup"><span data-stu-id="4b37b-105">When a process in the orchestration (EAIProcess.odx) encounters an error, the exception handler generates and publishes an ESB fault message.</span></span> <span data-ttu-id="4b37b-106">此錯誤訊息納入其裝載了 「 在途中 」 訊息 （包括其 BizTalk 相關的內容屬性） 發生例外狀況，以及 BizTalk 協調流程引擎捕捉到的目前 System.Exception 執行個體。</span><span class="sxs-lookup"><span data-stu-id="4b37b-106">This fault message includes in its payload the messages (including their BizTalk-related context properties) that were "in flight" when the exception occurred, as well as the current System.Exception instance caught by the BizTalk Orchestration engine.</span></span> <span data-ttu-id="4b37b-107">當發生這種情況時，會保存 「 拒絕 」 的訊息和 「 已核准 」 訊息與錯誤訊息。</span><span class="sxs-lookup"><span data-stu-id="4b37b-107">When this occurs, a "Denied" message and an "Approved" message are persisted with the fault message.</span></span>  
  
 <span data-ttu-id="4b37b-108">名為 EAIGenericHandler.odx 解除解合的方式部署並做為自訂例外狀況處理常式，在第二個協調流程訂閱產生 EAIGenericHandler.odx 協調流程中的特定錯誤程式碼，並使用錯誤訊息。</span><span class="sxs-lookup"><span data-stu-id="4b37b-108">A second orchestration named EAIGenericHandler.odx, which is deployed in a decoupled manner and acts as a custom exception handler, subscribes to the specific fault code generated in the EAIGenericHandler.odx orchestration and consumes the fault message.</span></span> <span data-ttu-id="4b37b-109">這個例外狀況處理常式中擷取原始的訊息 （做為無類型的文件） 並將 System.Exception 執行個體原本保存在錯誤訊息。</span><span class="sxs-lookup"><span data-stu-id="4b37b-109">This exception handler extracts the original messages (as type-less documents) and the System.Exception instances originally persisted in the fault message.</span></span>  
  
 <span data-ttu-id="4b37b-110">訊息保存自訂例外狀況處理常式範例與修復，再重新送出的自訂例外狀況處理常式範例的這個範例中使用 EAIGenericHandler.odx 協調流程沒有錯誤發行中使用的結構描述的相依性協調流程程序 (EAIProcess.odx)。</span><span class="sxs-lookup"><span data-stu-id="4b37b-110">The Message Persisting Custom Exception Handler sample differs from the Repair and Resubmit Custom Exception Handler sample in that the EAIGenericHandler.odx orchestration used in this sample does not have a dependency on the schemas used in the fault publishing orchestration process (EAIProcess.odx).</span></span> <span data-ttu-id="4b37b-111">具體來說，EAIGenericHandler.odx 協調流程擷取的原始訊息的錯誤訊息當做 System.Xml.XmlDocument 執行個體，而不是根據 EAIProcess.odx 協調流程中使用的結構描述具類型的訊息。</span><span class="sxs-lookup"><span data-stu-id="4b37b-111">Specifically, the EAIGenericHandler.odx orchestration retrieves the original messages from the fault message as System.Xml.XmlDocument instances instead of typed messages based on the schemas used in the EAIProcess.odx orchestration.</span></span> <span data-ttu-id="4b37b-112">它也會傳回訊息做為程式碼輕鬆地可列舉集合。</span><span class="sxs-lookup"><span data-stu-id="4b37b-112">It also returns the messages as a collection that code can easily enumerate.</span></span>  
  
 <span data-ttu-id="4b37b-113">自訂例外狀況處理常式 (EAIGenericHandler.odx) 然後將 「 已拒絕 」 和 「 已核准 」 訊息寫入檔案系統位置 \Source\Samples\Exception Handling\Test\Filedrop\EAIGenericHandler.PostTmpMsg。</span><span class="sxs-lookup"><span data-stu-id="4b37b-113">The custom exception handler (EAIGenericHandler.odx) then writes both the "Denied" and the "Approved" messages to the file system location \Source\Samples\Exception Handling\Test\Filedrop\EAIGenericHandler.PostTmpMsg.</span></span>  
  
 <span data-ttu-id="4b37b-114">此外，是泛型的傳送埠命名為全部。Exceptions_FILE 設定為使用隨 GlobalFaultProcessor 管線[!INCLUDE[esbToolkit](../includes/esbtoolkit-md.md)]例外狀況管理架構。</span><span class="sxs-lookup"><span data-stu-id="4b37b-114">Additionally, there is a generic send port named ALL.Exceptions_FILE configured to use the GlobalFaultProcessor pipeline installed as part of the [!INCLUDE[esbToolkit](../includes/esbtoolkit-md.md)] Exception Management Framework.</span></span> <span data-ttu-id="4b37b-115">此連接埠訂閱系統中的所有例外狀況，這兩個 BizTalk 失敗訊息路由遞送的訊息與 ESB 錯誤訊息。</span><span class="sxs-lookup"><span data-stu-id="4b37b-115">This port subscribes to all exceptions in the system, both BizTalk failed message routing messages and ESB fault messages.</span></span> <span data-ttu-id="4b37b-116">例外狀況管理架構正規化它們全部加入一種格式，並將它們使用位置 \Source\Samples\Exception Handling\Test\Filedrop\All_Exceptions Microsoft InfoPath 處理指示序列化。</span><span class="sxs-lookup"><span data-stu-id="4b37b-116">The Exception Management Framework normalizes them all to a single format and serializes them using a Microsoft InfoPath processing instruction to the location \Source\Samples\Exception Handling\Test\Filedrop\All_Exceptions.</span></span>  
  
## <a name="installation"></a><span data-ttu-id="4b37b-117">安裝</span><span class="sxs-lookup"><span data-stu-id="4b37b-117">Installation</span></span>  
 <span data-ttu-id="4b37b-118">所有例外狀況管理範例使用相同的核心服務和 BizTalk 應用程式成品。</span><span class="sxs-lookup"><span data-stu-id="4b37b-118">All the exception management samples use the same set of core services and BizTalk application artifacts.</span></span> <span data-ttu-id="4b37b-119">因此，您必須安裝要能夠管理範例執行的所有例外狀況的例外狀況管理範例成品一次。</span><span class="sxs-lookup"><span data-stu-id="4b37b-119">Therefore, you have to install the exception management sample artifacts only once to be able to run all the exception management samples.</span></span> <span data-ttu-id="4b37b-120">如需如何安裝例外狀況管理範例，請參閱[安裝例外狀況管理範例](../esb-toolkit/installing-the-exception-management-samples.md)。</span><span class="sxs-lookup"><span data-stu-id="4b37b-120">For information about how to install the exception management samples, see [Installing the Exception Management Samples](../esb-toolkit/installing-the-exception-management-samples.md).</span></span>  
  
## <a name="running-the-sample-application"></a><span data-ttu-id="4b37b-121">執行範例應用程式</span><span class="sxs-lookup"><span data-stu-id="4b37b-121">Running the Sample Application</span></span>  
 <span data-ttu-id="4b37b-122">**若要執行訊息保存自訂例外狀況處理常式範例**</span><span class="sxs-lookup"><span data-stu-id="4b37b-122">**To run the Message Persisting Custom Exception Handler sample**</span></span>  
  
1.  <span data-ttu-id="4b37b-123">您第一次執行此範例之前，請確定該接收位置和傳送連接埠 URL 指向 \Source\Samples\Exception Handling\Test\Filedrop 資料夾中的適當目錄。</span><span class="sxs-lookup"><span data-stu-id="4b37b-123">Before you run this sample for the first time, make sure that the receive location and send port URL point to the appropriate directories in the \Source\Samples\Exception Handling\Test\Filedrop folder.</span></span> <span data-ttu-id="4b37b-124">接收位置應該指定資料夾 EAIProcess.RequestPort，而傳送連接埠 URL 應該指定 EAIGenericHandler.PostTmpMsg 的資料夾。</span><span class="sxs-lookup"><span data-stu-id="4b37b-124">The receive location should specify the folder EAIProcess.RequestPort, and the send port URL should specify the folder EAIGenericHandler.PostTmpMsg.</span></span>  
  
2.  <span data-ttu-id="4b37b-125">如果尚未執行 GlobalBank.ESB 應用程式，使用 BizTalk 管理主控台來啟動它。</span><span class="sxs-lookup"><span data-stu-id="4b37b-125">If the GlobalBank.ESB application is not already running, use the BizTalk Administration Console to start it.</span></span>  
  
3.  <span data-ttu-id="4b37b-126">藉由複製名為 Request_EAIGenericHandler.xml，\Source\Samples\Exception Handling\Test\Data 資料夾，以指定 EAIProcess.RequestPort_FILE 接收位置的資料夾中的範例檔案啟動範例： \Source\Samples\例外狀況 Handling\Test\Filedrop\EAIProcess.RequestPort。</span><span class="sxs-lookup"><span data-stu-id="4b37b-126">Start the sample by copying the sample file named Request_EAIGenericHandler.xml, located in the \Source\Samples\Exception Handling\Test\Data folder, to the folder specified for the EAIProcess.RequestPort_FILE receive location: \Source\Samples\Exception Handling\Test\Filedrop\EAIProcess.RequestPort.</span></span>  
  
4.  <span data-ttu-id="4b37b-127">開啟名為 EAIGenericHandler.PostTmpMsg （\Source\Samples\Exception Handling\Test\Filedrop\ 資料夾中） 的資料夾。</span><span class="sxs-lookup"><span data-stu-id="4b37b-127">Open the folder named EAIGenericHandler.PostTmpMsg (in the \Source\Samples\Exception Handling\Test\Filedrop\ folder).</span></span> <span data-ttu-id="4b37b-128">您會看到原始的訊息。</span><span class="sxs-lookup"><span data-stu-id="4b37b-128">You will see the original message.</span></span>  
  
## <a name="how-the-sample-works"></a><span data-ttu-id="4b37b-129">範例的運作方式</span><span class="sxs-lookup"><span data-stu-id="4b37b-129">How the Sample Works</span></span>  
 <span data-ttu-id="4b37b-130">您所提交的訊息啟動 EAIProcess 協調流程。</span><span class="sxs-lookup"><span data-stu-id="4b37b-130">The message you submit activates the EAIProcess orchestration.</span></span> <span data-ttu-id="4b37b-131">EAIProcess 協調流程處理訊息時，它會嘗試將 1 除以單價。</span><span class="sxs-lookup"><span data-stu-id="4b37b-131">When the EAIProcess orchestration processes the message, it attempts to divide 1 by the unit price.</span></span> <span data-ttu-id="4b37b-132">因為單價為零，就會發生除以零的例外狀況。</span><span class="sxs-lookup"><span data-stu-id="4b37b-132">Because the unit price is zero, a divide-by-zero exception occurs.</span></span> <span data-ttu-id="4b37b-133">協調流程的事件處理常式中的程式碼會攔截此例外狀況，並建立錯誤訊息。</span><span class="sxs-lookup"><span data-stu-id="4b37b-133">Code in the event handler of the orchestration catches this exception and creates a fault message.</span></span> <span data-ttu-id="4b37b-134">訊息中的訂單數量已低於 10，商務邏輯決定，此例外狀況，並讓**f**欄位的值**2000年**。</span><span class="sxs-lookup"><span data-stu-id="4b37b-134">The order quantity in the message is less than 10, so the business logic dictates that this exception has a **FaultCode** field value of **2000**.</span></span>  
  
 <span data-ttu-id="4b37b-135">EAIProcess 協調流程接著會將錯誤訊息發佈到 BizTalk Messagebox 直接繫結連接埠和協調流程會結束。</span><span class="sxs-lookup"><span data-stu-id="4b37b-135">The EAIProcess orchestration then publishes the fault message to the BizTalk Message Box through a direct-bound port, and the orchestration ends.</span></span>  
  
 <span data-ttu-id="4b37b-136">自訂錯誤處理常式的協調流程，名為 EAIGenericHandler，訂閱訊息與**f**欄位的值**2000年**，挑選新的錯誤訊息。</span><span class="sxs-lookup"><span data-stu-id="4b37b-136">A custom fault handler orchestration named EAIGenericHandler, which subscribes to messages with a **FaultCode** field value of **2000**, picks up the new fault message.</span></span> <span data-ttu-id="4b37b-137">協調流程中的程式碼會從例外狀況 （錯誤） 訊息中擷取的所有訊息，並將它們寫入磁碟檔案。</span><span class="sxs-lookup"><span data-stu-id="4b37b-137">The code in the orchestration extracts all the messages from the exception (fault) message and writes them to disk files.</span></span>